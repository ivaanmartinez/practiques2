<!DOCTYPE html>
 <html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gestión Industrial Integrado</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        corePlugins: {
            preflight: false,
        },
        darkMode: 'class',
        theme: {
            extend: {
                animation: {
                    'fade-in': 'fadeIn 0.5s ease-in-out',
                    'slide-up': 'slideUp 0.3s ease-out',
                    'bounce-in': 'bounceIn 0.6s ease-out'
                },
                keyframes: {
                    fadeIn: {
                        '0%': { opacity: '0', transform: 'translateY(10px)' },
                        '100%': { opacity: '1', transform: 'translateY(0)' }
                    },
                    slideUp: {
                        '0%': { transform: 'translateY(100%)' },
                        '100%': { transform: 'translateY(0)' }
                    },
                    bounceIn: {
                        '0%': { transform: 'scale(0.3)', opacity: '0' },
                        '50%': { transform: 'scale(1.05)' },
                        '70%': { transform: 'scale(0.9)' },
                        '100%': { transform: 'scale(1)', opacity: '1' }
                    }
                }
            }
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Firebase SDK v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- Sistema API REST -->
<script src="api-rest-system.js"></script>
<style>
    /* Estilos para el login especial */
    .login-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .login-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        max-width: 500px;
        width: 100%;
        text-align: center;
        animation: bounceIn 0.8s ease-out;
    }

    .user-option {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 3px solid #e2e8f0;
        border-radius: 16px;
        padding: 24px;
        margin: 16px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .user-option:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        border-color: #3b82f6;
    }

    .user-option.selected {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
    }

    .user-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }

    .user-option:hover::before {
        left: 100%;
    }

    .user-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: white;
        font-size: 24px;
        transition: all 0.3s ease;
    }

    .user-option:hover .user-icon {
        transform: scale(1.1);
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    }

    .user-option.selected .user-icon {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: scale(1.05);
    }

    .login-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 16px 32px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 24px;
        width: 100%;
        opacity: 0.5;
        pointer-events: none;
    }

    .login-btn.active {
        opacity: 1;
        pointer-events: auto;
    }

    .login-btn.active:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .login-loading {
        display: none;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e2e8f0;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 12px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .main-system {
        display: none;
    }

    .main-system.active {
        display: block;
    }

    /* Login container */
    .login-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex; /* Mostrar por defecto */
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .login-container.show {
        display: flex; /* Solo se muestra cuando se añade la clase 'show' */
    }

    /* Header de usuario logueado */
    .user-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        margin-left: 16px;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        color: white;
        font-size: 14px;
    }

    .logout-btn {
        background: rgba(239, 68, 68, 0.2);
        color: white;
        border: 1px solid rgba(239, 68, 68, 0.3);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 12px;
    }

    .logout-btn:hover {
        background: rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.5);
    }

    *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Estilos mejorados para la navegación */
    .nav-tab {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        background: rgba(71, 85, 105, 0.8);
        color: #e2e8f0;
        border: 2px solid rgba(148, 163, 184, 0.3);
    }

    .nav-tab::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
    }

    .nav-tab:hover {
        background: rgba(51, 65, 85, 0.9);
        color: #f1f5f9;
        border-color: rgba(148, 163, 184, 0.5);
        transform: translateY(-1px);
    }

    .nav-tab:hover::before {
        left: 100%;
    }

    .nav-tab.active {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        color: #ffffff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        border-color: #334155;
        transform: translateY(-2px);
    }

    .nav-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #fbbf24, #f59e0b);
    }

    /* Estilos para sub-navegación */
    .sub-nav-btn {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 2px solid rgba(59, 130, 246, 0.2);
    }

    .sub-nav-btn:hover {
        background: rgba(59, 130, 246, 0.2);
        color: #2563eb;
        border-color: rgba(59, 130, 246, 0.4);
        transform: translateY(-1px);
    }

    .sub-nav-btn.active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        border-color: #2563eb;
        transform: translateY(-1px);
    }

    .sub-nav-btn-green {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 2px solid rgba(16, 185, 129, 0.2);
    }

    .sub-nav-btn-green:hover {
        background: rgba(16, 185, 129, 0.2);
        color: #059669;
        border-color: rgba(16, 185, 129, 0.4);
        transform: translateY(-1px);
    }

    .sub-nav-btn-green.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        border-color: #059669;
        transform: translateY(-1px);
    }

    /* Animaciones para el cambio de vista */
    .view-container {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s ease;
    }

    .view-container.active {
        opacity: 1;
        transform: translateY(0);
    }

    .sub-view-container {
        opacity: 0;
        transform: translateX(20px);
        transition: all 0.3s ease;
        display: none;
    }

    .sub-view-container.active {
        opacity: 1;
        transform: translateX(0);
        display: block;
    }

    .barcode-container {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin: 16px 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
    }

    .barcode-svg {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
    }

    .barcode-text {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        margin-top: 12px;
        letter-spacing: 1px;
        word-break: break-all;
        text-align: center;
    }

    .modal-content {
        max-width: 90vw;
        max-height: 90vh;
        width: 100%;
        margin: 20px;
    }

    @media (min-width: 640px) {
        .modal-content {
            max-width: 500px;
            margin: 40px;
        }
    }

    .card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #e5e7eb;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        transform: translateY(-1px);
    }

    .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        transform: translateY(-1px);
    }

    .btn-danger:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        border: none;
        box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        box-shadow: 0 4px 12px rgba(75, 85, 99, 0.4);
        transform: translateY(-1px);
    }

    .btn-secondary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(75, 85, 99, 0.3);
    }

    .action-btn {
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .action-btn-view {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
    }

    .action-btn-view:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
        transform: translateY(-1px);
    }

    .action-btn-edit {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3);
    }

    .action-btn-edit:hover {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        box-shadow: 0 2px 6px rgba(217, 119, 6, 0.4);
        transform: translateY(-1px);
    }

    .action-btn-delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
    }

    .action-btn-delete:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        box-shadow: 0 2px 6px rgba(220, 38, 38, 0.4);
        transform: translateY(-1px);
    }

    .action-btn-print {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3);
    }

    .action-btn-print:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        box-shadow: 0 2px 6px rgba(5, 150, 105, 0.4);
        transform: translateY(-1px);
    }

    .export-btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        background: white;
        color: #374151;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .export-btn:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #1f2937;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .toggle-expired-btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .toggle-expired-btn:hover {
        opacity: 0.9;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    .status-active {
        background-color: #10b981;
    }

    .status-expired {
        background-color: #ef4444;
    }

    .search-container {
        position: relative;
        width: 100%;
        max-width: 220px;
        min-width: 180px;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        z-index: 10;
        font-size: 1rem;
    }

    .search-input {
        padding-left: 2.5rem;
        padding-right: 2.5rem;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-compact {
        gap: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    @media (min-width: 768px) {
        .form-row-2 {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 640px) {
        .search-container {
            max-width: 100%;
            min-width: 100%;
        }
    }

    /* Estilos móviles mejorados para tablas */
    
    /* Por defecto, ocultar contenedores móviles en desktop */
    .mobile-cards-container {
        display: none;
    }
    
    @media (max-width: 768px) {
        /* Ocultar tabla tradicional en móviles */
        .table-desktop {
            display: none !important;
        }
        
        /* Mostrar vista de tarjetas en móviles */
        .table-mobile {
            display: block !important;
        }
        
        /* Mostrar contenedores de tarjetas móviles */
        .mobile-cards-container {
            display: block !important;
        }
        
        /* Estilos para las tarjetas móviles */
        .mobile-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .mobile-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .mobile-card-title {
            font-weight: 600;
            font-size: 16px;
            color: #1f2937;
        }
        
        .mobile-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .mobile-field {
            display: flex;
            flex-direction: column;
        }
        
        .mobile-field-label {
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }
        
        .mobile-field-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }
        
        .mobile-field-full {
            grid-column: 1 / -1;
        }
        
        .mobile-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f3f4f6;
        }
        
        .mobile-status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .mobile-status-badge.badge-active {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        

        
        .mobile-status-badge.badge-expired {
            background: #fecaca;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .mobile-actions-buttons {
            display: flex;
            gap: 6px;
        }
        
        .mobile-action-btn {
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-action-btn:hover {
            transform: scale(1.05);
        }
        
        .mobile-qr-code {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mobile-qr-code:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        
        /* Worker table específicos */
        .worker-mobile-card {
            border-left: 4px solid #10b981;
        }
        
        .worker-mobile-card.priority-high {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }
        
        .worker-mobile-card.priority-medium {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
        }
        
        .worker-mobile-card.priority-normal {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }
        
        /* Ocultar columnas en tablets también */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Ajustes para tablets (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .table-desktop {
                display: table !important;
            }
            
            .table-mobile {
                display: none !important;
            }
        }
    }

    /* Estilos para desktop */
    @media (min-width: 769px) {
        .table-desktop {
            display: table !important;
        }
        
        .table-mobile {
            display: none !important;
        }
    }

    /* Mejoras adicionales para scroll horizontal en móviles */
    @media (max-width: 640px) {
        .overflow-x-auto {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        .overflow-x-auto::-webkit-scrollbar {
            height: 4px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    }

    @media (min-width: 640px) {
        .search-container {
            max-width: 220px;
            min-width: 180px;
        }
    }

    .custom-alert {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .fade-out {
        animation: fadeOut 0.3s ease-out forwards;
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    @media print {
        body * {
            visibility: hidden;
        }
        .print-area, .print-area * {
            visibility: visible;
        }
        .print-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-active {
        background-color: #d1fae5;
        color: #065f46;
    }



    .badge-expired {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .input-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }

    .select-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }

    .search-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
    }

    @media (max-width: 640px) {
        .search-actions {
            flex-direction: column;
            width: 100%;
            gap: 0.75rem;
            align-items: stretch;
        }
        .search-container {
            width: 100%;
        }
    }

    .input-with-scan {
        display: block;
        width: 100%;
    }

    .input-with-scan input {
        width: 100%;
        border-radius: 0.5rem;
    }

    /* Estilos para la tabla de trabajadores */
    .worker-table {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 2px solid #e2e8f0;
    }

    .worker-table th {
        background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        padding: 8px 12px;
        border-bottom: 2px solid #0f172a;
        font-size: 11px;
    }

    .worker-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #cbd5e1;
        font-weight: 500;
        font-size: 13px;
    }

    .worker-table tbody tr {
        background: white;
        transition: all 0.2s ease;
    }

    .worker-table tbody tr:nth-child(even) {
        background: #f8fafc;
    }

    .worker-table tbody tr:hover {
        background: #e0f2fe;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .worker-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .worker-badge-active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3);
    }



    .worker-badge-expired {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
    }

    /* Estilos unificados para todas las secciones de workers */
    .worker-section,
    .worker-section-maquinas {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border: 2px solid #cbd5e1;
        border-radius: 12px;
        padding: 16px;
        margin-top: 0;
    }

    .worker-header,
    .worker-header-maquinas {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(30, 41, 59, 0.3);
    }

    /* Estilos unificados para todas las tablas de workers */
    .worker-table,
    .worker-table-maquinas {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 2px solid #e2e8f0;
    }

    .worker-table th,
    .worker-table-maquinas th {
        background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        padding: 8px 12px;
        border-bottom: 2px solid #0f172a;
        font-size: 11px;
    }

    .worker-table td,
    .worker-table-maquinas td {
        padding: 8px 12px;
        border-bottom: 1px solid #cbd5e1;
        font-weight: 500;
        font-size: 13px;
    }

    .worker-table tbody tr,
    .worker-table-maquinas tbody tr {
        background: white;
        transition: all 0.2s ease;
    }

    .worker-table tbody tr:nth-child(even),
    .worker-table-maquinas tbody tr:nth-child(even) {
        background: #f8fafc;
    }

    .worker-table tbody tr:hover,
    .worker-table-maquinas tbody tr:hover {
        background: #e0f2fe;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Estilos unificados para los botones de código */
    .worker-code-btn,
    .worker-code-btn-maquinas {
        background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .worker-code-btn:hover,
    .worker-code-btn-maquinas:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(29, 78, 216, 0.4);
    }

    /* Estilos para expandir completamente las tablas de workers en modo panel */
    .sub-view-container.active {
        width: 100%;
    }

    .sub-view-container.active .worker-section,
    .sub-view-container.active .worker-section-maquinas {
        width: 100%;
        max-width: none;
        margin: 0;
    }

    .sub-view-container.active .worker-table,
    .sub-view-container.active .worker-table-maquinas {
        width: 100%;
        min-width: 100%;
        table-layout: fixed;
    }

    .sub-view-container.active .worker-table td,
    .sub-view-container.active .worker-table-maquinas td {
        padding: 12px 16px;
        word-wrap: break-word;
    }

    .sub-view-container.active .worker-table th,
    .sub-view-container.active .worker-table-maquinas th {
        padding: 12px 16px;
    }

    .sub-view-container.active .overflow-x-auto {
        overflow-x: visible;
    }

    /* Hacer que el Panel Control se adapte mejor a todos los tamaños */
    #sub-view-silos-panel.active,
    #sub-view-maquinas-panel.active {
        width: 100%;
        max-width: none;
        background: #f9fafb;
        padding: 1rem;
        margin: 0;
        min-height: auto;
        overflow-y: visible;
        overflow-x: hidden;
        position: relative;
    }

    /* Desktop específico */
    @media (min-width: 1024px) {
        #sub-view-silos-panel.active,
        #sub-view-maquinas-panel.active {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            width: calc(100vw - 2rem);
            z-index: 10;
            padding: 1.5rem;
            padding-top: 1rem;
            min-height: calc(100vh - 200px);
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
    }

    #sub-view-silos-panel.active .worker-section,
    #sub-view-maquinas-panel.active .worker-section-maquinas {
        width: 100%;
        max-width: none;
        margin: 0;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Mobile específico para panel */
    @media (max-width: 768px) {
        #sub-view-silos-panel.active,
        #sub-view-maquinas-panel.active {
            position: relative !important;
            width: 100% !important;
            padding: 0.75rem !important;
            background: transparent !important;
            min-height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            z-index: 1 !important;
        }
        
        #sub-view-silos-panel.active .worker-section,
        #sub-view-maquinas-panel.active .worker-section-maquinas {
            margin-top: 0 !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
        }
    }

    /* Responsive para las tablas del Panel de Control */
    #sub-view-silos-panel.active .worker-table,
    #sub-view-maquinas-panel.active .worker-table-maquinas {
        width: 100%;
        min-width: 100%; /* Cambiar para mobile */
        table-layout: auto;
    }

    /* Desktop - tabla completa */
    @media (min-width: 1024px) {
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            min-width: 800px; /* Ancho mínimo para forzar scroll horizontal solo en desktop */
        }
    }

    /* Tablet - tabla adaptada */
    @media (min-width: 769px) and (max-width: 1023px) {
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            min-width: 600px;
            font-size: 12px;
        }
        
        #sub-view-silos-panel.active .worker-table th,
        #sub-view-maquinas-panel.active .worker-table-maquinas th,
        #sub-view-silos-panel.active .worker-table td,
        #sub-view-maquinas-panel.active .worker-table-maquinas td {
            padding: 8px 6px;
        }
    }

    /* Móvil - usar tarjetas en lugar de tabla */
    @media (max-width: 768px) {
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            display: none !important; /* Ocultar tabla en móvil */
        }
        
        #sub-view-silos-panel.active .overflow-x-auto,
        #sub-view-maquinas-panel.active .overflow-x-auto {
            display: none !important; /* Ocultar contenedor de tabla en móvil */
        }
        
        /* Mostrar tarjetas móviles en el panel */
        #sub-view-silos-panel.active #workerCardsSilos,
        #sub-view-maquinas-panel.active #workerCardsMaquinas {
            display: block !important;
        }
        
        /* Asegurar que las tarjetas móviles no estén ocultas en los paneles */
        #sub-view-silos-panel.active .mobile-cards-container,
        #sub-view-maquinas-panel.active .mobile-cards-container {
            display: block !important;
        }
        
        /* Responsive headers para los paneles en móvil */
        #sub-view-silos-panel.active .worker-header,
        #sub-view-maquinas-panel.active .worker-header-maquinas {
            padding: 12px !important;
            border-radius: 8px !important;
        }
        
        #sub-view-silos-panel.active .worker-header h2,
        #sub-view-maquinas-panel.active .worker-header-maquinas h2 {
            font-size: 16px !important;
            line-height: 1.2 !important;
        }
        
        #sub-view-silos-panel.active .worker-header p,
        #sub-view-maquinas-panel.active .worker-header-maquinas p {
            font-size: 11px !important;
        }
        
        /* Ajustar información del panel en móvil */
        #sub-view-silos-panel.active .worker-section,
        #sub-view-maquinas-panel.active .worker-section-maquinas {
            margin-top: 0 !important;
        }
        
        /* Estilo específico para tarjetas móviles en paneles */
        #sub-view-silos-panel.active .mobile-cards-container .mobile-card,
        #sub-view-maquinas-panel.active .mobile-cards-container .mobile-card {
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 8px !important;
            padding: 12px !important;
            margin-bottom: 12px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }
        
        #sub-view-silos-panel.active .mobile-card-header,
        #sub-view-maquinas-panel.active .mobile-card-header {
            font-size: 14px !important;
            font-weight: 600 !important;
            margin-bottom: 8px !important;
            color: #374151 !important;
        }
        
        #sub-view-silos-panel.active .mobile-card-content,
        #sub-view-maquinas-panel.active .mobile-card-content {
            font-size: 12px !important;
            color: #6b7280 !important;
            line-height: 1.4 !important;
        }
    }

    @media (max-width: 640px) {
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            min-width: 600px; /* Mantener scroll horizontal */
        }
    }

    /* Responsive design para tablas del Panel de Control */
    @media (max-width: 1024px) {
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            font-size: 12px;
        }
        
        #sub-view-silos-panel.active .worker-table th,
        #sub-view-maquinas-panel.active .worker-table-maquinas th,
        #sub-view-silos-panel.active .worker-table td,
        #sub-view-maquinas-panel.active .worker-table-maquinas td {
            padding: 8px 6px;
        }
    }

    @media (max-width: 768px) {
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            font-size: 11px;
        }
        
        #sub-view-silos-panel.active .worker-table th,
        #sub-view-maquinas-panel.active .worker-table-maquinas th,
        #sub-view-silos-panel.active .worker-table td,
        #sub-view-maquinas-panel.active .worker-table-maquinas td {
            padding: 6px 4px;
            white-space: nowrap;
            overflow: visible; /* Cambiar para permitir ver contenido completo */
            text-overflow: clip;
            min-width: 80px; /* Ancho mínimo por columna */
        }
        
        #sub-view-silos-panel.active .worker-table th:first-child,
        #sub-view-maquinas-panel.active .worker-table-maquinas th:first-child,
        #sub-view-silos-panel.active .worker-table td:first-child,
        #sub-view-maquinas-panel.active .worker-table-maquinas td:first-child {
            min-width: 80px;
        }
    }

    @media (max-width: 640px) {
        #sub-view-silos-panel.active,
        #sub-view-maquinas-panel.active {
            width: calc(100vw - 1rem);
            padding: 1rem;
            padding-top: 1.5rem;
            max-height: calc(100vh - 80px);
        }
        
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            font-size: 10px;
        }
        
        #sub-view-silos-panel.active .worker-table th,
        #sub-view-maquinas-panel.active .worker-table-maquinas th,
        #sub-view-silos-panel.active .worker-table td,
        #sub-view-maquinas-panel.active .worker-table-maquinas td {
            padding: 4px 2px;
            min-width: 60px; /* Ancho mínimo para mantener legibilidad */
            white-space: nowrap;
        }
        
        /* Remover la ocultación de columnas para permitir scroll */
        /* #sub-view-silos-panel.active .worker-table th:nth-child(n+5),
        #sub-view-maquinas-panel.active .worker-table-maquinas th:nth-child(n+5),
        #sub-view-silos-panel.active .worker-table td:nth-child(n+5),
        #sub-view-maquinas-panel.active .worker-table-maquinas td:nth-child(n+5) {
            display: none;
        } */
    }

    @media (max-width: 480px) {
        /* En pantallas muy pequeñas, mantener todas las columnas pero con scroll */
        #sub-view-silos-panel.active .worker-table,
        #sub-view-maquinas-panel.active .worker-table-maquinas {
            min-width: 500px; /* Forzar scroll horizontal */
            font-size: 9px;
        }
        
        #sub-view-silos-panel.active .worker-table th,
        #sub-view-maquinas-panel.active .worker-table-maquinas th,
        #sub-view-silos-panel.active .worker-table td,
        #sub-view-maquinas-panel.active .worker-table-maquinas td {
            padding: 3px 1px;
            min-width: 50px;
            font-size: 8px;
        }
        
        /* Comentar la ocultación de columnas para permitir scroll completo */
        /* #sub-view-silos-panel.active .worker-table th:nth-child(n+4),
        #sub-view-maquinas-panel.active .worker-table-maquinas th:nth-child(n+4),
        #sub-view-silos-panel.active .worker-table td:nth-child(n+4),
        #sub-view-maquinas-panel.active .worker-table-maquinas td:nth-child(n+4) {
            display: none;
        } */
    }

    /* Responsive para el contenedor de overflow en Panel de Control */
    #sub-view-silos-panel.active .overflow-x-auto,
    #sub-view-maquinas-panel.active .overflow-x-auto {
        overflow-x: auto;
        overflow-y: visible;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
        max-height: calc(100vh - 300px);
        min-height: 400px;
    }

    /* Scroll específico para móviles */
    @media (max-width: 768px) {
        #sub-view-silos-panel.active .overflow-x-auto,
        #sub-view-maquinas-panel.active .overflow-x-auto {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 250px);
            min-height: 300px;
        }
    }

    @media (max-width: 640px) {
        #sub-view-silos-panel.active .overflow-x-auto,
        #sub-view-maquinas-panel.active .overflow-x-auto {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            min-height: 250px;
        }
    }

    #sub-view-silos-panel.active .overflow-x-auto::-webkit-scrollbar,
    #sub-view-maquinas-panel.active .overflow-x-auto::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }

    #sub-view-silos-panel.active .overflow-x-auto::-webkit-scrollbar-track,
    #sub-view-maquinas-panel.active .overflow-x-auto::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    #sub-view-silos-panel.active .overflow-x-auto::-webkit-scrollbar-thumb,
    #sub-view-maquinas-panel.active .overflow-x-auto::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    #sub-view-silos-panel.active .overflow-x-auto::-webkit-scrollbar-thumb:hover,
    #sub-view-maquinas-panel.active .overflow-x-auto::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    #sub-view-silos-panel.active .overflow-x-auto::-webkit-scrollbar-corner,
    #sub-view-maquinas-panel.active .overflow-x-auto::-webkit-scrollbar-corner {
        background: #f1f5f9;
    }

    /* Responsive improvements */
    @media (max-width: 1024px) {
        .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .grid-cols-1.lg\\:grid-cols-3 {
            grid-template-columns: 1fr;
        }
        
        .lg\\:col-span-2 {
            grid-column: span 1;
        }
        
        .lg\\:col-span-1 {
            grid-column: span 1;
        }
    }

    @media (max-width: 768px) {
        .nav-tab {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        .nav-tab span {
            display: none;
        }
        
        .nav-tab i {
            margin-right: 0;
            font-size: 1.25rem;
        }
        
        .card {
            padding: 1rem;
        }
        
        .grid.grid-cols-2 {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .grid.grid-cols-2 .col-span-2 {
            grid-column: span 1;
        }
        
        .text-2xl {
            font-size: 1.5rem;
        }
        
        .text-xl {
            font-size: 1.25rem;
        }
    }

    @media (max-width: 640px) {
        .container {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        header .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .nav-tab {
            padding: 0.5rem 0.75rem;
            min-width: 60px;
        }
        
        .sub-nav-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .sub-nav-btn i {
            font-size: 0.875rem;
        }
        
        .form-compact {
            gap: 0.75rem;
        }
        
        .card {
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        
        /* Table responsive improvements */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            min-width: 600px;
        }
        
        th, td {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .worker-table th,
        .worker-table-maquinas th {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .worker-table td,
        .worker-table-maquinas td {
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .action-btn i {
            font-size: 0.75rem;
        }
        
        .export-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
        }
        
        /* Stats cards responsive */
        .bg-blue-50, .bg-green-50, .bg-purple-50, 
        .bg-indigo-50, .bg-yellow-50, .bg-red-50 {
            padding: 0.75rem;
        }
        
        /* Input and form improvements */
        input, select, textarea {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .btn-primary, .btn-secondary {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Search container */
        .search-container {
            max-width: 100%;
            min-width: 150px;
        }
        
        /* Modal improvements */
        .modal-content {
            margin: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
    }

    /* Ultra small screens */
    @media (max-width: 480px) {
        .text-2xl {
            font-size: 1.25rem;
        }
        
        .text-xl {
            font-size: 1.125rem;
        }
        
        .text-lg {
            font-size: 1rem;
        }
        
        .nav-tab {
            padding: 0.5rem;
            min-width: 50px;
        }
        
        .sub-nav-btn {
            padding: 0.375rem 0.5rem;
            font-size: 0.6875rem;
        }
        
        .card {
            padding: 0.5rem;
        }
        
        .worker-header,
        .worker-header-maquinas {
            padding: 0.75rem 1rem;
        }
        
        .worker-section,
        .worker-section-maquinas {
            padding: 0.75rem;
        }
        
        /* Compact table for very small screens */
        table {
            min-width: 500px;
        }
        
        th, td {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .worker-table th,
        .worker-table-maquinas th {
            padding: 0.375rem 0.5rem;
            font-size: 0.6875rem;
        }
        
        .worker-table td,
        .worker-table-maquinas td {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }
    }

    /* Landscape orientation on mobile */
    @media (max-height: 500px) and (orientation: landscape) {
        .min-h-screen {
            min-height: 100vh;
        }
        
        header {
            padding: 0.5rem 0;
        }
        
        .py-8 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        .py-6 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
    }

    /* Print styles */
    @media print {
        .nav-tab, .sub-nav-btn, .action-btn, .export-btn,
        .search-container, button {
            display: none !important;
        }
        
        .overflow-x-auto {
            overflow: visible !important;
        }
        
        table {
            min-width: auto !important;
        }
        
        .card {
            box-shadow: none !important;
            border: 1px solid #e5e7eb !important;
        }
    }

    /* Touch improvements */
    @media (hover: none) and (pointer: coarse) {
        .action-btn, .nav-tab, .sub-nav-btn, .export-btn,
        button, select, input[type="button"] {
            min-height: 44px;
            min-width: 44px;
        }
        
        .worker-code-btn,
        .worker-code-btn-maquinas {
            min-height: 36px;
            min-width: 60px;
        }
    }

    /* ===== MODO OSCURO ESTILOS ===== */
    .dark-mode body,
    [data-theme="dark"] body {
        background-color: #1a1a1a !important;
        color: #e5e5e5 !important;
    }

    .dark-mode .bg-gray-50,
    [data-theme="dark"] .bg-gray-50 {
        background-color: #2d2d2d !important;
    }

    .dark-mode .bg-white,
    [data-theme="dark"] .bg-white {
        background-color: #3d3d3d !important;
    }

    .dark-mode .text-gray-800,
    [data-theme="dark"] .text-gray-800 {
        color: #e5e5e5 !important;
    }

    .dark-mode .text-gray-900,
    [data-theme="dark"] .text-gray-900 {
        color: #f5f5f5 !important;
    }

    .dark-mode .text-gray-600,
    [data-theme="dark"] .text-gray-600 {
        color: #b0b0b0 !important;
    }

    .dark-mode .border-gray-200,
    [data-theme="dark"] .border-gray-200 {
        border-color: #4d4d4d !important;
    }

    .dark-mode .bg-gray-100,
    [data-theme="dark"] .bg-gray-100 {
        background-color: #2a2a2a !important;
    }

    .dark-mode .hover\\:bg-gray-50:hover,
    [data-theme="dark"] .hover\\:bg-gray-50:hover {
        background-color: #404040 !important;
    }

    .dark-mode .shadow-lg,
    [data-theme="dark"] .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3) !important;
    }

    .dark-mode .barcode-container,
    [data-theme="dark"] .barcode-container {
        background-color: #2a2a2a !important;
        border-color: #4d4d4d !important;
    }

    .dark-mode input,
    .dark-mode select,
    .dark-mode textarea,
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
        background-color: #3d3d3d !important;
        color: #e5e5e5 !important;
        border-color: #4d4d4d !important;
    }

    .dark-mode .modal-content,
    [data-theme="dark"] .modal-content {
        background-color: #2d2d2d !important;
        color: #e5e5e5 !important;
    }

    /* Cards y estadísticas en modo oscuro */
    .dark-mode .bg-blue-50,
    [data-theme="dark"] .bg-blue-50 {
        background-color: #1e3a5f !important;
    }

    .dark-mode .bg-green-50,
    [data-theme="dark"] .bg-green-50 {
        background-color: #1e5f4a !important;
    }

    .dark-mode .bg-purple-50,
    [data-theme="dark"] .bg-purple-50 {
        background-color: #4a1e5f !important;
    }

    .dark-mode .bg-indigo-50,
    [data-theme="dark"] .bg-indigo-50 {
        background-color: #2d1e5f !important;
    }

    .dark-mode .bg-yellow-50,
    [data-theme="dark"] .bg-yellow-50 {
        background-color: #5f4a1e !important;
    }

    .dark-mode .bg-red-50,
    [data-theme="dark"] .bg-red-50 {
        background-color: #5f1e1e !important;
    }

    /* Mobile cards en modo oscuro */
    .dark-mode .mobile-card,
    [data-theme="dark"] .mobile-card {
        background-color: #3d3d3d !important;
        border-color: #4d4d4d !important;
    }

    /* Transición suave para el cambio de tema */
    body {
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .bg-white, .bg-gray-50, .bg-gray-100 {
        transition: background-color 0.3s ease;
    }

    .text-gray-800, .text-gray-900, .text-gray-600 {
        transition: color 0.3s ease;
    }
</style>
</head>
<body class="font-sans bg-gray-50 text-gray-800">

<!-- Pantalla de Login -->
<div id="loginScreen" class="login-container">
    <div class="login-card">
        <div class="mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-industry text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Sistema de Gestión Industrial</h1>
            <p class="text-gray-600">Selecciona tu tipo de usuario para continuar</p>
        </div>

        <div class="space-y-4">
            <div class="user-option" data-user="administrador">
                <div class="user-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Administrador</h3>
                <p class="text-gray-600 text-sm">Acceso completo al sistema de gestión</p>
                <div class="mt-3 flex items-center justify-center text-sm text-gray-500">
                    <i class="fas fa-check-circle mr-2"></i>
                    Control total de operaciones
                </div>
            </div>

            <div class="user-option" data-user="trabajador">
                <div class="user-icon">
                    <i class="fas fa-hard-hat"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Trabajador</h3>
                <p class="text-gray-600 text-sm">Acceso a operaciones de planta</p>
                <div class="mt-3 flex items-center justify-center text-sm text-gray-500">
                    <i class="fas fa-cogs mr-2"></i>
                    Gestión de silos y máquinas
                </div>
            </div>
        </div>

        <button id="loginBtn" class="login-btn">
            <i class="fas fa-sign-in-alt mr-2"></i>
            Iniciar Sesión
        </button>

        <div id="loginLoading" class="login-loading">
            <div class="spinner"></div>
            <span class="text-gray-600">Iniciando sesión...</span>
        </div>

        <!-- Botón para limpiar datos del localStorage -->
        <button id="clearDataBtn" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 w-full">
            <i class="fas fa-trash mr-2"></i>
            Limpiar Datos Guardados
        </button>

        <div class="mt-8 text-xs text-gray-500">
            <p>Sistema de Gestión Industrial Integrado v2.3.0</p>
            <p class="mt-1">Control completo de silos, lotes y operaciones</p>
        </div>
    </div>
</div>

<!-- Sistema Principal -->
<div id="mainSystem" class="main-system min-h-screen flex flex-col">

<div class="min-h-screen flex flex-col">
    <!-- Header con Navegación -->
    <header class="bg-gradient-to-r from-slate-800 to-slate-900 text-white shadow-lg">
        <div class="container mx-auto px-2 sm:px-4 py-3 sm:py-6">
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center">
                <div class="flex items-center mb-3 lg:mb-0">
                    <div class="bg-white bg-opacity-20 p-2 sm:p-3 rounded-xl mr-3 sm:mr-4">
                        <i class="fas fa-industry text-white text-xl sm:text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-2xl font-bold leading-tight">Sistema de Gestión Industrial Integrado</h1>
                        <p class="text-slate-100 mt-1 text-xs sm:text-sm">Control completo de silos, lotes y operaciones</p>
                    </div>
                </div>
                <div class="text-left lg:text-right">
                    <div class="flex items-center justify-between lg:justify-end mb-2">
                        <!-- Información del usuario logueado -->
                        <div id="userInfo" class="user-info">
                            <div class="user-avatar">
                                <i id="userIcon" class="fas fa-user"></i>
                            </div>
                            <div class="text-left">
                                <div id="userName" class="text-sm font-medium">Usuario</div>
                                <div id="userRole" class="text-xs text-slate-300">Rol</div>
                            </div>
                            <button id="logoutBtn" class="logout-btn">
                                <i class="fas fa-sign-out-alt mr-1"></i>
                                Salir
                            </button>
                        </div>
                        
                        <button id="theme-toggle" class="bg-white bg-opacity-10 hover:bg-opacity-20 px-3 py-1 rounded-full text-xs transition-all duration-200 flex items-center mr-3"
                                aria-label="Cambiar tema claro/oscuro">
                            <i class="fas fa-sun mr-1" id="theme-icon"></i>
                            <span id="theme-text">Claro</span>
                        </button>
                        <div class="inline-flex items-center bg-white bg-opacity-10 px-2 sm:px-3 py-1 rounded-full">
                            <span class="text-slate-100 text-xs sm:text-sm mr-2">Versión 2.3.0</span>
                            <span class="h-2 w-2 bg-green-400 rounded-full animate-pulse"></span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-200 mt-1">Última actualización: <span id="current-time" class="font-medium"></span></p>
                </div>
            </div>
            
            <!-- Navegación por pestañas mejorada -->
            <div class="mt-4 sm:mt-6 border-t border-slate-700 pt-3 sm:pt-4">
                <nav class="flex space-x-1 sm:space-x-2">
                    <button id="tab-silos-lotes" class="nav-tab active flex items-center px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300" 
                            role="tab" aria-selected="true" aria-controls="view-silos-lotes" tabindex="0"
                            aria-label="Navegar a gestión de silos y lotes">
                        <i class="fas fa-warehouse mr-0 sm:mr-2" aria-hidden="true"></i>
                        <span class="hidden sm:inline">Gestión de Silos y Lotes</span>
                        <span class="sm:hidden ml-2 text-xs">Silos</span>
                    </button>
                    <button id="tab-maquinas-silos" class="nav-tab flex items-center px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300"
                            role="tab" aria-selected="false" aria-controls="view-maquinas-silos" tabindex="-1"
                            aria-label="Navegar a gestión de máquinas y silos">
                        <i class="fas fa-cogs mr-0 sm:mr-2" aria-hidden="true"></i>
                        <span class="hidden sm:inline">Gestión de Máquinas y Silos</span>
                        <span class="sm:hidden ml-2 text-xs">Máquinas</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Vista 1: Silos y Lotes -->
    <div id="view-silos-lotes" class="view-container active flex-grow">
        <main class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 sm:gap-8">
                <!-- Form Section con Sub-navegación -->
                <div class="xl:col-span-1">
                    <!-- Sub-navegación para Silos y Lotes -->
                    <div class="mb-4 sm:mb-6">
                        <nav class="flex space-x-1 sm:space-x-2 p-1 bg-gray-100 rounded-lg">
                            <button id="sub-tab-silos-form" class="sub-nav-btn active flex items-center px-2 sm:px-4 py-2 rounded-md font-medium text-xs sm:text-sm transition-all duration-300 flex-1 justify-center">
                                <i class="fas fa-plus-circle mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                                <span class="hidden xs:inline">Registro</span>
                                <span class="xs:hidden">Registro</span>
                            </button>
                            <button id="sub-tab-silos-panel" class="sub-nav-btn flex items-center px-2 sm:px-4 py-2 rounded-md font-medium text-xs sm:text-sm transition-all duration-300 flex-1 justify-center">
                                <i class="fas fa-hard-hat mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                                <span class="hidden xs:inline">Panel Control</span>
                                <span class="xs:hidden">Panel</span>
                            </button>
                        </nav>
                    </div>

                    <!-- Sub-vista: Formulario de Registro -->
                    <div id="sub-view-silos-form" class="sub-view-container active">
                        <div class="card bg-white rounded-xl shadow-sm p-3 sm:p-6">
                            <div class="flex items-center mb-4 sm:mb-6">
                                <div class="bg-blue-100 p-2 sm:p-3 rounded-xl mr-3 sm:mr-4">
                                    <i class="fas fa-plus-circle text-blue-600 text-lg sm:text-xl"></i>
                                </div>
                                <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Nuevo Registro</h2>
                            </div>
                            <form id="siloForm" class="space-y-3 sm:space-y-4">
                                <!-- Número de Lote -->
                                <div>
                                    <label for="lote" class="block text-sm font-medium text-gray-700 mb-2">Número de Lote</label>
                                    <div class="input-with-scan">
                                        <div class="relative">
                                            <i class="fas fa-barcode input-icon"></i>
                                            <input type="text" id="lote" class="w-full pl-10 p-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 rounded-lg text-base" placeholder="Ej: LOTE2023-001 o escanee código" required>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Ingrese manualmente o use un lector de código de barras de hardware.
                                    </p>
                                </div>
                                <!-- Silo -->
                                <div>
                                    <label for="silo" class="block text-sm font-medium text-gray-700 mb-2">Silo</label>
                                    <div class="relative">
                                        <i class="fas fa-archive input-icon"></i>
                                        <select id="silo" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none transition-all duration-200 text-base" required>
                                            <option value="">Seleccione un silo</option>
                                            <option value="Silo 1">Silo 1</option>
                                            <option value="Silo 2">Silo 2</option>
                                            <option value="Silo 3">Silo 3</option>
                                            <option value="Silo 4">Silo 4</option>
                                            <option value="Silo 5">Silo 5</option>
                                            <option value="Tolva 1">Tolva 1</option>
                                            <option value="Tolva 2">Tolva 2</option>
                                            <option value="Tolva 3">Tolva 3</option>
                                        </select>
                                        <i class="fas fa-chevron-down select-icon"></i>
                                    </div>
                                </div>
                                <!-- Máquina -->
                                <div>
                                    <label for="maquina" class="block text-sm font-medium text-gray-700 mb-2">Máquina</label>
                                    <div class="relative">
                                        <i class="fas fa-cogs input-icon"></i>
                                        <select id="maquina" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none transition-all duration-200 text-base" required>
                                            <option value="">Seleccione una máquina</option>
                                            <option value="Máquina 1">Máquina 1</option>
                                            <option value="Máquina 2">Máquina 2</option>
                                            <option value="Máquina 3">Máquina 3</option>
                                            <option value="Máquina 4">Máquina 4</option>
                                            <option value="Máquina 5">Máquina 5</option>
                                            <option value="Máquina 6">Máquina 6</option>
                                            <option value="Máquina 7">Máquina 7</option>
                                            <option value="Máquina 8">Máquina 8</option>
                                        </select>
                                        <i class="fas fa-chevron-down select-icon"></i>
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary text-white w-full py-3 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center text-base" 
                                        id="submit-btn-silos" aria-label="Registrar nuevo lote en el sistema">
                                    <i class="fas fa-save mr-2" aria-hidden="true"></i> 
                                    <span class="submit-text">Registrar Lote</span>
                                    <i class="fas fa-spinner fa-spin mr-2 hidden loading-spinner" aria-hidden="true"></i>
                                </button>
                            </form>
                        </div>
                        <!-- Stats Card -->
                        <div class="card bg-white rounded-xl shadow-sm p-3 sm:p-6 mt-4 sm:mt-6">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4 flex items-center">
                                <i class="fas fa-chart-pie mr-2 text-blue-600"></i> Métricas Clave
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                <div class="bg-blue-50 p-3 sm:p-4 rounded-lg border border-blue-100">
                                    <div class="text-blue-600 text-xs sm:text-sm font-medium mb-1">Registros Activos</div>
                                    <div class="text-xl sm:text-2xl font-bold text-gray-800" id="active-count-silos">0</div>
                                </div>
                                <div class="bg-green-50 p-3 sm:p-4 rounded-lg border border-green-100">
                                    <div class="text-green-600 text-xs sm:text-sm font-medium mb-1">Silos en Uso</div>
                                    <div class="text-xl sm:text-2xl font-bold text-gray-800" id="silos-in-use">0/6</div>
                                </div>
                                <div class="bg-purple-50 p-3 sm:p-4 rounded-lg border border-purple-100 col-span-1 sm:col-span-2">
                                    <div class="text-purple-600 text-xs sm:text-sm font-medium mb-1">Último Registro</div>
                                    <div class="text-sm sm:text-md font-medium text-gray-800 truncate" id="last-record-silos">N/A</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-vista: Panel de Control -->
                    <div id="sub-view-silos-panel" class="sub-view-container">
                        <!-- Navegación específica para desktop dentro del panel -->
                        <div class="mb-4 sm:mb-6 hidden lg:block">
                            <nav class="flex space-x-1 sm:space-x-2 p-1 bg-gray-100 rounded-lg">
                                <button id="panel-nav-silos-form" class="sub-nav-btn flex items-center px-2 sm:px-4 py-2 rounded-md font-medium text-xs sm:text-sm transition-all duration-300 flex-1 justify-center">
                                    <i class="fas fa-plus-circle mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                                    <span class="hidden xs:inline">Registro</span>
                                    <span class="xs:hidden">Registro</span>
                                </button>
                                <button id="panel-nav-silos-panel" class="sub-nav-btn active flex items-center px-2 sm:px-4 py-2 rounded-md font-medium text-xs sm:text-sm transition-all duration-300 flex-1 justify-center">
                                    <i class="fas fa-hard-hat mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                                    <span class="hidden xs:inline">Panel Control</span>
                                    <span class="xs:hidden">Panel</span>
                                </button>
                            </nav>
                        </div>
                        
                        <div class="worker-section">
                            <div class="worker-header">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                    <div class="flex items-center mb-2 sm:mb-0">
                                        <div class="bg-white bg-opacity-20 p-2 rounded-lg mr-3">
                                            <i class="fas fa-hard-hat text-white text-base sm:text-lg"></i>
                                        </div>
                                        <div>
                                            <h2 class="text-base sm:text-lg font-bold">Panel de Control - Personal de Planta</h2>
                                            <p class="text-gray-300 text-xs mt-1">Información operativa para trabajadores</p>
                                        </div>
                                    </div>
                                    <div class="text-left sm:text-right">
                                        <div class="text-xs text-gray-300">Turno Actual</div>
                                        <div class="text-sm sm:text-md font-bold" id="current-shift">Mañana</div>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto rounded-lg hidden md:block">
                                <table class="w-full worker-table">
                                    <thead>
                                        <tr>
                                            <th class="text-left">Estado</th>
                                            <th class="text-left hidden sm:table-cell">Equipo</th>
                                            <th class="text-left">Ubicación</th>
                                            <th class="text-left">Lote</th>
                                            <th class="text-left">Hora</th>
                                            <th class="text-center">QR</th>
                                        </tr>
                                    </thead>
                                    <tbody id="workerTableSilos">
                                        <!-- Los registros se añadirán aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Contenedor móvil para tarjetas de workers silos -->
                            <div id="workerCardsSilos" class="mobile-cards-container space-y-3">
                                <!-- Las tarjetas móviles se añadirán aquí dinámicamente -->
                            </div>

                            <div class="mt-4 bg-white rounded-lg p-2 sm:p-3 border border-gray-200">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-blue-600 mr-2 text-sm"></i>
                                        <span class="text-xs font-medium text-gray-700" id="worker-table-info-silos">Mostrando 0 operaciones activas</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="refresh-worker-data-silos" class="export-btn text-xs px-3 py-1">
                                            <i class="fas fa-sync-alt text-xs"></i> Actualizar
                                        </button>
                                        <button id="worker-print-report-silos" class="export-btn text-xs px-3 py-1">
                                            <i class="fas fa-print text-xs"></i> Imprimir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-table mr-2 text-blue-600"></i> Registros Actuales
                                </h2>
                                <div class="search-actions flex flex-col sm:flex-row gap-3">
                                    <div class="search-container flex-grow sm:flex-grow-0 sm:w-64">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" id="searchInputSilos" class="search-input w-full p-2.5 pl-10 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-base" placeholder="Buscar...">
                                        <button id="clearSearchSilos" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <button id="show-expired-silos" class="action-btn bg-red-500 hover:bg-red-600 text-white py-2.5 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center whitespace-nowrap text-sm">
                                        <i class="fas fa-archive mr-2"></i> 
                                        <span class="hidden sm:inline">Ver </span>Expirados
                                    </button>
                                    <button id="clearStorageSilos" class="btn-danger text-white py-2.5 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center whitespace-nowrap text-sm">
                                        <i class="fas fa-trash-alt mr-2"></i> 
                                        <span class="hidden sm:inline">Limpiar </span>Todo
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-gray-200 hidden md:block">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50">
                                        <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <th class="px-3 sm:px-6 py-3">Estado</th>
                                            <th class="px-3 sm:px-6 py-3 hidden md:table-cell">Máquina</th>
                                            <th class="px-3 sm:px-6 py-3 hidden sm:table-cell">Silo</th>
                                            <th class="px-3 sm:px-6 py-3">Lote</th>
                                            <th class="px-3 sm:px-6 py-3 hidden lg:table-cell">Fecha/Hora</th>
                                            <th class="px-3 sm:px-6 py-3 hidden sm:table-cell">Código</th>
                                            <th class="px-3 sm:px-6 py-3 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registrosTableSilos" class="divide-y divide-gray-200 bg-white">
                                        <!-- Registros se añadirán aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Contenedor móvil para tarjetas de silos -->
                            <div id="registrosCardsSilos" class="mobile-cards-container space-y-3">
                                <!-- Las tarjetas móviles se añadirán aquí dinámicamente -->
                            </div>
                            
                            <div class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 text-sm text-gray-600">
                                <div id="table-info-silos">Mostrando 0 registros</div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="export-csv-silos" class="export-btn text-xs px-3 py-2">
                                        <i class="fas fa-file-csv"></i> 
                                        <span class="hidden sm:inline">Exportar </span>CSV Activos
                                    </button>
                                    <button id="print-report-silos" class="export-btn text-xs px-3 py-2">
                                        <i class="fas fa-print"></i> 
                                        <span class="hidden sm:inline">Imprimir</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Panel de Registros Expirados - Silos -->
                        <div id="expired-panel-silos" class="card bg-white border border-red-200" style="display: none; margin-top: 20px;">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-red-600">
                                    <i class="fas fa-archive mr-2"></i>Registros Expirados - Silos y Lotes
                                </h3>
                                <div class="flex gap-2">
                                    <button id="delete-all-expired-silos" class="action-btn bg-red-700 hover:bg-red-800 text-white text-xs px-3 py-1">
                                        <i class="fas fa-trash-alt"></i> Eliminar Todos
                                    </button>
                                    <button id="hide-expired-silos" class="action-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1">
                                        <i class="fas fa-eye-slash"></i> Ocultar
                                    </button>
                                </div>
                            </div>

                            <!-- Búsqueda para expirados -->
                            <div class="mb-4 flex flex-col sm:flex-row gap-3">
                                <div class="search-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input 
                                        type="text" 
                                        id="searchInputExpiredSilos" 
                                        placeholder="Buscar en expirados..." 
                                        class="search-input pl-10 pr-10 py-2 w-full text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    >
                                    <button id="clearSearchExpiredSilos" class="clear-search-btn" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Tabla desktop para expirados -->
                            <div class="desktop-table-container">
                                <table class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="table-header">Estado</th>
                                            <th class="table-header">Máquina</th>
                                            <th class="table-header">Silo</th>
                                            <th class="table-header">Lote</th>
                                            <th class="table-header">Fecha/Hora</th>
                                            <th class="table-header">Código</th>
                                            <th class="table-header">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registrosTableExpiredSilos">
                                        <!-- Los registros se añadirán aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Contenedor móvil para tarjetas de expirados -->
                            <div id="registrosCardsExpiredSilos" class="mobile-cards-container space-y-3">
                                <!-- Las tarjetas móviles se añadirán aquí dinámicamente -->
                            </div>
                            
                            <div class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 text-sm text-gray-600">
                                <div id="table-info-expired-silos">Mostrando 0 registros expirados</div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="export-csv-expired-silos" class="export-btn text-xs px-3 py-2" style="background: #ef4444; color: white; border-color: #ef4444;">
                                        <i class="fas fa-file-csv"></i> 
                                        <span class="hidden sm:inline">Exportar </span>CSV Expirados
                                    </button>
                                    <button id="print-report-expired-silos" class="export-btn text-xs px-3 py-2" style="background: #ef4444; color: white; border-color: #ef4444;">
                                        <i class="fas fa-print"></i> 
                                        <span class="hidden sm:inline">Imprimir</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Vista 2: Máquinas y Silos -->
    <div id="view-maquinas-silos" class="view-container flex-grow" style="display: none;">
        <main class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Form Section con Sub-navegación -->
                <div class="lg:col-span-1">
                    <!-- Sub-navegación para Máquinas y Silos -->
                    <div class="mb-6">
                        <nav class="flex space-x-2 p-1 bg-gray-100 rounded-lg">
                            <button id="sub-tab-maquinas-form" class="sub-nav-btn-green active flex items-center px-4 py-2 rounded-md font-medium text-sm transition-all duration-300 flex-1 justify-center">
                                <i class="fas fa-plus-circle mr-2"></i>
                                Registro
                            </button>
                            <button id="sub-tab-maquinas-panel" class="sub-nav-btn-green flex items-center px-4 py-2 rounded-md font-medium text-sm transition-all duration-300 flex-1 justify-center">
                                <i class="fas fa-users-cog mr-2"></i>
                                Panel Control
                            </button>
                        </nav>
                    </div>

                    <!-- Sub-vista: Formulario de Registro -->
                    <div id="sub-view-maquinas-form" class="sub-view-container active">
                        <div class="card bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center mb-6">
                                <div class="bg-green-100 p-3 rounded-xl mr-4">
                                    <i class="fas fa-plus-circle text-green-600 text-xl"></i>
                                </div>
                                <h2 class="text-xl font-semibold text-gray-800">Nuevo Registro</h2>
                            </div>
                            <form id="maquinaForm" class="space-y-4">
                                <!-- Máquina -->
                                <div>
                                    <label for="maquinaMaq" class="block text-sm font-medium text-gray-700 mb-2">Máquina</label>
                                    <div class="relative">
                                        <i class="fas fa-cogs input-icon"></i>
                                        <select id="maquinaMaq" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 appearance-none transition-all duration-200" required>
                                            <option value="">Seleccione una máquina</option>
                                            <option value="Máquina 1">Máquina 1</option>
                                            <option value="Máquina 2">Máquina 2</option>
                                            <option value="Máquina 3">Máquina 3</option>
                                            <option value="Máquina 4">Máquina 4</option>
                                            <option value="Máquina 5">Máquina 5</option>
                                            <option value="Máquina 6">Máquina 6</option>
                                            <option value="Máquina 7">Máquina 7</option>
                                            <option value="Máquina 8">Máquina 8</option>
                                        </select>
                                        <i class="fas fa-chevron-down select-icon"></i>
                                    </div>
                                </div>

                                <!-- Silo -->
                                <div>
                                    <label for="siloMaq" class="block text-sm font-medium text-gray-700 mb-2">Silo</label>
                                    <div class="relative">
                                        <i class="fas fa-archive input-icon"></i>
                                        <select id="siloMaq" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 appearance-none transition-all duration-200" required>
                                            <option value="">Seleccione un silo</option>
                                            <option value="Silo 1">Silo 1</option>
                                            <option value="Silo 2">Silo 2</option>
                                            <option value="Silo 3">Silo 3</option>
                                            <option value="Silo 4">Silo 4</option>
                                            <option value="Silo 5">Silo 5</option>
                                            <option value="Tolva 1">Tolva 1</option>
                                            <option value="Tolva 2">Tolva 2</option>
                                            <option value="Tolva 3">Tolva 3</option>
                                            
                                        </select>
                                        <i class="fas fa-chevron-down select-icon"></i>
                                    </div>
                                </div>

                                <!-- Operador -->
                                <div>
                                    <label for="operador" class="block text-sm font-medium text-gray-700 mb-2">Operador</label>
                                    <div class="relative">
                                        <i class="fas fa-user input-icon"></i>
                                        <input type="text" id="operador" class="w-full pl-10 p-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 rounded-lg" placeholder="Nombre del operador" required>
                                    </div>
                                </div>

                                <!-- Turno -->
                                <div>
                                    <label for="turno" class="block text-sm font-medium text-gray-700 mb-2">Turno</label>
                                    <div class="relative">
                                        <i class="fas fa-clock input-icon"></i>
                                        <select id="turno" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 appearance-none transition-all duration-200" required>
                                            <option value="">Seleccione un turno</option>
                                            <option value="Mañana (06:00-14:00)">Mañana (06:00-14:00)</option>
                                            <option value="Tarde (14:00-22:00)">Tarde (14:00-22:00)</option>
                                            <option value="Noche (22:00-06:00)">Noche (22:00-06:00)</option>
                                        </select>
                                        <i class="fas fa-chevron-down select-icon"></i>
                                    </div>
                                </div>

                                <!-- Producto -->
                                <div>
                                    <label for="producto" class="block text-sm font-medium text-gray-700 mb-2">Producto/Material</label>
                                    <div class="relative">
                                        <i class="fas fa-box input-icon"></i>
                                        <input type="text" id="producto" class="w-full pl-10 p-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 rounded-lg" placeholder="Tipo de producto o material" required>
                                    </div>
                                </div>

                                <button type="submit" class="btn-primary text-white w-full py-3 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center">
                                    <i class="fas fa-save mr-2"></i> Registrar Operación
                                </button>
                            </form>
                        </div>

                        <!-- Stats Card -->
                        <div class="card bg-white rounded-xl shadow-sm p-6 mt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-chart-pie mr-2 text-green-600"></i> Métricas Clave
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                <div class="bg-green-50 p-3 sm:p-4 rounded-lg border border-green-100">
                                    <div class="text-green-600 text-xs sm:text-sm font-medium mb-1">Operaciones Activas</div>
                                    <div class="text-xl sm:text-2xl font-bold text-gray-800" id="active-count-maquinas">0</div>
                                </div>
                                <div class="bg-blue-50 p-3 sm:p-4 rounded-lg border border-blue-100">
                                    <div class="text-blue-600 text-xs sm:text-sm font-medium mb-1">Máquinas en Uso</div>
                                    <div class="text-xl sm:text-2xl font-bold text-gray-800" id="machines-in-use">0/8</div>
                                </div>
                                <div class="bg-purple-50 p-3 sm:p-4 rounded-lg border border-purple-100 col-span-1 sm:col-span-2">
                                    <div class="text-purple-600 text-xs sm:text-sm font-medium mb-1">Última Operación</div>
                                    <div class="text-sm sm:text-md font-medium text-gray-800 truncate" id="last-record-maquinas">N/A</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-vista: Panel de Control -->
                    <div id="sub-view-maquinas-panel" class="sub-view-container">
                        <!-- Navegación específica para desktop dentro del panel -->
                        <div class="mb-6 hidden lg:block">
                            <nav class="flex space-x-2 p-1 bg-gray-100 rounded-lg">
                                <button id="panel-nav-maquinas-form" class="sub-nav-btn-green flex items-center px-4 py-2 rounded-md font-medium text-sm transition-all duration-300 flex-1 justify-center">
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Registro
                                </button>
                                <button id="panel-nav-maquinas-panel" class="sub-nav-btn-green active flex items-center px-4 py-2 rounded-md font-medium text-sm transition-all duration-300 flex-1 justify-center">
                                    <i class="fas fa-users-cog mr-2"></i>
                                    Panel Control
                                </button>
                            </nav>
                        </div>
                        
                        <div class="worker-section-maquinas">
                            <div class="worker-header-maquinas">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="bg-white bg-opacity-20 p-2 rounded-lg mr-3">
                                            <i class="fas fa-users-cog text-white text-lg"></i>
                                        </div>
                                        <div>
                                            <h2 class="text-lg font-bold">Panel de Control - Operadores de Máquinas</h2>
                                            <p class="text-gray-300 text-xs mt-1">Información operativa para operadores</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-300">Turno Actual</div>
                                        <div class="text-md font-bold" id="current-shift-maquinas">Mañana</div>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto rounded-lg hidden md:block">
                                <table class="w-full worker-table-maquinas">
                                    <thead>
                                        <tr>
                                            <th class="text-left">Estado Operativo</th>
                                            <th class="text-left">Máquina Asignada</th>
                                            <th class="text-left">Ubicación Silo</th>
                                            <th class="text-left">Operador Responsable</th>
                                            <th class="text-left">Turno de Trabajo</th>
                                            <th class="text-left">Material/Producto</th>
                                            <th class="text-left">Hora de Inicio</th>
                                            <th class="text-center">Código QR</th>
                                        </tr>
                                    </thead>
                                    <tbody id="workerTableMaquinas">
                                        <!-- Los registros se añadirán aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Contenedor móvil para tarjetas de workers máquinas -->
                            <div id="workerCardsMaquinas" class="mobile-cards-container space-y-3">
                                <!-- Las tarjetas móviles se añadirán aquí dinámicamente -->
                            </div>

                            <div class="mt-4 bg-white rounded-lg p-3 border border-green-200">
                                <div class="flex flex-col md:flex-row justify-between items-center">
                                    <div class="flex items-center mb-2 md:mb-0">
                                        <i class="fas fa-info-circle text-green-600 mr-2 text-sm"></i>
                                        <span class="text-xs font-medium text-gray-700" id="worker-table-info-maquinas">Mostrando 0 operaciones activas</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="refresh-worker-data-maquinas" class="export-btn text-xs px-3 py-1">
                                            <i class="fas fa-sync-alt text-xs"></i> Actualizar
                                        </button>
                                        <button id="worker-print-report-maquinas" class="export-btn text-xs px-3 py-1">
                                            <i class="fas fa-print text-xs"></i> Imprimir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-table mr-2 text-green-600"></i> Operaciones Actuales
                                </h2>
                                <div class="search-actions flex flex-col sm:flex-row gap-3">
                                    <div class="search-container flex-grow sm:flex-grow-0 sm:w-64">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" id="searchInputMaquinas" class="search-input w-full p-2.5 pl-10 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 text-base" placeholder="Buscar...">
                                        <button id="clearSearchMaquinas" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <button id="show-expired-maquinas" class="action-btn bg-red-500 hover:bg-red-600 text-white py-2.5 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center whitespace-nowrap text-sm">
                                        <i class="fas fa-archive mr-2"></i> 
                                        <span class="hidden sm:inline">Ver </span>Expirados
                                    </button>
                                    <button id="clearStorageMaquinas" class="btn-danger text-white py-2.5 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center whitespace-nowrap text-sm">
                                        <i class="fas fa-trash-alt mr-2"></i> 
                                        <span class="hidden sm:inline">Limpiar </span>Todo
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-gray-200 hidden md:block">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50">
                                        <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <th class="px-3 sm:px-6 py-3">Estado</th>
                                            <th class="px-3 sm:px-6 py-3">Máquina</th>
                                            <th class="px-3 sm:px-6 py-3 hidden sm:table-cell">Silo</th>
                                            <th class="px-3 sm:px-6 py-3 hidden md:table-cell">Operador</th>
                                            <th class="px-3 sm:px-6 py-3 hidden lg:table-cell">Turno</th>
                                            <th class="px-3 sm:px-6 py-3 hidden lg:table-cell">Producto</th>
                                            <th class="px-3 sm:px-6 py-3 hidden lg:table-cell">Fecha/Hora</th>
                                            <th class="px-3 sm:px-6 py-3 hidden sm:table-cell">Código</th>
                                            <th class="px-3 sm:px-6 py-3 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registrosTableMaquinas" class="divide-y divide-gray-200 bg-white">
                                        <!-- Registros se añadirán aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Contenedor móvil para tarjetas de máquinas -->
                            <div id="registrosCardsMaquinas" class="mobile-cards-container space-y-3">
                                <!-- Las tarjetas móviles se añadirán aquí dinámicamente -->
                            </div>
                            
                            <div class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 text-sm text-gray-600">
                                <div id="table-info-maquinas">Mostrando 0 registros</div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="export-csv-maquinas" class="export-btn text-xs px-3 py-2">
                                        <i class="fas fa-file-csv"></i> 
                                        <span class="hidden sm:inline">Exportar </span>CSV Activos
                                    </button>
                                    <button id="print-report-maquinas" class="export-btn text-xs px-3 py-2">
                                        <i class="fas fa-print"></i> 
                                        <span class="hidden sm:inline">Imprimir</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Panel de Registros Expirados - Máquinas -->
                        <div id="expired-panel-maquinas" class="card bg-white border border-red-200" style="display: none; margin-top: 20px;">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-red-600">
                                    <i class="fas fa-archive mr-2"></i>Registros Expirados - Máquinas y Silos
                                </h3>
                                <div class="flex gap-2">
                                    <button id="delete-all-expired-maquinas" class="action-btn bg-red-700 hover:bg-red-800 text-white text-xs px-3 py-1">
                                        <i class="fas fa-trash-alt"></i> Eliminar Todos
                                    </button>
                                    <button id="hide-expired-maquinas" class="action-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1">
                                        <i class="fas fa-eye-slash"></i> Ocultar
                                    </button>
                                </div>
                            </div>

                            <!-- Búsqueda para expirados -->
                            <div class="mb-4 flex flex-col sm:flex-row gap-3">
                                <div class="search-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input 
                                        type="text" 
                                        id="searchInputExpiredMaquinas" 
                                        placeholder="Buscar en expirados..." 
                                        class="search-input pl-10 pr-10 py-2 w-full text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    >
                                    <button id="clearSearchExpiredMaquinas" class="clear-search-btn" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Tabla desktop para expirados -->
                            <div class="desktop-table-container">
                                <table class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="table-header">Estado</th>
                                            <th class="table-header">Máquina</th>
                                            <th class="table-header">Silo</th>
                                            <th class="table-header">Operador</th>
                                            <th class="table-header">Turno</th>
                                            <th class="table-header">Producto</th>
                                            <th class="table-header">Fecha/Hora</th>
                                            <th class="table-header">Código</th>
                                            <th class="table-header">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registrosTableExpiredMaquinas">
                                        <!-- Los registros se añadirán aquí dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Contenedor móvil para tarjetas de expirados -->
                            <div id="registrosCardsExpiredMaquinas" class="mobile-cards-container space-y-3">
                                <!-- Las tarjetas móviles se añadirán aquí dinámicamente -->
                            </div>
                            
                            <div class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 text-sm text-gray-600">
                                <div id="table-info-expired-maquinas">Mostrando 0 registros expirados</div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="export-csv-expired-maquinas" class="export-btn text-xs px-3 py-2" style="background: #ef4444; color: white; border-color: #ef4444;">
                                        <i class="fas fa-file-csv"></i> 
                                        <span class="hidden sm:inline">Exportar </span>CSV Expirados
                                    </button>
                                    <button id="print-report-expired-maquinas" class="export-btn text-xs px-3 py-2" style="background: #ef4444; color: white; border-color: #ef4444;">
                                        <i class="fas fa-print"></i> 
                                        <span class="hidden sm:inline">Imprimir</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal del Código de Barras -->
<div id="barcodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="modal-content bg-white rounded-xl shadow-xl overflow-hidden">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-blue-100">
            <div class="flex items-center">
                <div class="bg-blue-500 p-2 rounded-lg mr-3">
                    <i class="fas fa-barcode text-white text-lg"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">Código de Barras</h3>
            </div>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700 hover:bg-gray-200 p-2 rounded-lg transition-all duration-200">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="barcode-container">
                <div class="flex items-center justify-center mb-3">
                    <i class="fas fa-qrcode text-gray-400 text-2xl"></i>
                </div>
                <svg id="modalBarcode" class="barcode-svg"></svg>
                <div id="barcodeText" class="barcode-text"></div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-calendar-alt text-gray-500 mr-2"></i>
                        <span class="text-gray-600">Generado:</span>
                        <span class="ml-1 font-medium" id="generationTime"></span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-cog text-gray-500 mr-2"></i>
                        <span class="text-gray-600">Formato:</span>
                        <span class="ml-1 font-medium">CODE128</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button id="printBarcode" class="btn-primary text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                    <i class="fas fa-print mr-2"></i> Imprimir Código
                </button>
                <button id="downloadBarcode" class="btn-secondary text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i> Descargar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición para Silos y Lotes -->
<div id="editModalSilos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="modal-content bg-white rounded-xl shadow-xl overflow-hidden">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-orange-100">
            <div class="flex items-center">
                <div class="bg-orange-500 p-2 rounded-lg mr-3">
                    <i class="fas fa-edit text-white text-lg"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">Editar Registro</h3>
            </div>
            <button id="closeEditModalSilos" class="text-gray-500 hover:text-gray-700 hover:bg-gray-200 p-2 rounded-lg transition-all duration-200">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="editFormSilos" class="space-y-4">
                <!-- Número de Lote -->
                <div>
                    <label for="editLote" class="block text-sm font-medium text-gray-700 mb-2">Número de Lote</label>
                    <div class="input-with-scan">
                        <div class="relative">
                            <i class="fas fa-barcode input-icon"></i>
                            <input type="text" id="editLote" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200" placeholder="Ej: LOTE2023-001 o escanee código" required>
                        </div>
                    </div>
                </div>
                <!-- Silo -->
                <div>
                    <label for="editSilo" class="block text-sm font-medium text-gray-700 mb-2">Silo</label>
                    <div class="relative">
                        <i class="fas fa-archive input-icon"></i>
                        <select id="editSilo" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 appearance-none transition-all duration-200" required>
                            <option value="">Seleccione un silo</option>
                            <option value="Silo 1">Silo 1</option>
                            <option value="Silo 2">Silo 2</option>
                            <option value="Silo 3">Silo 3</option>
                            <option value="Silo 4">Silo 4</option>
                            <option value="Silo 5">Silo 5</option>
                            <option value="Tolva 1">Tolva 1</option>
                            <option value="Tolva 2">Tolva 2</option>
                            <option value="Tolva 3">Tolva 3</option>
                        </select>
                        <i class="fas fa-chevron-down select-icon"></i>
                    </div>
                </div>
                <!-- Máquina -->
                <div>
                    <label for="editMaquina" class="block text-sm font-medium text-gray-700 mb-2">Máquina</label>
                    <div class="relative">
                        <i class="fas fa-cogs input-icon"></i>
                        <select id="editMaquina" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 appearance-none transition-all duration-200" required>
                            <option value="">Seleccione una máquina</option>
                            <option value="Máquina 1">Máquina 1</option>
                            <option value="Máquina 2">Máquina 2</option>
                            <option value="Máquina 3">Máquina 3</option>
                            <option value="Máquina 4">Máquina 4</option>
                            <option value="Máquina 5">Máquina 5</option>
                            <option value="Máquina 6">Máquina 6</option>
                            <option value="Máquina 7">Máquina 7</option>
                            <option value="Máquina 8">Máquina 8</option>
                        </select>
                        <i class="fas fa-chevron-down select-icon"></i>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 justify-end mt-6">
                    <button type="button" id="cancelEditSilos" class="btn-secondary text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                    <button type="submit" class="btn-primary text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Edición para Máquinas y Silos -->
<div id="editModalMaquinas" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="modal-content bg-white rounded-xl shadow-xl overflow-hidden">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-orange-100">
            <div class="flex items-center">
                <div class="bg-orange-500 p-2 rounded-lg mr-3">
                    <i class="fas fa-edit text-white text-lg"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800">Editar Registro</h3>
            </div>
            <button id="closeEditModalMaquinas" class="text-gray-500 hover:text-gray-700 hover:bg-gray-200 p-2 rounded-lg transition-all duration-200">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="editFormMaquinas" class="space-y-4">
                <!-- Máquina -->
                <div>
                    <label for="editMaquinaMaq" class="block text-sm font-medium text-gray-700 mb-2">Máquina</label>
                    <div class="relative">
                        <i class="fas fa-cogs input-icon"></i>
                        <select id="editMaquinaMaq" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 appearance-none transition-all duration-200" required>
                            <option value="">Seleccione una máquina</option>
                            <option value="Máquina 1">Máquina 1</option>
                            <option value="Máquina 2">Máquina 2</option>
                            <option value="Máquina 3">Máquina 3</option>
                            <option value="Máquina 4">Máquina 4</option>
                            <option value="Máquina 5">Máquina 5</option>
                            <option value="Máquina 6">Máquina 6</option>
                            <option value="Máquina 7">Máquina 7</option>
                            <option value="Máquina 8">Máquina 8</option>
                        </select>
                        <i class="fas fa-chevron-down select-icon"></i>
                    </div>
                </div>

                <!-- Silo -->
                <div>
                    <label for="editSiloMaq" class="block text-sm font-medium text-gray-700 mb-2">Silo</label>
                    <div class="relative">
                        <i class="fas fa-archive input-icon"></i>
                        <select id="editSiloMaq" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 appearance-none transition-all duration-200" required>
                            <option value="">Seleccione un silo</option>
                            <option value="Silo 1">Silo 1</option>
                            <option value="Silo 2">Silo 2</option>
                            <option value="Silo 3">Silo 3</option>
                            <option value="Silo 4">Silo 4</option>
                            <option value="Silo 5">Silo 5</option>
                            <option value="Tolva 1">Tolva 1</option>
                            <option value="Tolva 2">Tolva 2</option>
                            <option value="Tolva 3">Tolva 3</option>
                        </select>
                        <i class="fas fa-chevron-down select-icon"></i>
                    </div>
                </div>

                <!-- Operador -->
                <div>
                    <label for="editOperador" class="block text-sm font-medium text-gray-700 mb-2">Operador</label>
                    <div class="relative">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="editOperador" class="w-full pl-10 p-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200 rounded-lg" placeholder="Nombre del operador" required>
                    </div>
                </div>

                <!-- Turno -->
                <div>
                    <label for="editTurno" class="block text-sm font-medium text-gray-700 mb-2">Turno</label>
                    <div class="relative">
                        <i class="fas fa-clock input-icon"></i>
                        <select id="editTurno" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 appearance-none transition-all duration-200" required>
                            <option value="">Seleccione un turno</option>
                            <option value="Mañana (06:00-14:00)">Mañana (06:00-14:00)</option>
                            <option value="Tarde (14:00-22:00)">Tarde (14:00-22:00)</option>
                            <option value="Noche (22:00-06:00)">Noche (22:00-06:00)</option>
                        </select>
                        <i class="fas fa-chevron-down select-icon"></i>
                    </div>
                </div>

                <!-- Producto -->
                <div>
                    <label for="editProducto" class="block text-sm font-medium text-gray-700 mb-2">Producto/Material</label>
                    <div class="relative">
                        <i class="fas fa-box input-icon"></i>
                        <input type="text" id="editProducto" class="w-full pl-10 p-2.5 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200 rounded-lg" placeholder="Tipo de producto o material" required>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 justify-end mt-6">
                    <button type="button" id="cancelEditMaquinas" class="btn-secondary text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                    <button type="submit" class="btn-primary text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAc5V1vI3wZaNgzzf7rYv1MVEn7HYAuB58",
      authDomain: "gestion-de-silos.firebaseapp.com",
      databaseURL: "https://gestion-de-silos-default-rtdb.firebaseio.com",
      projectId: "gestion-de-silos",
      storageBucket: "gestion-de-silos.firebasestorage.app",
      messagingSenderId: "334228928393",
      appId: "1:334228928393:web:0206599afccafa40351358",
      measurementId: "G-QKN3J6LSW1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Constantes (ya no se usa el sistema de tiempo)
    // const LIMITE_TIEMPO = 24 * 60 * 60 * 1000; // Eliminado - ahora usamos estados por cambio de lote/producto
    // const WARNING_TIME = 12 * 60 * 60 * 1000; // Eliminado - no hay estado intermedio

    // Variables globales optimizadas
    let currentView = 'silos-lotes';
    let currentSubViewSilos = 'form';
    let currentSubViewMaquinas = 'form';
    let registrosSilos = [];
    let registrosMaquinas = [];
    let editingIndexSilos = -1;
    let editingIndexMaquinas = -1;
    let showExpiredSilos = false;
    let showExpiredMaquinas = false;

    // Variables para control de limpieza automática
    // let intervalLimpiezaSilos = null;
    // let intervalLimpiezaMaquinas = null;

    // Cache para optimización de performance
    const qrCodeCache = new Map();
    let searchTimeoutSilos = null;
    let searchTimeoutMaquinas = null;

    // Elementos del DOM
    let elements = {};

    // Función helper para limpiar códigos QR - Versión mejorada
    function limpiarCodigoParaQR(codigo) {
        if (!codigo || typeof codigo !== 'string') {
            return 'CODIGO-VACIO';
        }
        
        return codigo
            .replace(/\s+/g, '') // Eliminar todos los espacios
            .replace(/ñ/gi, 'n') // Reemplazar ñ por n
            .replace(/[áàäâ]/gi, 'a') // Reemplazar acentos a
            .replace(/[éèëê]/gi, 'e') // Reemplazar acentos e
            .replace(/[íìïî]/gi, 'i') // Reemplazar acentos i
            .replace(/[óòöô]/gi, 'o') // Reemplazar acentos o
            .replace(/[úùüû]/gi, 'u') // Reemplazar acentos u
            .replace(/[^A-Za-z0-9\-_]/g, '') // Mantener solo letras, números, guiones y guiones bajos
            .substring(0, 50) // Limitar longitud máxima
            .toUpperCase(); // Convertir a mayúsculas para consistencia
    }

    // Inicializar la aplicación - AHORA SE MANEJA EN EL SISTEMA DE LOGIN
    // document.addEventListener('DOMContentLoaded', function() {
    //     console.log('Sistema Integrado iniciado v2.3.0');
    //     initializeElements();
    //     initializeTheme();
    //     setupNavigation();
    //     setupSubNavigation();
    //     cargarRegistrosSilos();
    //     cargarRegistrosMaquinas();
    //     setupRealtimeSync();
    //     // iniciarLimpiezaAutomatica();
    //     actualizarTablaSilos();
    //     actualizarTablaMaquinas();
    //     actualizarEstadisticasSilos();
    //     actualizarEstadisticasMaquinas();
    //     setupEventListeners();
    //     updateCurrentTime();
    //     updateCurrentShift();
    //     setInterval(updateCurrentTime, 1000);
    //     setInterval(updateCurrentShift, 60000);
    // });

    function initializeElements() {
        // Elementos de navegación principal
        elements.tabSilosLotes = document.getElementById('tab-silos-lotes');
        elements.tabMaquinasSilos = document.getElementById('tab-maquinas-silos');
        elements.viewSilosLotes = document.getElementById('view-silos-lotes');
        elements.viewMaquinasSilos = document.getElementById('view-maquinas-silos');

        // Elementos de sub-navegación para Silos
        elements.subTabSilosForm = document.getElementById('sub-tab-silos-form');
        elements.subTabSilosPanel = document.getElementById('sub-tab-silos-panel');
        elements.subViewSilosForm = document.getElementById('sub-view-silos-form');
        elements.subViewSilosPanel = document.getElementById('sub-view-silos-panel');

        // Elementos de sub-navegación para Máquinas
        elements.subTabMaquinasForm = document.getElementById('sub-tab-maquinas-form');
        elements.subTabMaquinasPanel = document.getElementById('sub-tab-maquinas-panel');
        elements.subViewMaquinasForm = document.getElementById('sub-view-maquinas-form');
        elements.subViewMaquinasPanel = document.getElementById('sub-view-maquinas-panel');

        // Elementos para Silos y Lotes
        elements.siloForm = document.getElementById('siloForm');
        elements.registrosTableSilos = document.getElementById('registrosTableSilos');
        elements.searchInputSilos = document.getElementById('searchInputSilos');
        elements.clearSearchSilos = document.getElementById('clearSearchSilos');
        elements.clearStorageSilos = document.getElementById('clearStorageSilos');
        elements.activeCountSilos = document.getElementById('active-count-silos');
        elements.silosInUse = document.getElementById('silos-in-use');
        elements.lastRecordSilos = document.getElementById('last-record-silos');
        elements.tableInfoSilos = document.getElementById('table-info-silos');
        elements.exportCsvSilos = document.getElementById('export-csv-silos');
        elements.printReportSilos = document.getElementById('print-report-silos');
        elements.showExpiredSilos = document.getElementById('show-expired-silos');
        elements.hideExpiredSilos = document.getElementById('hide-expired-silos');
        elements.deleteAllExpiredSilos = document.getElementById('delete-all-expired-silos');
        elements.expiredPanelSilos = document.getElementById('expired-panel-silos');
        elements.registrosTableExpiredSilos = document.getElementById('registrosTableExpiredSilos');
        elements.searchInputExpiredSilos = document.getElementById('searchInputExpiredSilos');
        elements.clearSearchExpiredSilos = document.getElementById('clearSearchExpiredSilos');
        elements.tableInfoExpiredSilos = document.getElementById('table-info-expired-silos');
        elements.exportCsvExpiredSilos = document.getElementById('export-csv-expired-silos');
        elements.printReportExpiredSilos = document.getElementById('print-report-expired-silos');
        elements.workerTableSilos = document.getElementById('workerTableSilos');
        elements.workerTableInfoSilos = document.getElementById('worker-table-info-silos');
        elements.refreshWorkerDataSilos = document.getElementById('refresh-worker-data-silos');
        elements.workerPrintReportSilos = document.getElementById('worker-print-report-silos');

        // Elementos para Máquinas y Silos
        elements.maquinaForm = document.getElementById('maquinaForm');
        elements.registrosTableMaquinas = document.getElementById('registrosTableMaquinas');
        elements.searchInputMaquinas = document.getElementById('searchInputMaquinas');
        elements.clearSearchMaquinas = document.getElementById('clearSearchMaquinas');
        elements.clearStorageMaquinas = document.getElementById('clearStorageMaquinas');
        elements.activeCountMaquinas = document.getElementById('active-count-maquinas');
        elements.machinesInUse = document.getElementById('machines-in-use');
        elements.lastRecordMaquinas = document.getElementById('last-record-maquinas');
        elements.tableInfoMaquinas = document.getElementById('table-info-maquinas');
        elements.exportCsvMaquinas = document.getElementById('export-csv-maquinas');
        elements.printReportMaquinas = document.getElementById('print-report-maquinas');
        elements.showExpiredMaquinas = document.getElementById('show-expired-maquinas');
        elements.hideExpiredMaquinas = document.getElementById('hide-expired-maquinas');
        elements.deleteAllExpiredMaquinas = document.getElementById('delete-all-expired-maquinas');
        elements.expiredPanelMaquinas = document.getElementById('expired-panel-maquinas');
        elements.registrosTableExpiredMaquinas = document.getElementById('registrosTableExpiredMaquinas');
        elements.searchInputExpiredMaquinas = document.getElementById('searchInputExpiredMaquinas');
        elements.clearSearchExpiredMaquinas = document.getElementById('clearSearchExpiredMaquinas');
        elements.tableInfoExpiredMaquinas = document.getElementById('table-info-expired-maquinas');
        elements.exportCsvExpiredMaquinas = document.getElementById('export-csv-expired-maquinas');
        elements.printReportExpiredMaquinas = document.getElementById('print-report-expired-maquinas');
        elements.workerTableMaquinas = document.getElementById('workerTableMaquinas');
        elements.workerTableInfoMaquinas = document.getElementById('worker-table-info-maquinas');
        elements.refreshWorkerDataMaquinas = document.getElementById('refresh-worker-data-maquinas');
        elements.workerPrintReportMaquinas = document.getElementById('worker-print-report-maquinas');

        // Elementos compartidos
        elements.barcodeModal = document.getElementById('barcodeModal');
        elements.modalBarcode = document.getElementById('modalBarcode');
        elements.closeModal = document.getElementById('closeModal');
        elements.printBarcode = document.getElementById('printBarcode');
        elements.downloadBarcode = document.getElementById('downloadBarcode');
        elements.currentTimeEl = document.getElementById('current-time');
        elements.currentShiftEl = document.getElementById('current-shift');
        elements.currentShiftMaquinasEl = document.getElementById('current-shift-maquinas');

        // Elementos de modales de edición
        elements.editModalSilos = document.getElementById('editModalSilos');
        elements.editFormSilos = document.getElementById('editFormSilos');
        elements.closeEditModalSilos = document.getElementById('closeEditModalSilos');
        elements.cancelEditSilos = document.getElementById('cancelEditSilos');

        elements.editModalMaquinas = document.getElementById('editModalMaquinas');
        elements.editFormMaquinas = document.getElementById('editFormMaquinas');
        elements.closeEditModalMaquinas = document.getElementById('closeEditModalMaquinas');
        elements.cancelEditMaquinas = document.getElementById('cancelEditMaquinas');

        console.log('Elementos DOM inicializados');
    }

    // Función para inicializar el tema
    function initializeTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        
        // Obtener tema guardado o usar claro por defecto
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        
        // Event listener para el botón de tema
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                console.log('🎨 Toggle tema clickeado');
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                console.log('Cambiando de', currentTheme, 'a', newTheme);
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Animación del botón
                themeToggle.classList.add('animate-bounce-in');
                setTimeout(() => themeToggle.classList.remove('animate-bounce-in'), 600);
            });
        } else {
            console.error('❌ Elemento theme-toggle no encontrado');
        }
        
        function applyTheme(theme) {
            console.log('🎨 Aplicando tema:', theme);
            
            // Aplicar tema al documento
            document.documentElement.setAttribute('data-theme', theme);
            
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.body.classList.add('dark-mode');
                if (themeIcon) themeIcon.className = 'fas fa-moon mr-1';
                if (themeText) themeText.textContent = 'Oscuro';
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('dark-mode');
                if (themeIcon) themeIcon.className = 'fas fa-sun mr-1';
                if (themeText) themeText.textContent = 'Claro';
            }
            
            // Forzar re-renderizado
            document.body.style.display = 'none';
            document.body.offsetHeight; // Trigger reflow
            document.body.style.display = '';
            
            console.log('✅ Tema aplicado correctamente');
        }
    }

    function setupNavigation() {
        elements.tabSilosLotes.addEventListener('click', function() {
            switchView('silos-lotes');
        });

        elements.tabMaquinasSilos.addEventListener('click', function() {
            switchView('maquinas-silos');
        });
    }

    function setupSubNavigation() {
        // Sub-navegación para Silos y Lotes
        if (elements.subTabSilosForm) {
            elements.subTabSilosForm.addEventListener('click', function() {
                switchSubView('silos', 'form');
            });
        }

        if (elements.subTabSilosPanel) {
            elements.subTabSilosPanel.addEventListener('click', function() {
                switchSubView('silos', 'panel');
            });
        }

        // Sub-navegación para Máquinas y Silos
        if (elements.subTabMaquinasForm) {
            elements.subTabMaquinasForm.addEventListener('click', function() {
                switchSubView('maquinas', 'form');
            });
        }

        if (elements.subTabMaquinasPanel) {
            elements.subTabMaquinasPanel.addEventListener('click', function() {
                switchSubView('maquinas', 'panel');
            });
        }

        // Navegación específica dentro de los paneles (solo desktop)
        const panelNavSilosForm = document.getElementById('panel-nav-silos-form');
        if (panelNavSilosForm) {
            panelNavSilosForm.addEventListener('click', function() {
                switchSubView('silos', 'form');
            });
        }

        const panelNavSilosPanel = document.getElementById('panel-nav-silos-panel');
        if (panelNavSilosPanel) {
            panelNavSilosPanel.addEventListener('click', function() {
                switchSubView('silos', 'panel');
            });
        }

        const panelNavMaquinasForm = document.getElementById('panel-nav-maquinas-form');
        if (panelNavMaquinasForm) {
            panelNavMaquinasForm.addEventListener('click', function() {
                switchSubView('maquinas', 'form');
            });
        }

        const panelNavMaquinasPanel = document.getElementById('panel-nav-maquinas-panel');
        if (panelNavMaquinasPanel) {
            panelNavMaquinasPanel.addEventListener('click', function() {
                switchSubView('maquinas', 'panel');
            });
        }
    }

    function switchView(view) {
        // Verificar permisos antes de cambiar vista
        if (isWorker() && view === 'maquinas-silos') {
            console.log('[PERMISOS] Trabajador intenta acceder a gestión de máquinas - DENEGADO');
            showNotification('Acceso denegado. Los trabajadores solo pueden registrar lotes en silos.', 'error');
            return;
        }
        
        // Actualizar pestañas activas
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Ocultar todas las vistas
        document.querySelectorAll('.view-container').forEach(container => {
            container.classList.remove('active');
            container.style.display = 'none';
        });

        // Mostrar vista seleccionada
        if (view === 'silos-lotes') {
            elements.tabSilosLotes.classList.add('active');
            elements.viewSilosLotes.style.display = 'block';
            setTimeout(() => {
                elements.viewSilosLotes.classList.add('active');
            }, 50);
            currentView = 'silos-lotes';
        } else if (view === 'maquinas-silos') {
            elements.tabMaquinasSilos.classList.add('active');
            elements.viewMaquinasSilos.style.display = 'block';
            setTimeout(() => {
                elements.viewMaquinasSilos.classList.add('active');
            }, 50);
            currentView = 'maquinas-silos';
        }
    }

    function switchSubView(section, subView) {
        // Verificar permisos para trabajadores en cambio de sub-vista
        if (isWorker() && subView === 'panel') {
            console.log('[PERMISOS] Trabajador intenta acceder al panel de gestión - DENEGADO');
            showNotification('Acceso denegado. Los trabajadores solo pueden registrar lotes.', 'error');
            return;
        }
        
        if (section === 'silos') {
            // Actualizar pestañas de sub-navegación principal
            document.querySelectorAll('#sub-tab-silos-form, #sub-tab-silos-panel').forEach(tab => {
                tab.classList.remove('active');
            });

            // Actualizar pestañas de navegación interna del panel (desktop)
            document.querySelectorAll('#panel-nav-silos-form, #panel-nav-silos-panel').forEach(tab => {
                tab.classList.remove('active');
            });

            // Ocultar todas las sub-vistas
            document.querySelectorAll('#sub-view-silos-form, #sub-view-silos-panel').forEach(container => {
                container.classList.remove('active');
            });

            // Controlar visibilidad de las secciones principales
            const mainTableSection = document.querySelector('#view-silos-lotes .lg\\:col-span-2');
            
            // Mostrar sub-vista seleccionada
            if (subView === 'form') {
                elements.subTabSilosForm.classList.add('active');
                elements.subViewSilosForm.classList.add('active');
                // Activar navegación interna del panel si existe
                const panelNavForm = document.getElementById('panel-nav-silos-form');
                if (panelNavForm) panelNavForm.classList.add('active');
                currentSubViewSilos = 'form';
                // Mostrar tabla de registros en modo formulario
                if (mainTableSection) {
                    mainTableSection.style.display = 'block';
                }
            } else if (subView === 'panel') {
                elements.subTabSilosPanel.classList.add('active');
                elements.subViewSilosPanel.classList.add('active');
                // Activar navegación interna del panel si existe
                const panelNavPanel = document.getElementById('panel-nav-silos-panel');
                if (panelNavPanel) panelNavPanel.classList.add('active');
                currentSubViewSilos = 'panel';
                // Ocultar tabla de registros en modo panel
                if (mainTableSection) {
                    mainTableSection.style.display = 'none';
                }
                // Actualizar tabla de workers al cambiar a panel
                actualizarTablaWorkersSilos();
            }
        } else if (section === 'maquinas') {
            // Actualizar pestañas de sub-navegación principal
            document.querySelectorAll('#sub-tab-maquinas-form, #sub-tab-maquinas-panel').forEach(tab => {
                tab.classList.remove('active');
            });

            // Actualizar pestañas de navegación interna del panel (desktop)
            document.querySelectorAll('#panel-nav-maquinas-form, #panel-nav-maquinas-panel').forEach(tab => {
                tab.classList.remove('active');
            });

            // Ocultar todas las sub-vistas
            document.querySelectorAll('#sub-view-maquinas-form, #sub-view-maquinas-panel').forEach(container => {
                container.classList.remove('active');
            });

            // Controlar visibilidad de las secciones principales
            const mainTableSection = document.querySelector('#view-maquinas-silos .lg\\:col-span-2');

            // Mostrar sub-vista seleccionada
            if (subView === 'form') {
                elements.subTabMaquinasForm.classList.add('active');
                elements.subViewMaquinasForm.classList.add('active');
                // Activar navegación interna del panel si existe
                const panelNavForm = document.getElementById('panel-nav-maquinas-form');
                if (panelNavForm) panelNavForm.classList.add('active');
                currentSubViewMaquinas = 'form';
                // Mostrar tabla de registros en modo formulario
                if (mainTableSection) {
                    mainTableSection.style.display = 'block';
                }
            } else if (subView === 'panel') {
                elements.subTabMaquinasPanel.classList.add('active');
                elements.subViewMaquinasPanel.classList.add('active');
                // Activar navegación interna del panel si existe
                const panelNavPanel = document.getElementById('panel-nav-maquinas-panel');
                if (panelNavPanel) panelNavPanel.classList.add('active');
                currentSubViewMaquinas = 'panel';
                // Ocultar tabla de registros en modo panel
                if (mainTableSection) {
                    mainTableSection.style.display = 'none';
                }
                // Actualizar tabla de workers al cambiar a panel
                actualizarTablaWorkersMaquinas();
            }
        }
    }

    function cargarRegistrosSilos() {
        try {
            const registrosRef = database.ref('siloRegistros');
            registrosRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    registrosSilos = Object.values(data).filter(item => 
                        item && item.lote && item.silo && item.maquina && item.fecha && item.timestamp
                    );
                    
                    // Inicializar estados para registros existentes que no tienen el campo estado
                    registrosSilos.forEach(registro => {
                        if (!registro.estado) {
                            registro.estado = 'activo'; // Por defecto, los registros existentes se marcan como activos
                        }
                    });
                    
                    console.log('Registros de silos cargados desde Firebase:', registrosSilos);
                    // limpiarRegistrosExpiradosSilos();
                } else {
                    console.log('No hay registros de silos en Firebase');
                    registrosSilos = [];
                }
                actualizarTablaSilos();
                actualizarTablaWorkersSilos();
                actualizarEstadisticasSilos();
            }, (error) => {
                console.error('Error al cargar registros de silos:', error);
                mostrarAlerta('Error al leer los registros de silos.', 'error');
                registrosSilos = [];
                actualizarTablaSilos();
                actualizarTablaWorkersSilos();
                actualizarEstadisticasSilos();
            });
        } catch (error) {
            console.error('Error general al cargar registros de silos:', error);
            registrosSilos = [];
            actualizarTablaSilos();
            actualizarTablaWorkersSilos();
            actualizarEstadisticasSilos();
        }
    }

    function cargarRegistrosMaquinas() {
        try {
            const registrosRef = database.ref('maquinaSiloRegistros');
            registrosRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    registrosMaquinas = Object.values(data).filter(item => 
                        item && item.maquina && item.silo && item.operador && item.fecha && item.timestamp
                    );
                    
                    // Inicializar estados para registros existentes que no tienen el campo estado
                    registrosMaquinas.forEach(registro => {
                        if (!registro.estado) {
                            registro.estado = 'activo'; // Por defecto, los registros existentes se marcan como activos
                        }
                    });
                    
                    console.log('Registros de máquinas cargados desde Firebase:', registrosMaquinas);
                    // limpiarRegistrosExpiradosMaquinas();
                } else {
                    console.log('No hay registros de máquinas en Firebase');
                    registrosMaquinas = [];
                }
                actualizarTablaMaquinas();
                actualizarTablaWorkersMaquinas();
                actualizarEstadisticasMaquinas();
            }, (error) => {
                console.error('Error al cargar registros de máquinas:', error);
                mostrarAlerta('Error al leer los registros de máquinas.', 'error');
                registrosMaquinas = [];
                actualizarTablaMaquinas();
                actualizarTablaWorkersMaquinas();
                actualizarEstadisticasMaquinas();
            });
        } catch (error) {
            console.error('Error general al cargar registros de máquinas:', error);
            registrosMaquinas = [];
            actualizarTablaMaquinas();
            actualizarTablaWorkersMaquinas();
            actualizarEstadisticasMaquinas();
        }
    }

    function guardarRegistrosSilos() {
        try {
            const registrosRef = database.ref('siloRegistros');
            const registrosObj = {};
            registrosSilos.forEach((registro, index) => {
                registrosObj[index] = registro;
            });
            registrosRef.set(registrosObj, (error) => {
            if (error) {
                    console.error('Error al guardar registros de silos:', error);
                    mostrarAlerta('Error al guardar los datos de silos.', 'error');
                } else {
                    console.log('Registros de silos guardados en Firebase:', registrosSilos.length);
                }
            });
        } catch (error) {
            console.error('Error general al guardar registros de silos:', error);
            mostrarAlerta('Error al guardar los datos de silos.', 'error');
        }
    }

    function guardarRegistrosMaquinas() {
        try {
            const registrosRef = database.ref('maquinaSiloRegistros');
            const registrosObj = {};
            registrosMaquinas.forEach((registro, index) => {
                registrosObj[index] = registro;
            });
            registrosRef.set(registrosObj, (error) => {
                if (error) {
                    console.error('Error al guardar registros de máquinas:', error);
                    mostrarAlerta('Error al guardar los datos de máquinas.', 'error');
                } else {
                    console.log('Registros de máquinas guardados en Firebase:', registrosMaquinas.length);
                }
            });
        } catch (error) {
            console.error('Error general al guardar registros de máquinas:', error);
            mostrarAlerta('Error al guardar los datos de máquinas.', 'error');
        }
    }

    function setupRealtimeSync() {
        // Sincronización para silos
        const registrosSilosRef = database.ref('siloRegistros');
        registrosSilosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                registrosSilos = Object.values(data).filter(item => 
                    item && item.lote && item.silo && item.maquina && item.fecha && item.timestamp
                );
            } else {
                registrosSilos = [];
            }
            actualizarTablaSilos();
            actualizarTablaWorkersSilos();
            actualizarEstadisticasSilos();
        }, (error) => {
            console.error('Error en sincronización de silos:', error);
        });

        // Sincronización para máquinas
        const registrosMaquinasRef = database.ref('maquinaSiloRegistros');
        registrosMaquinasRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                registrosMaquinas = Object.values(data).filter(item => 
                    item && item.maquina && item.silo && item.operador && item.fecha && item.timestamp
                );
            } else {
                registrosMaquinas = [];
            }
            actualizarTablaMaquinas();
            actualizarTablaWorkersMaquinas();
            actualizarEstadisticasMaquinas();
        }, (error) => {
            console.error('Error en sincronización de máquinas:', error);
        });
    }

    // function iniciarLimpiezaAutomatica() {
    //     console.log('Iniciando sistema de limpieza automática...');
        
    //     // Limpiar intervalos anteriores si existen
    //     if (intervalLimpiezaSilos) {
    //         clearInterval(intervalLimpiezaSilos);
    //     }
    //     if (intervalLimpiezaMaquinas) {
    //         clearInterval(intervalLimpiezaMaquinas);
    //     }

    //     // Ejecutar limpieza cada 5 minutos
    //     intervalLimpiezaSilos = setInterval(() => {
    //         console.log('Ejecutando limpieza automática de silos...');
    //         limpiarRegistrosExpiradosSilos();
    //     }, 5 * 60 * 1000);

    //     intervalLimpiezaMaquinas = setInterval(() => {
    //         console.log('Ejecutando limpieza automática de máquinas...');
    //         limpiarRegistrosExpiradosMaquinas();
    //     }, 5 * 60 * 1000);

    //     console.log('Sistema de limpieza automática iniciado correctamente');
    // }

    function limpiarRegistrosExpiradosSilos() {
        // const ahora = new Date().getTime();
        // const registrosOriginales = registrosSilos.length;

        // const registrosValidos = registrosSilos.filter(registro => {
        //     if (!registro.timestamp) {
        //         return false;
        //     }
        //     const tiempoTranscurrido = ahora - registro.timestamp;
        //     return tiempoTranscurrido < LIMITE_TIEMPO;
        // });

        // if (registrosValidos.length !== registrosOriginales) {
        //     const eliminados = registrosOriginales - registrosValidos.length;
        //     console.log(`Limpieza de silos completada: ${eliminados} registros eliminados`);
        //     registrosSilos = registrosValidos;
        //     guardarRegistrosSilos();
        //     actualizarTablaSilos();
        //     actualizarTablaWorkersSilos();
        //     actualizarEstadisticasSilos();
        //     if (eliminados > 0) {
        //         mostrarAlerta(`Se eliminaron ${eliminados} registro(s) de silos expirado(s).`, 'info');
        //     }
        // }
    }

    // Nueva función para marcar registros como expirados cuando cambia el lote en un silo
    function marcarExpiradosPorCambioLote(siloActual, loteNuevo) {
        registrosSilos.forEach(registro => {
            // Si es del mismo silo pero diferente lote, y está activo, marcarlo como expirado
            if (registro.silo === siloActual && registro.lote !== loteNuevo && registro.estado === 'activo') {
                registro.estado = 'expirado';
            }
        });
    }

    // Nueva función para marcar registros como expirados cuando cambia el producto en una máquina
    function marcarExpiradosPorCambioProducto(maquinaActual, productoNuevo) {
        registrosMaquinas.forEach(registro => {
            // Si es de la misma máquina pero diferente producto, y está activo, marcarlo como expirado
            if (registro.maquina === maquinaActual && registro.producto !== productoNuevo && registro.estado === 'activo') {
                registro.estado = 'expirado';
            }
        });
    }

    // Nueva función para marcar registros como expirados cuando una máquina cambia de silo
    function marcarExpiradosPorCambioSiloEnMaquina(maquinaActual, siloNuevo) {
        let registrosExpirados = 0;
        registrosSilos.forEach(registro => {
            // Si es de la misma máquina pero diferente silo, y está activo, marcarlo como expirado
            if (registro.maquina === maquinaActual && registro.silo !== siloNuevo && registro.estado === 'activo') {
                registro.estado = 'expirado';
                registrosExpirados++;
                console.log(`Marcando como expirado: Máquina ${maquinaActual} cambió del Silo ${registro.silo} al Silo ${siloNuevo} (Lote: ${registro.lote})`);
            }
        });
        
        if (registrosExpirados > 0) {
            console.log(`Total registros expirados por cambio de silo en Máquina ${maquinaActual}: ${registrosExpirados}`);
        }
    }

    function limpiarRegistrosExpiradosMaquinas() {
        // const ahora = new Date().getTime();
        // const registrosOriginales = registrosMaquinas.length;

        // const registrosValidos = registrosMaquinas.filter(registro => {
        //     if (!registro.timestamp) {
        //         return false;
        //     }
        //     const tiempoTranscurrido = ahora - registro.timestamp;
        //     return tiempoTranscurrido < LIMITE_TIEMPO;
        // });

        // if (registrosValidos.length !== registrosOriginales) {
        //     const eliminados = registrosOriginales - registrosValidos.length;
        //     console.log(`Limpieza de máquinas completada: ${eliminados} registros eliminados`);
        //     registrosMaquinas = registrosValidos;
        //     guardarRegistrosMaquinas();
        //     actualizarTablaMaquinas();
        //     actualizarTablaWorkersMaquinas();
        //     actualizarEstadisticasMaquinas();
        //     if (eliminados > 0) {
        //         mostrarAlerta(`Se eliminaron ${eliminados} registro(s) de máquinas expirado(s).`, 'info');
        //     }
        // }
    }

    function setupEventListeners() {
        // Formulario de silos y lotes
        if (elements.siloForm) {
            elements.siloForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const lote = document.getElementById('lote').value.trim();
                const silo = document.getElementById('silo').value;
                const maquina = document.getElementById('maquina').value;

                if (!lote || !silo || !maquina) {
                    mostrarAlerta('Por favor complete todos los campos', 'warning');
                    return;
                }

                if (lote.length < 2) {
                    mostrarAlerta('El número de lote debe tener al menos 2 caracteres', 'error');
                    return;
                }

                const existe = registrosSilos.some(r => r.lote === lote && r.silo === silo && r.maquina === maquina);
                if (existe) {
                    mostrarAlerta('Esta combinación de lote, silo y máquina ya está registrada.', 'warning');
                    return;
                }

                const fecha = new Date().toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timestamp = new Date().getTime();

                // Marcar como expirados todos los registros anteriores del mismo silo con lote diferente
                marcarExpiradosPorCambioLote(silo, lote);
                
                // Marcar como expirados todos los registros anteriores de la misma máquina en diferente silo
                marcarExpiradosPorCambioSiloEnMaquina(maquina, silo);

                const registro = { lote, silo, maquina, fecha, timestamp, estado: 'activo' };
                registrosSilos.push(registro);

                guardarRegistrosSilos();
                actualizarTablaSilos();
                actualizarTablaWorkersSilos();
                actualizarEstadisticasSilos();
                elements.siloForm.reset();
                mostrarAlerta('Lote registrado correctamente', 'success');

                // setTimeout(() => {
                //     limpiarRegistrosExpiradosSilos();
                // }, 1000);
            });
        }

        // Formulario de máquinas y silos
        if (elements.maquinaForm) {
            elements.maquinaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const maquina = document.getElementById('maquinaMaq').value;
                const silo = document.getElementById('siloMaq').value;
                const operador = document.getElementById('operador').value.trim();
                const turno = document.getElementById('turno').value;
                const producto = document.getElementById('producto').value.trim();

                if (!maquina || !silo || !operador || !turno || !producto) {
                    mostrarAlerta('Por favor complete todos los campos', 'warning');
                    return;
                }

                if (operador.length < 2) {
                    mostrarAlerta('El nombre del operador debe tener al menos 2 caracteres', 'error');
                    return;
                }

                if (producto.length < 2) {
                    mostrarAlerta('El producto debe tener al menos 2 caracteres', 'error');
                    return;
                }

                const existe = registrosMaquinas.some(r => r.maquina === maquina && r.silo === silo);
                if (existe) {
                    mostrarAlerta('Ya existe una operación activa para esta máquina y silo.', 'warning');
                    return;
                }

                const fecha = new Date().toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timestamp = new Date().getTime();

                // Marcar como expirados todos los registros anteriores de la misma máquina con producto diferente
                marcarExpiradosPorCambioProducto(maquina, producto);

                const registro = { maquina, silo, operador, turno, producto, fecha, timestamp, estado: 'activo' };
                registrosMaquinas.push(registro);

                guardarRegistrosMaquinas();
                actualizarTablaMaquinas();
                actualizarTablaWorkersMaquinas();
                actualizarEstadisticasMaquinas();
                elements.maquinaForm.reset();
                mostrarAlerta('Operación registrada correctamente.', 'success');

                // setTimeout(() => {
                //     limpiarRegistrosExpiradosMaquinas();
                // }, 1000);
            });
        }

        // Búsqueda para silos con debounce
        if (elements.searchInputSilos) {
            elements.searchInputSilos.addEventListener('input', function() {
                // Limpiar timeout anterior
                if (searchTimeoutSilos) {
                    clearTimeout(searchTimeoutSilos);
                }
                
                if (elements.searchInputSilos.value.length > 0) {
                    elements.clearSearchSilos.classList.remove('hidden');
                } else {
                    elements.clearSearchSilos.classList.add('hidden');
                }
                
                // Aplicar debounce para mejor performance
                searchTimeoutSilos = setTimeout(() => {
                    actualizarTablaSilos();
                }, 300);
            });
            
            // Búsqueda inmediata con Enter
            elements.searchInputSilos.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    if (searchTimeoutSilos) {
                        clearTimeout(searchTimeoutSilos);
                    }
                    actualizarTablaSilos();
                }
            });
        }

        if (elements.clearSearchSilos) {
            elements.clearSearchSilos.addEventListener('click', function() {
                elements.searchInputSilos.value = '';
                elements.clearSearchSilos.classList.add('hidden');
                actualizarTablaSilos();
                elements.searchInputSilos.focus();
            });
        }

        // Búsqueda para máquinas con debounce
        if (elements.searchInputMaquinas) {
            elements.searchInputMaquinas.addEventListener('input', function() {
                // Limpiar timeout anterior
                if (searchTimeoutMaquinas) {
                    clearTimeout(searchTimeoutMaquinas);
                }
                
                if (elements.searchInputMaquinas.value.length > 0) {
                    elements.clearSearchMaquinas.classList.remove('hidden');
                } else {
                    elements.clearSearchMaquinas.classList.add('hidden');
                }
                
                // Aplicar debounce para mejor performance
                searchTimeoutMaquinas = setTimeout(() => {
                    actualizarTablaMaquinas();
                }, 300);
            });
            
            // Búsqueda inmediata con Enter
            elements.searchInputMaquinas.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    if (searchTimeoutMaquinas) {
                        clearTimeout(searchTimeoutMaquinas);
                    }
                    actualizarTablaMaquinas();
                }
            });
        }

        if (elements.clearSearchMaquinas) {
            elements.clearSearchMaquinas.addEventListener('click', function() {
                elements.searchInputMaquinas.value = '';
                elements.clearSearchMaquinas.classList.add('hidden');
                actualizarTablaMaquinas();
                elements.searchInputMaquinas.focus();
            });
        }

        // Limpiar almacenamiento
        if (elements.clearStorageSilos) {
            elements.clearStorageSilos.addEventListener('click', function() {
                if (!hasPermission('delete_records')) {
                    mostrarAlerta('No tienes permisos para eliminar todos los registros.', 'error');
                    return;
                }
                mostrarConfirmacion(
                    '¿Está seguro de borrar todos los registros de silos?',
                    'Esta acción no se puede deshacer y eliminará todos los datos de silos almacenados.',
                    function() {
                        registrosSilos = [];
                        guardarRegistrosSilos();
                        actualizarTablaSilos();
                        actualizarTablaWorkersSilos();
                        actualizarEstadisticasSilos();
                        mostrarAlerta('Todos los registros de silos han sido eliminados.', 'success');
                    }
                );
            });
        }

        if (elements.clearStorageMaquinas) {
            elements.clearStorageMaquinas.addEventListener('click', function() {
                if (!hasPermission('delete_records')) {
                    mostrarAlerta('No tienes permisos para eliminar todos los registros.', 'error');
                    return;
                }
                mostrarConfirmacion(
                    '¿Está seguro de borrar todos los registros de máquinas?',
                    'Esta acción no se puede deshacer y eliminará todos los datos de máquinas almacenados.',
                    function() {
                        registrosMaquinas = [];
                        guardarRegistrosMaquinas();
                        actualizarTablaMaquinas();
                        actualizarTablaWorkersMaquinas();
                        actualizarEstadisticasMaquinas();
                        mostrarAlerta('Todos los registros de máquinas han sido eliminados.', 'success');
                    }
                );
            });
        }

        // Modal de código de barras
        if (elements.closeModal) {
            elements.closeModal.addEventListener('click', function() {
                elements.barcodeModal.classList.add('hidden');
            });
        }

        if (elements.barcodeModal) {
            elements.barcodeModal.addEventListener('click', function(e) {
                if (e.target === elements.barcodeModal) {
                    elements.barcodeModal.classList.add('hidden');
                }
            });
        }

        if (elements.printBarcode) {
            elements.printBarcode.addEventListener('click', function() {
                imprimirCodigoBarras();
            });
        }

        if (elements.downloadBarcode) {
            elements.downloadBarcode.addEventListener('click', function() {
                descargarCodigoBarras();
            });
        }

        // Funciones para limpiar formularios de edición
        function clearEditFormSilos() {
            document.getElementById('editLote').value = '';
            document.getElementById('editSilo').value = '';
            document.getElementById('editMaquina').value = '';
        }

        function clearEditFormMaquinas() {
            document.getElementById('editMaquinaMaq').value = '';
            document.getElementById('editSiloMaq').value = '';
            document.getElementById('editOperador').value = '';
            document.getElementById('editTurno').value = '';
            document.getElementById('editProducto').value = '';
        }

        // Modales de edición para silos
        if (elements.closeEditModalSilos) {
            elements.closeEditModalSilos.addEventListener('click', function() {
                elements.editModalSilos.classList.add('hidden');
                editingIndexSilos = -1;
                clearEditFormSilos();
            });
        }

        if (elements.cancelEditSilos) {
            elements.cancelEditSilos.addEventListener('click', function() {
                elements.editModalSilos.classList.add('hidden');
                editingIndexSilos = -1;
                clearEditFormSilos();
            });
        }

        if (elements.editModalSilos) {
            elements.editModalSilos.addEventListener('click', function(e) {
                if (e.target === elements.editModalSilos) {
                    elements.editModalSilos.classList.add('hidden');
                    editingIndexSilos = -1;
                    clearEditFormSilos();
                }
            });
        }

        if (elements.editFormSilos) {
            elements.editFormSilos.addEventListener('submit', function(e) {
                e.preventDefault();
                const lote = document.getElementById('editLote').value.trim();
                const silo = document.getElementById('editSilo').value;
                const maquina = document.getElementById('editMaquina').value;

                if (!lote || !silo || !maquina) {
                    mostrarAlerta('Por favor complete todos los campos', 'warning');
                    return;
                }

                if (lote.length < 2) {
                    mostrarAlerta('El número de lote debe tener al menos 2 caracteres', 'error');
                    return;
                }

                const existe = registrosSilos.some((r, index) =>
                    index !== editingIndexSilos && r.lote === lote && r.silo === silo && r.maquina === maquina
                );
                if (existe) {
                    mostrarAlerta('Esta combinación de lote, silo y máquina ya está registrada.', 'warning');
                    return;
                }

                if (editingIndexSilos >= 0 && editingIndexSilos < registrosSilos.length) {
                    // Obtener valores anteriores para comparar cambios
                    const registroAnterior = registrosSilos[editingIndexSilos];
                    const loteAnterior = registroAnterior.lote;
                    const siloAnterior = registroAnterior.silo;
                    const maquinaAnterior = registroAnterior.maquina;
                    
                    // Si cambió el lote en el mismo silo, marcar otros lotes como expirados
                    if (siloAnterior === silo && loteAnterior !== lote) {
                        marcarExpiradosPorCambioLote(silo, lote);
                    }
                    
                    // Si cambió la máquina o el silo de la máquina, marcar registros anteriores como expirados
                    if (maquinaAnterior !== maquina || (maquinaAnterior === maquina && siloAnterior !== silo)) {
                        if (maquinaAnterior !== maquina) {
                            // Si cambió de máquina, marcar expirados los del silo anterior
                            marcarExpiradosPorCambioLote(siloAnterior, '');
                        }
                        // Marcar expirados los registros de la nueva máquina en otros silos
                        marcarExpiradosPorCambioSiloEnMaquina(maquina, silo);
                    }
                    
                    registrosSilos[editingIndexSilos].lote = lote;
                    registrosSilos[editingIndexSilos].silo = silo;
                    registrosSilos[editingIndexSilos].maquina = maquina;
                    
                    registrosSilos[editingIndexSilos].fecha = new Date().toLocaleString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    registrosSilos[editingIndexSilos].timestamp = new Date().getTime();
                    guardarRegistrosSilos();
                    actualizarTablaSilos();
                    actualizarTablaWorkersSilos();
                    actualizarEstadisticasSilos();

                    elements.editModalSilos.classList.add('hidden');
                    editingIndexSilos = -1;
                    clearEditFormSilos();
                    mostrarAlerta('Registro actualizado correctamente.', 'success');
                }
            });
        }

        // Modales de edición para máquinas
        if (elements.closeEditModalMaquinas) {
            elements.closeEditModalMaquinas.addEventListener('click', function() {
                elements.editModalMaquinas.classList.add('hidden');
                editingIndexMaquinas = -1;
                clearEditFormMaquinas();
            });
        }

        if (elements.cancelEditMaquinas) {
            elements.cancelEditMaquinas.addEventListener('click', function() {
                elements.editModalMaquinas.classList.add('hidden');
                editingIndexMaquinas = -1;
                clearEditFormMaquinas();
            });
        }

        if (elements.editModalMaquinas) {
            elements.editModalMaquinas.addEventListener('click', function(e) {
                if (e.target === elements.editModalMaquinas) {
                    elements.editModalMaquinas.classList.add('hidden');
                    editingIndexMaquinas = -1;
                    clearEditFormMaquinas();
                }
            });
        }

        if (elements.editFormMaquinas) {
            elements.editFormMaquinas.addEventListener('submit', function(e) {
                e.preventDefault();
                const maquina = document.getElementById('editMaquinaMaq').value;
                const silo = document.getElementById('editSiloMaq').value;
                const operador = document.getElementById('editOperador').value.trim();
                const turno = document.getElementById('editTurno').value;
                const producto = document.getElementById('editProducto').value.trim();

                if (!maquina || !silo || !operador || !turno || !producto) {
                    mostrarAlerta('Por favor complete todos los campos', 'warning');
                    return;
                }

                if (operador.length < 2) {
                    mostrarAlerta('El nombre del operador debe tener al menos 2 caracteres', 'error');
                    return;
                }

                if (producto.length < 2) {
                    mostrarAlerta('El producto debe tener al menos 2 caracteres', 'error');
                    return;
                }

                const existe = registrosMaquinas.some((r, index) =>
                    index !== editingIndexMaquinas && r.maquina === maquina && r.silo === silo
                );
                if (existe) {
                    mostrarAlerta('Ya existe una operación activa para esta máquina y silo.', 'warning');
                    return;
                }

                if (editingIndexMaquinas >= 0 && editingIndexMaquinas < registrosMaquinas.length) {
                    registrosMaquinas[editingIndexMaquinas].maquina = maquina;
                    registrosMaquinas[editingIndexMaquinas].silo = silo;
                    registrosMaquinas[editingIndexMaquinas].operador = operador;
                    registrosMaquinas[editingIndexMaquinas].turno = turno;
                    registrosMaquinas[editingIndexMaquinas].producto = producto;
                    
                    registrosMaquinas[editingIndexMaquinas].fecha = new Date().toLocaleString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    registrosMaquinas[editingIndexMaquinas].timestamp = new Date().getTime();

                    guardarRegistrosMaquinas();
                    actualizarTablaMaquinas();
                    actualizarTablaWorkersMaquinas();
                    actualizarEstadisticasMaquinas();

                    elements.editModalMaquinas.classList.add('hidden');
                    editingIndexMaquinas = -1;
                    clearEditFormMaquinas();
                    mostrarAlerta('Registro actualizado correctamente.', 'success');
                }
            });
        }

        // Exportar CSV
        if (elements.exportCsvSilos) {
            elements.exportCsvSilos.addEventListener('click', function() {
                console.log('[EVENT] Botón exportar CSV silos clickeado');
                console.log('[EVENT] Registros silos disponibles:', registrosSilos ? registrosSilos.length : 'undefined');
                exportarCSVSilos();
            });
        }

        // Mostrar/Ocultar Expirados Silos
        if (elements.showExpiredSilos) {
            elements.showExpiredSilos.addEventListener('click', function() {
                if (!hasPermission('view_expired')) {
                    mostrarAlerta('No tienes permisos para ver registros expirados.', 'error');
                    return;
                }
                console.log('[EVENT] Mostrar panel expirados silos');
                elements.expiredPanelSilos.style.display = 'block';
                actualizarTablaExpiredSilos();
            });
        }

        if (elements.hideExpiredSilos) {
            elements.hideExpiredSilos.addEventListener('click', function() {
                console.log('[EVENT] Ocultar panel expirados silos');
                elements.expiredPanelSilos.style.display = 'none';
            });
        }

        if (elements.deleteAllExpiredSilos) {
            elements.deleteAllExpiredSilos.addEventListener('click', function() {
                if (!hasPermission('delete_expired')) {
                    mostrarAlerta('No tienes permisos para eliminar registros expirados.', 'error');
                    return;
                }
                console.log('[EVENT] Eliminar todos los expirados silos');
                const expiradosCount = registrosSilos.filter(r => r.estado === 'expirado').length;
                
                if (expiradosCount === 0) {
                    mostrarAlerta('No hay registros expirados para eliminar.', 'warning');
                    return;
                }
                
                mostrarConfirmacion(
                    '¿Está seguro de eliminar TODOS los registros expirados?',
                    `Se eliminarán ${expiradosCount} registros expirados de forma permanente. Esta acción no se puede deshacer.`,
                    function() {
                        // Filtrar solo registros activos
                        registrosSilos = registrosSilos.filter(registro => registro.estado !== 'expirado');
                        guardarRegistrosSilos();
                        
                        // Actualizar todas las tablas
                        actualizarTablaSilos();
                        actualizarTablaExpiredSilos();
                        actualizarTablaWorkersSilos();
                        actualizarEstadisticasSilos();
                        
                        mostrarAlerta(`✅ Se eliminaron ${expiradosCount} registros expirados correctamente.`, 'success');
                        
                        // Ocultar panel si ya no hay expirados
                        if (registrosSilos.filter(r => r.estado === 'expirado').length === 0) {
                            elements.expiredPanelSilos.style.display = 'none';
                        }
                    }
                );
            });
        }

        if (elements.exportCsvMaquinas) {
            elements.exportCsvMaquinas.addEventListener('click', function() {
                console.log('[EVENT] Botón exportar CSV máquinas clickeado');
                console.log('[EVENT] Registros máquinas disponibles:', registrosMaquinas ? registrosMaquinas.length : 'undefined');
                exportarCSVMaquinas();
            });
        }

        // Mostrar/Ocultar Expirados Máquinas
        if (elements.showExpiredMaquinas) {
            elements.showExpiredMaquinas.addEventListener('click', function() {
                if (!hasPermission('view_expired')) {
                    mostrarAlerta('No tienes permisos para ver registros expirados.', 'error');
                    return;
                }
                console.log('[EVENT] Mostrar panel expirados máquinas');
                elements.expiredPanelMaquinas.style.display = 'block';
                actualizarTablaExpiredMaquinas();
            });
        }

        if (elements.hideExpiredMaquinas) {
            elements.hideExpiredMaquinas.addEventListener('click', function() {
                console.log('[EVENT] Ocultar panel expirados máquinas');
                elements.expiredPanelMaquinas.style.display = 'none';
            });
        }

        if (elements.deleteAllExpiredMaquinas) {
            elements.deleteAllExpiredMaquinas.addEventListener('click', function() {
                if (!hasPermission('delete_expired')) {
                    mostrarAlerta('No tienes permisos para eliminar registros expirados.', 'error');
                    return;
                }
                console.log('[EVENT] Eliminar todos los expirados máquinas');
                const expiradosCount = registrosMaquinas.filter(r => r.estado === 'expirado').length;
                
                if (expiradosCount === 0) {
                    mostrarAlerta('No hay registros expirados para eliminar.', 'warning');
                    return;
                }
                
                mostrarConfirmacion(
                    '¿Está seguro de eliminar TODOS los registros expirados?',
                    `Se eliminarán ${expiradosCount} registros expirados de forma permanente. Esta acción no se puede deshacer.`,
                    function() {
                        // Filtrar solo registros activos
                        registrosMaquinas = registrosMaquinas.filter(registro => registro.estado !== 'expirado');
                        guardarRegistrosMaquinas();
                        
                        // Actualizar todas las tablas
                        actualizarTablaMaquinas();
                        actualizarTablaExpiredMaquinas();
                        actualizarTablaWorkersMaquinas();
                        actualizarEstadisticasMaquinas();
                        
                        mostrarAlerta(`✅ Se eliminaron ${expiradosCount} registros expirados correctamente.`, 'success');
                        
                        // Ocultar panel si ya no hay expirados
                        if (registrosMaquinas.filter(r => r.estado === 'expirado').length === 0) {
                            elements.expiredPanelMaquinas.style.display = 'none';
                        }
                    }
                );
            });
        }

        // Imprimir reportes
        if (elements.printReportSilos) {
            elements.printReportSilos.addEventListener('click', function() {
                imprimirReporteSilos();
            });
        }

        if (elements.printReportMaquinas) {
            elements.printReportMaquinas.addEventListener('click', function() {
                imprimirReporteMaquinas();
            });
        }

        // Exportar CSV de expirados
        if (elements.exportCsvExpiredSilos) {
            elements.exportCsvExpiredSilos.addEventListener('click', function() {
                console.log('[EVENT] Botón exportar CSV expirados silos clickeado');
                exportarCSVExpiredSilos();
            });
        }

        if (elements.exportCsvExpiredMaquinas) {
            elements.exportCsvExpiredMaquinas.addEventListener('click', function() {
                console.log('[EVENT] Botón exportar CSV expirados máquinas clickeado');
                exportarCSVExpiredMaquinas();
            });
        }

        // Eventos para la tabla de trabajadores de silos
        if (elements.refreshWorkerDataSilos) {
            elements.refreshWorkerDataSilos.addEventListener('click', function() {
                actualizarTablaWorkersSilos();
                mostrarAlerta('Datos actualizados correctamente.', 'success');
            });
        }

        if (elements.workerPrintReportSilos) {
            elements.workerPrintReportSilos.addEventListener('click', function() {
                imprimirReporteWorkersSilos();
            });
        }

        // Eventos para la tabla de trabajadores de máquinas
        if (elements.refreshWorkerDataMaquinas) {
            elements.refreshWorkerDataMaquinas.addEventListener('click', function() {
                actualizarTablaWorkersMaquinas();
                mostrarAlerta('Datos actualizados correctamente.', 'success');
            });
        }

        if (elements.workerPrintReportMaquinas) {
            elements.workerPrintReportMaquinas.addEventListener('click', function() {
                imprimirReporteWorkersMaquinas();
            });
        }
    }

    // Continúa con todas las funciones restantes del sistema...
    // [Aquí van todas las funciones de mostrarRegistro, actualizar tablas, exportar, imprimir, etc.]
    // Por brevedad, incluyo solo las funciones principales

    function mostrarRegistroSilo(registro, index) {
        // Mostrar en tabla desktop
        if (!elements.registrosTableSilos) {
            console.error('registrosTableSilos no está disponible');
            return;
        }

        // Usar el nuevo sistema de estados basado en cambio de lote
        let estado = '';
        let estadoClase = '';
        let estadoBadge = '';

        if (registro.estado === 'expirado') {
            estado = 'Expirado';
            estadoClase = 'status-expired';
            estadoBadge = 'badge-expired';
        } else {
            estado = 'Activo';
            estadoClase = 'status-active';
            estadoBadge = 'badge-active';
        }

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML =  `
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">
                <span class="${estadoBadge} badge text-xs">
                    <span class="status-indicator ${estadoClase}"></span>
                    <span class="hidden sm:inline">${estado}</span>
                    <span class="sm:hidden">${estado.charAt(0)}</span>
                </span>
            </td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap hidden md:table-cell">${registro.maquina}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap hidden sm:table-cell">${registro.silo}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap font-medium text-gray-900">
                <div class="text-sm">${registro.lote}</div>
                <div class="text-xs text-gray-500 sm:hidden">${registro.silo} • ${registro.maquina}</div>
            </td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden lg:table-cell">${registro.fecha}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap hidden sm:table-cell">
                <button class="view-barcode action-btn action-btn-view text-xs">
                    <i class="fas fa-eye"></i> <span class="hidden md:inline">Ver</span>
                </button>
            </td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-1 sm:gap-2">
                    <button class="view-barcode action-btn action-btn-view sm:hidden text-xs p-2" title="Ver código">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="edit-btn action-btn action-btn-edit text-xs p-2" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn action-btn action-btn-delete text-xs p-2" title="Eliminar">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="print-btn action-btn action-btn-print hidden sm:inline-flex text-xs p-2" title="Imprimir">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </td>
        `;

        elements.registrosTableSilos.appendChild(row);

        // Crear tarjeta móvil
        const mobileCardsContainer = document.getElementById('registrosCardsSilos');
        if (mobileCardsContainer) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            
            const codigo = registro.lote + '-' + registro.silo;
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div class="mobile-card-title">${registro.maquina} - ${registro.silo} - ${registro.lote}</div>
                    <span class="mobile-status-badge ${estadoBadge}">${estado}</span>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-field">
                        <div class="mobile-field-label">Máquina</div>
                        <div class="mobile-field-value">${registro.maquina}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Silo</div>
                        <div class="mobile-field-value">${registro.silo}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Lote</div>
                        <div class="mobile-field-value">${registro.lote}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Hora</div>
                        <div class="mobile-field-value">${new Date(registro.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Fecha</div>
                        <div class="mobile-field-value">${registro.fecha}</div>
                    </div>
                    <div class="mobile-field mobile-field-full">
                        <div class="mobile-field-label">Código</div>
                        <div class="mobile-field-value" style="font-family: monospace;">${codigo}</div>
                    </div>
                </div>
                <div class="mobile-actions">
                    <div class="mobile-qr-code mobile-view-barcode" data-codigo="${codigo}" title="Ver QR">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="mobile-actions-buttons">
                        <button class="mobile-action-btn mobile-edit-btn" style="background: #3b82f6; color: white;" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="mobile-action-btn mobile-delete-btn" style="background: #ef4444; color: white;" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="mobile-action-btn mobile-print-btn" style="background: #10b981; color: white;" title="Imprimir">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>
            `;
            
            mobileCardsContainer.appendChild(card);
            
            // Eventos para la tarjeta móvil
            card.querySelector('.mobile-view-barcode').addEventListener('click', function() {
                const codigo = this.getAttribute('data-codigo');
                try {
                    JsBarcode(elements.modalBarcode, codigo, {
                        format: "CODE128",
                        width: 2,
                        height: 60,
                        displayValue: false,
                        fontSize: 14,
                        margin: 15,
                        background: "#ffffff",
                        lineColor: "#000000"
                    });
                    document.getElementById('barcodeText').textContent = codigo;
                    document.getElementById('generationTime').textContent = new Date().toLocaleTimeString('es-ES');
                    elements.barcodeModal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error generando código de barras:', error);
                    mostrarAlerta('Error al generar el código de barras.', 'error');
                }
            });
            
            card.querySelector('.mobile-edit-btn').addEventListener('click', function() {
                editingIndexSilos = index;
                document.getElementById('editLote').value = registro.lote;
                document.getElementById('editSilo').value = registro.silo;
                document.getElementById('editMaquina').value = registro.maquina;
                elements.editModalSilos.classList.remove('hidden');
                
                // Seleccionar automáticamente el texto del campo lote para facilitar el escaneo
                setTimeout(() => {
                    const editLoteField = document.getElementById('editLote');
                    if (editLoteField) {
                        editLoteField.focus();
                        editLoteField.select();
                    }
                }, 100);
            });
            
            card.querySelector('.mobile-delete-btn').addEventListener('click', function() {
                mostrarConfirmacion(
                    '¿Está seguro de eliminar este registro?',
                    `Se eliminará el registro del lote "${registro.lote}" en "${registro.silo}".`,
                    function() {
                        registrosSilos.splice(index, 1);
                        guardarRegistrosSilos();
                        actualizarTablaSilos();
                        actualizarTablaWorkersSilos();
                        actualizarEstadisticasSilos();
                        mostrarAlerta('Registro eliminado correctamente.', 'success');
                    }
                );
            });
            
            card.querySelector('.mobile-print-btn').addEventListener('click', function() {
                imprimirCodigoIndividualSilo(registro);
            });
        }

        // Eventos para los botones de la fila desktop
        row.querySelector('.view-barcode').addEventListener('click', function() {
            try {
                if (typeof JsBarcode !== 'undefined' && elements.modalBarcode) {
                    const codigo = registro.lote + '-' + registro.silo;
                    JsBarcode(elements.modalBarcode, codigo, {
                        format: "CODE128",
                        width: 2,
                        height: 60,
                        displayValue: false,
                        fontSize: 14,
                        margin: 15,
                        background: "#ffffff",
                        lineColor: "#000000"
                    });

                    document.getElementById('barcodeText').textContent = codigo;
                    document.getElementById('generationTime').textContent = new Date().toLocaleTimeString('es-ES');
                    elements.barcodeModal.classList.remove('hidden');
                } else {
                    console.error('JsBarcode no está disponible o modalBarcode no existe');
                    mostrarAlerta('Error al generar el código de barras', 'error');
                }
            } catch (error) {
                console.error("Error mostrando código de barras:", error);
                mostrarAlerta('Error al generar el código de barras', 'error');
            }
        });

        row.querySelector('.edit-btn').addEventListener('click', function() {
            editingIndexSilos = index;
            document.getElementById('editLote').value = registro.lote;
            document.getElementById('editSilo').value = registro.silo;
            document.getElementById('editMaquina').value = registro.maquina;
            elements.editModalSilos.classList.remove('hidden');
            
            // Seleccionar automáticamente el texto del campo lote para facilitar el escaneo
            setTimeout(() => {
                const editLoteField = document.getElementById('editLote');
                if (editLoteField) {
                    editLoteField.focus();
                    editLoteField.select();
                }
            }, 100);
        });

        row.querySelector('.delete-btn').addEventListener('click', function() {
            mostrarConfirmacion(
                '¿Está seguro de eliminar este registro?',
                `Se eliminará el registro del lote "${registro.lote}" en "${registro.silo}".`,
                function() {
                    registrosSilos.splice(index, 1);
                    guardarRegistrosSilos();
                    actualizarTablaSilos();
                    actualizarTablaWorkersSilos();
                    actualizarEstadisticasSilos();
                    mostrarAlerta('Registro eliminado correctamente.', 'success');
                }
            );
        });

        row.querySelector('.print-btn').addEventListener('click', function() {
            imprimirCodigoIndividualSilo(registro);
        });
    }

    function mostrarRegistroSiloExpired(registro, index) {
        // Mostrar en tabla desktop de expirados
        if (!elements.registrosTableExpiredSilos) {
            console.error('registrosTableExpiredSilos no está disponible');
            return;
        }

        const codigo = registro.lote + '-' + registro.silo;
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">
                <span class="badge-expired badge text-xs">
                    <span class="status-indicator status-expired"></span>
                    <span>Expirado</span>
                </span>
            </td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${registro.maquina}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${registro.silo}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap font-medium text-gray-900">${registro.lote}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-600">${registro.fecha}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-600">${codigo}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right">
                <button class="view-barcode action-btn action-btn-view text-xs mr-2">
                    <i class="fas fa-eye"></i> <span class="hidden md:inline">Ver</span>
                </button>
                <button class="print-btn action-btn action-btn-print text-xs">
                    <i class="fas fa-print"></i> <span class="hidden md:inline">Imprimir</span>
                </button>
            </td>
        `;

        elements.registrosTableExpiredSilos.appendChild(row);

        // Eventos para los botones
        row.querySelector('.view-barcode').addEventListener('click', function() {
            try {
                if (typeof JsBarcode !== 'undefined' && elements.modalBarcode) {
                    JsBarcode(elements.modalBarcode, codigo, {
                        format: "CODE128",
                        width: 2,
                        height: 60,
                        displayValue: false,
                        fontSize: 14,
                        margin: 15,
                        background: "#ffffff",
                        lineColor: "#000000"
                    });
                    elements.barcodeModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error al generar código de barras:', error);
                mostrarAlerta('Error al generar el código de barras', 'error');
            }
        });

        row.querySelector('.print-btn').addEventListener('click', function() {
            imprimirCodigoIndividualSilo(registro);
        });
    }

    function mostrarRegistroMaquinaExpired(registro, index) {
        // Mostrar en tabla desktop de expirados
        if (!elements.registrosTableExpiredMaquinas) {
            console.error('registrosTableExpiredMaquinas no está disponible');
            return;
        }

        const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">
                <span class="badge-expired badge text-xs">
                    <span class="status-indicator status-expired"></span>
                    <span>Expirado</span>
                </span>
            </td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${registro.maquina}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${registro.silo}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${registro.operador}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${registro.turno}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap">${registro.producto}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-600">${registro.fecha}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-600">${codigo}</td>
            <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right">
                <button class="view-barcode action-btn action-btn-view text-xs mr-2">
                    <i class="fas fa-eye"></i> <span class="hidden md:inline">Ver</span>
                </button>
                <button class="print-btn action-btn action-btn-print text-xs">
                    <i class="fas fa-print"></i> <span class="hidden md:inline">Imprimir</span>
                </button>
            </td>
        `;

        elements.registrosTableExpiredMaquinas.appendChild(row);

        // Eventos para los botones
        row.querySelector('.view-barcode').addEventListener('click', function() {
            generarQRMaquina(registro);
        });

        row.querySelector('.print-btn').addEventListener('click', function() {
            imprimirCodigoIndividualMaquina(registro);
        });
    }

    // Función específica para generar QR de máquinas
    function generarQRMaquina(registro) {
        console.log('=== GENERANDO QR MÁQUINA ===');
        console.log('Registro:', registro);
        
        // Verificaciones básicas
        if (!registro) {
            console.error('No se proporcionó registro');
            mostrarAlerta('Error: No se encontraron datos del registro', 'error');
            return;
        }
        
        // Esperar a que JsBarcode esté disponible
        function intentarGenerarQR(intentos = 0) {
            const maxIntentos = 10;
            
            if (typeof window.JsBarcode === 'undefined') {
                if (intentos < maxIntentos) {
                    console.log(`Esperando JsBarcode... intento ${intentos + 1}/${maxIntentos}`);
                    setTimeout(() => intentarGenerarQR(intentos + 1), 200);
                    return;
                } else {
                    console.error('JsBarcode no está disponible después de múltiples intentos');
                    mostrarAlerta('Error: Librería de códigos QR no disponible. Recarga la página.', 'error');
                    return;
                }
            }
            
            // Verificar elementos del DOM
            const modalBarcode = document.getElementById('modalBarcode');
            const barcodeModal = document.getElementById('barcodeModal');
            const barcodeText = document.getElementById('barcodeText');
            const generationTime = document.getElementById('generationTime');
            
            if (!modalBarcode) {
                console.error('Elemento modalBarcode no encontrado');
                mostrarAlerta('Error: Elemento de código QR no encontrado', 'error');
                return;
            }
            
            if (!barcodeModal) {
                console.error('Elemento barcodeModal no encontrado');
                mostrarAlerta('Error: Modal de código QR no encontrado', 'error');
                return;
            }
            
            try {
                // Generar código
                const codigoOriginal = `${registro.maquina}-${registro.silo}-${registro.operador}`;
                const codigoLimpio = limpiarCodigoParaQR(codigoOriginal);
                
                console.log('Código original:', codigoOriginal);
                console.log('Código limpio:', codigoLimpio);
                
                // Limpiar SVG anterior
                modalBarcode.innerHTML = '';
                
                // Generar código QR
                window.JsBarcode(modalBarcode, codigoLimpio, {
                    format: "CODE128",
                    width: 2,
                    height: 60,
                    displayValue: false,
                    fontSize: 14,
                    margin: 15,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
                
                // Actualizar textos
                if (barcodeText) {
                    barcodeText.textContent = codigoOriginal;
                }
                
                if (generationTime) {
                    generationTime.textContent = new Date().toLocaleTimeString('es-ES');
                }
                
                // Mostrar modal
                barcodeModal.classList.remove('hidden');
                
                console.log('✅ QR generado exitosamente');
                mostrarAlerta('Código QR generado correctamente', 'success');
                
            } catch (error) {
                console.error('Error generando QR:', error);
                mostrarAlerta(`Error al generar código QR: ${error.message}`, 'error');
            }
        }
        
        // Iniciar proceso
        intentarGenerarQR();
    }

    function mostrarRegistroMaquina(registro, index) {
        // Mostrar en tabla desktop
        if (!elements.registrosTableMaquinas) {
            console.error('registrosTableMaquinas no está disponible');
            return;
        }

        // Usar el nuevo sistema de estados basado en cambio de producto
        let estado = '';
        let estadoClase = '';
        let estadoBadge = '';

        if (registro.estado === 'expirado') {
            estado = 'Expirado';
            estadoClase = 'status-expired';
            estadoBadge = 'badge-expired';
        } else {
            estado = 'Activo';
            estadoClase = 'status-active';
            estadoBadge = 'badge-active';
        }

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="${estadoBadge} badge">
                    <span class="status-indicator ${estadoClase}"></span>
                    ${estado}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${registro.maquina}</td>
            <td class="px-6 py-4 whitespace-nowrap">${registro.silo}</td>
            <td class="px-6 py-4 whitespace-nowrap">${registro.operador}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">${registro.turno}</td>
            <td class="px-6 py-4 whitespace-nowrap">${registro.producto}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${registro.fecha}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button class="view-barcode action-btn action-btn-view">
                    <i class="fas fa-eye"></i> Ver
                </button>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-2">
                    <button class="edit-btn action-btn action-btn-edit" title="Editar registro">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn action-btn action-btn-delete" title="Eliminar registro">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="print-btn action-btn action-btn-print" title="Imprimir código">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </td>
        `;

        elements.registrosTableMaquinas.appendChild(row);

        // Crear tarjeta móvil
        const mobileCardsContainer = document.getElementById('registrosCardsMaquinas');
        if (mobileCardsContainer) {
            const card = document.createElement('div');
            card.className = 'mobile-card';
            
            const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div class="mobile-card-title">${registro.maquina}</div>
                    <span class="mobile-status-badge ${estadoBadge}">${estado}</span>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-field">
                        <div class="mobile-field-label">Silo</div>
                        <div class="mobile-field-value">${registro.silo}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Operador</div>
                        <div class="mobile-field-value">${registro.operador}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Turno</div>
                        <div class="mobile-field-value">${registro.turno}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Producto</div>
                        <div class="mobile-field-value">${registro.producto}</div>
                    </div>
                    <div class="mobile-field mobile-field-full">
                        <div class="mobile-field-label">Hora</div>
                        <div class="mobile-field-value">${new Date(registro.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Fecha</div>
                        <div class="mobile-field-value">${registro.fecha}</div>
                    </div>
                    <div class="mobile-field mobile-field-full">
                        <div class="mobile-field-label">Código</div>
                        <div class="mobile-field-value" style="font-family: monospace; font-size: 12px;">${codigo}</div>
                    </div>
                </div>
                <div class="mobile-actions">
                    <div class="mobile-qr-code mobile-view-barcode" data-codigo="${codigo}" title="Ver QR">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="mobile-actions-buttons">
                        <button class="mobile-action-btn mobile-edit-btn" style="background: #3b82f6; color: white;" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="mobile-action-btn mobile-delete-btn" style="background: #ef4444; color: white;" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="mobile-action-btn mobile-print-btn" style="background: #10b981; color: white;" title="Imprimir">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>
            `;
            
            mobileCardsContainer.appendChild(card);
            
            // Eventos para la tarjeta móvil
            card.querySelector('.mobile-view-barcode').addEventListener('click', function() {
                generarQRMaquina(registro);
            });
            
            card.querySelector('.mobile-edit-btn').addEventListener('click', function() {
                editingIndexMaquinas = index;
                document.getElementById('editMaquinaMaq').value = registro.maquina;
                document.getElementById('editSiloMaq').value = registro.silo;
                document.getElementById('editOperador').value = registro.operador;
                document.getElementById('editTurno').value = registro.turno;
                document.getElementById('editProducto').value = registro.producto;
                elements.editModalMaquinas.classList.remove('hidden');
            });
            
            card.querySelector('.mobile-delete-btn').addEventListener('click', function() {
                mostrarConfirmacion(
                    '¿Está seguro de eliminar este registro?',
                    `Se eliminará la operación de "${registro.maquina}" con operador "${registro.operador}".`,
                    function() {
                        registrosMaquinas.splice(index, 1);
                        guardarRegistrosMaquinas();
                        actualizarTablaMaquinas();
                        actualizarTablaWorkersMaquinas();
                        actualizarEstadisticasMaquinas();
                        mostrarAlerta('Registro eliminado correctamente.', 'success');
                    }
                );
            });
            
            card.querySelector('.mobile-print-btn').addEventListener('click', function() {
                imprimirCodigoIndividualMaquina(registro);
            });
        }

        // Eventos para los botones de la fila desktop
        row.querySelector('.view-barcode').addEventListener('click', function() {
            generarQRMaquina(registro);
        });

        row.querySelector('.edit-btn').addEventListener('click', function() {
            editingIndexMaquinas = index;
            document.getElementById('editMaquinaMaq').value = registro.maquina;
            document.getElementById('editSiloMaq').value = registro.silo;
            document.getElementById('editOperador').value = registro.operador;
            document.getElementById('editTurno').value = registro.turno;
            document.getElementById('editProducto').value = registro.producto;
            elements.editModalMaquinas.classList.remove('hidden');
        });

        row.querySelector('.delete-btn').addEventListener('click', function() {
            mostrarConfirmacion(
                '¿Está seguro de eliminar este registro?',
                `Se eliminará la operación de "${registro.maquina}" con operador "${registro.operador}".`,
                function() {
                    registrosMaquinas.splice(index, 1);
                    guardarRegistrosMaquinas();
                    actualizarTablaMaquinas();
                    actualizarTablaWorkersMaquinas();
                    actualizarEstadisticasMaquinas();
                    mostrarAlerta('Registro eliminado correctamente.', 'success');
                }
            );
        });

        row.querySelector('.print-btn').addEventListener('click', function() {
            imprimirCodigoIndividualMaquina(registro);
        });
    }

    function mostrarRegistroWorkerSilo(registro, index) {
        // Mostrar en tabla desktop
        if (!elements.workerTableSilos) {
            console.error('workerTableSilos no está disponible');
            return;
        }

        // Usar el nuevo sistema de estados basado en cambio de lote
        let estado = '';
        let estadoClase = '';
        let prioridad = '';

        if (registro.estado === 'expirado') {
            estado = 'FINALIZADO';
            estadoClase = 'worker-badge-expired';
            prioridad = 'priority-high';
        } else {
            estado = 'OPERATIVO';
            estadoClase = 'worker-badge-active';
            prioridad = 'priority-normal';
        }

        const row = document.createElement('tr');
        row.className = `${prioridad}`;
        
        const horaRegistro = new Date(registro.timestamp).toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });

        row.innerHTML = `
            <td>
                <span class="worker-badge ${estadoClase}">${estado}</span>
            </td>
            <td class="hidden sm:table-cell">${registro.maquina}</td>
            <td>${registro.silo}</td>
            <td class="font-bold text-gray-900">${registro.lote}</td>
            <td>${horaRegistro}</td>
            <td class="text-center">
                <button class="worker-code-btn worker-view-code" data-codigo="${registro.lote}-${registro.silo}">
                    <i class="fas fa-qrcode mr-1"></i> VER QR
                </button>
            </td>
        `;

        elements.workerTableSilos.appendChild(row);

        // Crear tarjeta móvil
        const mobileCardsContainer = document.getElementById('workerCardsSilos');
        if (mobileCardsContainer) {
            const card = document.createElement('div');
            card.className = `mobile-card worker-mobile-card ${prioridad}`;
            
            const codigo = registro.lote + '-' + registro.silo;
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div class="mobile-card-title">${registro.maquina} - ${registro.silo} - ${registro.lote}</div>
                    <span class="mobile-status-badge worker-badge ${estadoClase}">${estado}</span>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-field">
                        <div class="mobile-field-label">Equipo</div>
                        <div class="mobile-field-value">${registro.maquina}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Ubicación</div>
                        <div class="mobile-field-value">${registro.silo}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Lote</div>
                        <div class="mobile-field-value">${registro.lote}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Hora</div>
                        <div class="mobile-field-value">${horaRegistro}</div>
                    </div>
                </div>
                <div class="mobile-actions">
                    <div class="mobile-qr-code mobile-worker-view-qr" data-codigo="${codigo}" title="Ver QR">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div style="color: #64748b; font-size: 12px; font-weight: 500;">
                        Código: ${codigo}
                    </div>
                </div>
            `;
            
            mobileCardsContainer.appendChild(card);
            
            // Evento para la tarjeta móvil
            card.querySelector('.mobile-worker-view-qr').addEventListener('click', function() {
                const codigo = this.getAttribute('data-codigo');
                try {
                    if (typeof JsBarcode !== 'undefined' && elements.modalBarcode) {
                        JsBarcode(elements.modalBarcode, codigo, {
                            format: "CODE128",
                            width: 2,
                            height: 60,
                            displayValue: false,
                            fontSize: 14,
                            margin: 15,
                            background: "#ffffff",
                            lineColor: "#000000"
                        });
                        document.getElementById('barcodeText').textContent = codigo;
                        document.getElementById('generationTime').textContent = new Date().toLocaleTimeString('es-ES');
                        elements.barcodeModal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error mostrando código de barras:", error);
                    mostrarAlerta('Error al generar el código de barras', 'error');
                }
            });
        }

        // Evento para ver código QR en tabla desktop
        row.querySelector('.worker-view-code').addEventListener('click', function() {
            const codigo = this.getAttribute('data-codigo');
            try {
                if (typeof JsBarcode !== 'undefined' && elements.modalBarcode) {
                    JsBarcode(elements.modalBarcode, codigo, {
                        format: "CODE128",
                        width: 2,
                        height: 60,
                        displayValue: false,
                        fontSize: 14,
                        margin: 15,
                        background: "#ffffff",
                        lineColor: "#000000"
                    });
                    document.getElementById('barcodeText').textContent = codigo;
                    document.getElementById('generationTime').textContent = new Date().toLocaleTimeString('es-ES');
                    elements.barcodeModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error mostrando código de barras:", error);
                mostrarAlerta('Error al generar el código de barras', 'error');
            }
        });
    }

    function mostrarRegistroWorkerMaquina(registro, index) {
        if (!elements.workerTableMaquinas) {
            console.error('workerTableMaquinas no está disponible');
            return;
        }

        // Usar el nuevo sistema de estados basado en cambio de producto
        let estado = '';
        let estadoClase = '';
        let prioridad = '';

        if (registro.estado === 'expirado') {
            estado = 'FINALIZADO';
            estadoClase = 'worker-badge-expired';
            prioridad = 'priority-high';
        } else {
            estado = 'OPERATIVO';
            estadoClase = 'worker-badge-active';
            prioridad = 'priority-normal';
        }

        const row = document.createElement('tr');
        row.className = `${prioridad}`;
        
        const horaRegistro = new Date(registro.timestamp).toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });

        row.innerHTML = `
            <td>
                <span class="worker-badge ${estadoClase}">${estado}</span>
            </td>
            <td class="font-bold text-gray-900">${registro.maquina}</td>
            <td>${registro.silo}</td>
            <td>${registro.operador}</td>
            <td class="text-sm">${registro.turno}</td>
            <td>${registro.producto}</td>
            <td>${horaRegistro}</td>
            <td class="text-center">
                <button class="worker-code-btn-maquinas worker-view-code" data-codigo="${registro.maquina}-${registro.silo}-${registro.operador}">
                    <i class="fas fa-qrcode mr-1"></i> VER QR
                </button>
            </td>
        `;

        elements.workerTableMaquinas.appendChild(row);

        // Crear tarjeta móvil
        const mobileCardsContainer = document.getElementById('workerCardsMaquinas');
        if (mobileCardsContainer) {
            const card = document.createElement('div');
            card.className = `mobile-card worker-mobile-card ${prioridad}`;
            
            const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
            
            card.innerHTML = `
                <div class="mobile-card-header">
                    <div class="mobile-card-title">${registro.maquina}</div>
                    <span class="mobile-status-badge worker-badge ${estadoClase}">${estado}</span>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-field">
                        <div class="mobile-field-label">Ubicación</div>
                        <div class="mobile-field-value">${registro.silo}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Operador</div>
                        <div class="mobile-field-value">${registro.operador}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Turno</div>
                        <div class="mobile-field-value">${registro.turno}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Producto</div>
                        <div class="mobile-field-value">${registro.producto}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Hora</div>
                        <div class="mobile-field-value">${horaRegistro}</div>
                    </div>
                    <div class="mobile-field">
                        <div class="mobile-field-label">Fecha</div>
                        <div class="mobile-field-value">${registro.fecha}</div>
                    </div>
                </div>
                <div class="mobile-actions">
                    <div class="mobile-qr-code mobile-worker-view-qr" data-codigo="${codigo}" title="Ver QR">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div style="color: #64748b; font-size: 12px; font-weight: 500;">
                        Código: ${codigo}
                    </div>
                </div>
            `;
            
            mobileCardsContainer.appendChild(card);
            
            // Evento para la tarjeta móvil
            card.querySelector('.mobile-worker-view-qr').addEventListener('click', function() {
                generarQRMaquina(registro);
            });
        }

        // Evento para ver código QR en tabla desktop
        row.querySelector('.worker-view-code').addEventListener('click', function() {
            generarQRMaquina(registro);
        });
    }

    function actualizarTablaSilos() {
        console.log('Actualizando tabla de silos con ' + registrosSilos.length + ' registros');
        
        if (!elements.registrosTableSilos) {
            console.error('Elemento registrosTableSilos no encontrado');
            return;
        }

        // Limpiar tabla desktop
        elements.registrosTableSilos.innerHTML = '';
        
        // Limpiar tarjetas móviles
        const mobileCardsContainer = document.getElementById('registrosCardsSilos');
        if (mobileCardsContainer) {
            mobileCardsContainer.innerHTML = '';
        }

        const searchTerm = elements.searchInputSilos ? elements.searchInputSilos.value.toLowerCase().trim() : '';
        let registrosFiltrados = registrosSilos;

        // Filtrar por estado (activos/expirados)
        if (!showExpiredSilos) {
            registrosFiltrados = registrosFiltrados.filter(registro => registro.estado !== 'expirado');
        }

        if (searchTerm) {
            registrosFiltrados = registrosFiltrados.filter(registro => 
                registro.lote.toLowerCase().includes(searchTerm) ||
                registro.silo.toLowerCase().includes(searchTerm) ||
                registro.maquina.toLowerCase().includes(searchTerm)
            );
        }

        if (registrosFiltrados.length === 0) {
            // Mensaje para tabla desktop
            elements.registrosTableSilos.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8">
                        <div class="text-gray-400">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p class="font-medium text-sm">No se encontraron registros</p>
                            <p class="text-sm mt-1">"${elements.searchInputSilos.value}"</p>
                        </div>
                    </td>
                </tr>
            `;
            
            // Mensaje para vista móvil
            if (mobileCardsContainer) {
                mobileCardsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-search fa-2x mb-4"></i>
                        <p class="font-medium">No se encontraron registros</p>
                        <p class="text-sm mt-1">"${elements.searchInputSilos.value}"</p>
                    </div>
                `;
            }
        } else {
            // Ordenar registros por timestamp descendente (más nuevos primero)
            const registrosOrdenados = registrosFiltrados.sort((a, b) => {
                return (b.timestamp || 0) - (a.timestamp || 0);
            });
            
            registrosOrdenados.forEach((registro, index) => {
                const originalIndex = registrosSilos.findIndex(r => r.timestamp === registro.timestamp);
                mostrarRegistroSilo(registro, originalIndex);
            });
        }

        const totalRegistros = registrosSilos.length;
        const visibleCount = registrosFiltrados.length;
        const expiradosCount = registrosSilos.filter(r => r.estado === 'expirado').length;
        const activosCount = totalRegistros - expiradosCount;
        
        if (elements.tableInfoSilos) {
            if (searchTerm) {
                elements.tableInfoSilos.textContent = `Mostrando ${visibleCount} de ${totalRegistros} registros`;
            } else {
                elements.tableInfoSilos.textContent = `Mostrando ${activosCount} registros activos (${expiradosCount} expirados disponibles)`;
            }
        }
    }

    function actualizarTablaExpiredSilos() {
        console.log('Actualizando tabla de silos expirados');
        
        if (!elements.registrosTableExpiredSilos) {
            console.error('Elemento registrosTableExpiredSilos no encontrado');
            return;
        }

        // Limpiar tabla
        elements.registrosTableExpiredSilos.innerHTML = '';
        
        // Limpiar tarjetas móviles
        const mobileCardsContainer = document.getElementById('registrosCardsExpiredSilos');
        if (mobileCardsContainer) {
            mobileCardsContainer.innerHTML = '';
        }

        const searchTerm = elements.searchInputExpiredSilos ? elements.searchInputExpiredSilos.value.toLowerCase().trim() : '';
        let registrosExpirados = registrosSilos.filter(registro => registro.estado === 'expirado');

        if (searchTerm) {
            registrosExpirados = registrosExpirados.filter(registro => 
                registro.lote.toLowerCase().includes(searchTerm) ||
                registro.silo.toLowerCase().includes(searchTerm) ||
                registro.maquina.toLowerCase().includes(searchTerm)
            );
        }

        if (registrosExpirados.length === 0) {
            elements.registrosTableExpiredSilos.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8">
                        <div class="text-gray-400">
                            <i class="fas fa-archive fa-2x mb-2"></i>
                            <p class="font-medium text-sm">No hay registros expirados</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            const registrosOrdenados = registrosExpirados.sort((a, b) => {
                return (b.timestamp || 0) - (a.timestamp || 0);
            });
            
            registrosOrdenados.forEach((registro, index) => {
                const originalIndex = registrosSilos.findIndex(r => r.timestamp === registro.timestamp);
                mostrarRegistroSiloExpired(registro, originalIndex);
            });
        }

        if (elements.tableInfoExpiredSilos) {
            elements.tableInfoExpiredSilos.textContent = `Mostrando ${registrosExpirados.length} registros expirados`;
        }
    }

    function actualizarTablaMaquinas() {
        console.log('Actualizando tabla de máquinas con ' + registrosMaquinas.length + ' registros');
        
        if (!elements.registrosTableMaquinas) {
            console.error('Elemento registrosTableMaquinas no encontrado');
            return;
        }

        // Limpiar tabla desktop
        elements.registrosTableMaquinas.innerHTML = '';
        
        // Limpiar tarjetas móviles
        const mobileCardsContainer = document.getElementById('registrosCardsMaquinas');
        if (mobileCardsContainer) {
            mobileCardsContainer.innerHTML = '';
        }

        const searchTerm = elements.searchInputMaquinas ? elements.searchInputMaquinas.value.toLowerCase().trim() : '';
        let registrosFiltrados = registrosMaquinas;

        // Filtrar por estado (activos/expirados)
        if (!showExpiredMaquinas) {
            registrosFiltrados = registrosFiltrados.filter(registro => registro.estado !== 'expirado');
        }

        if (searchTerm) {
            registrosFiltrados = registrosFiltrados.filter(registro => 
                registro.maquina.toLowerCase().includes(searchTerm) ||
                registro.silo.toLowerCase().includes(searchTerm) ||
                registro.operador.toLowerCase().includes(searchTerm) ||
                registro.turno.toLowerCase().includes(searchTerm) ||
                registro.producto.toLowerCase().includes(searchTerm)
            );
        }

        if (registrosFiltrados.length === 0) {
            // Mensaje para tabla desktop
            elements.registrosTableMaquinas.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-8">
                        <div class="text-gray-400">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p class="font-medium text-sm">No se encontraron registros</p>
                            <p class="text-sm mt-1">"${elements.searchInputMaquinas.value}"</p>
                        </div>
                    </td>
                </tr>
            `;
            
            // Mensaje para vista móvil
            if (mobileCardsContainer) {
                mobileCardsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-search fa-2x mb-4"></i>
                        <p class="font-medium">No se encontraron registros</p>
                        <p class="text-sm mt-1">"${elements.searchInputMaquinas.value}"</p>
                    </div>
                `;
            }
        } else {
            // Ordenar registros por timestamp descendente (más nuevos primero)
            const registrosOrdenados = registrosFiltrados.sort((a, b) => {
                return (b.timestamp || 0) - (a.timestamp || 0);
            });
            
            registrosOrdenados.forEach((registro, index) => {
                const originalIndex = registrosMaquinas.findIndex(r => r.timestamp === registro.timestamp);
                mostrarRegistroMaquina(registro, originalIndex);
            });
        }

        const totalRegistros = registrosMaquinas.length;
        const visibleCount = registrosFiltrados.length;
        const expiradosCount = registrosMaquinas.filter(r => r.estado === 'expirado').length;
        const activosCount = totalRegistros - expiradosCount;
        
        if (elements.tableInfoMaquinas) {
            if (searchTerm) {
                elements.tableInfoMaquinas.textContent = `Mostrando ${visibleCount} de ${totalRegistros} registros`;
            } else {
                elements.tableInfoMaquinas.textContent = `Mostrando ${activosCount} registros activos (${expiradosCount} expirados disponibles)`;
            }
        }
    }

    function actualizarTablaExpiredMaquinas() {
        console.log('Actualizando tabla de máquinas expiradas');
        
        if (!elements.registrosTableExpiredMaquinas) {
            console.error('Elemento registrosTableExpiredMaquinas no encontrado');
            return;
        }

        // Limpiar tabla
        elements.registrosTableExpiredMaquinas.innerHTML = '';
        
        // Limpiar tarjetas móviles
        const mobileCardsContainer = document.getElementById('registrosCardsExpiredMaquinas');
        if (mobileCardsContainer) {
            mobileCardsContainer.innerHTML = '';
        }

        const searchTerm = elements.searchInputExpiredMaquinas ? elements.searchInputExpiredMaquinas.value.toLowerCase().trim() : '';
        let registrosExpirados = registrosMaquinas.filter(registro => registro.estado === 'expirado');

        if (searchTerm) {
            registrosExpirados = registrosExpirados.filter(registro => 
                registro.maquina.toLowerCase().includes(searchTerm) ||
                registro.silo.toLowerCase().includes(searchTerm) ||
                registro.operador.toLowerCase().includes(searchTerm) ||
                registro.turno.toLowerCase().includes(searchTerm) ||
                registro.producto.toLowerCase().includes(searchTerm)
            );
        }

        if (registrosExpirados.length === 0) {
            elements.registrosTableExpiredMaquinas.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-8">
                        <div class="text-gray-400">
                            <i class="fas fa-archive fa-2x mb-2"></i>
                            <p class="font-medium text-sm">No hay registros expirados</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            const registrosOrdenados = registrosExpirados.sort((a, b) => {
                return (b.timestamp || 0) - (a.timestamp || 0);
            });
            
            registrosOrdenados.forEach((registro, index) => {
                const originalIndex = registrosMaquinas.findIndex(r => r.timestamp === registro.timestamp);
                mostrarRegistroMaquinaExpired(registro, originalIndex);
            });
        }

        if (elements.tableInfoExpiredMaquinas) {
            elements.tableInfoExpiredMaquinas.textContent = `Mostrando ${registrosExpirados.length} registros expirados`;
        }
    }

    function actualizarTablaWorkersSilos() {
        console.log('Actualizando tabla de workers con ' + registrosSilos.length + ' registros');
        
        if (!elements.workerTableSilos) {
            console.error('Elemento workerTableSilos no encontrado');
            return;
        }

        // Limpiar tabla desktop
        elements.workerTableSilos.innerHTML = '';
        
        // Limpiar contenedor móvil
        const mobileCardsContainer = document.getElementById('workerCardsSilos');
        if (mobileCardsContainer) {
            mobileCardsContainer.innerHTML = '';
        }

        if (registrosSilos.length === 0) {
            // Mensaje para tabla desktop
            elements.workerTableSilos.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8">
                        <div class="text-gray-400">
                            <i class="fas fa-hard-hat fa-2x mb-2"></i>
                            <p class="font-medium text-sm">No hay operaciones activas</p>
                            <p class="text-xs mt-1">Los registros aparecerán aquí cuando se agreguen</p>
                        </div>
                    </td>
                </tr>
            `;
            
            // Mensaje para móvil
            if (mobileCardsContainer) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-8';
                emptyMessage.innerHTML = `
                    <div class="text-gray-400">
                        <i class="fas fa-hard-hat fa-2x mb-2"></i>
                        <p class="font-medium text-sm">No hay operaciones activas</p>
                        <p class="text-xs mt-1">Los registros aparecerán aquí cuando se agreguen</p>
                    </div>
                `;
                mobileCardsContainer.appendChild(emptyMessage);
            }

            if (elements.workerTableInfoSilos) {
                elements.workerTableInfoSilos.textContent = 'Mostrando 0 operaciones activas';
            }
            return;
        }

        const registrosOrdenados = registrosSilos.slice().sort((a, b) => b.timestamp - a.timestamp);
        
        registrosOrdenados.forEach((registro, index) => {
            const originalIndex = registrosSilos.findIndex(r => r.timestamp === registro.timestamp);
            mostrarRegistroWorkerSilo(registro, originalIndex);
        });

        if (elements.workerTableInfoSilos) {
            elements.workerTableInfoSilos.textContent = `Mostrando ${registrosSilos.length} operaciones activas`;
        }
    }

    function actualizarTablaWorkersMaquinas() {
        console.log('Actualizando tabla de workers de máquinas con ' + registrosMaquinas.length + ' registros');
        
        if (!elements.workerTableMaquinas) {
            console.error('Elemento workerTableMaquinas no encontrado');
            return;
        }

        // Limpiar tabla desktop
        elements.workerTableMaquinas.innerHTML = '';
        
        // Limpiar contenedor móvil
        const mobileCardsContainer = document.getElementById('workerCardsMaquinas');
        if (mobileCardsContainer) {
            mobileCardsContainer.innerHTML = '';
        }

        if (registrosMaquinas.length === 0) {
            // Mensaje para tabla desktop
            elements.workerTableMaquinas.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-8">
                        <div class="text-gray-400">
                            <i class="fas fa-users-cog fa-2x mb-2"></i>
                            <p class="font-medium text-sm">No hay operaciones activas</p>
                            <p class="text-xs mt-1">Las operaciones aparecerán aquí cuando se agreguen</p>
                        </div>
                    </td>
                </tr>
            `;
            
            // Mensaje para móvil
            if (mobileCardsContainer) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-8';
                emptyMessage.innerHTML = `
                    <div class="text-gray-400">
                        <i class="fas fa-users-cog fa-2x mb-2"></i>
                        <p class="font-medium text-sm">No hay operaciones activas</p>
                        <p class="text-xs mt-1">Las operaciones aparecerán aquí cuando se agreguen</p>
                    </div>
                `;
                mobileCardsContainer.appendChild(emptyMessage);
            }

            if (elements.workerTableInfoMaquinas) {
                elements.workerTableInfoMaquinas.textContent = 'Mostrando 0 operaciones activas';
            }
            return;
        }

        const registrosOrdenados = registrosMaquinas.slice().sort((a, b) => b.timestamp - a.timestamp);
        
        registrosOrdenados.forEach((registro, index) => {
            const originalIndex = registrosMaquinas.findIndex(r => r.timestamp === registro.timestamp);
            mostrarRegistroWorkerMaquina(registro, originalIndex);
        });

        if (elements.workerTableInfoMaquinas) {
            elements.workerTableInfoMaquinas.textContent = `Mostrando ${registrosMaquinas.length} operaciones activas`;
        }
    }

    function actualizarEstadisticasSilos() {
        const registrosActivos = registrosSilos.filter(r => r.estado === 'activo' || !r.estado); // Incluye registros sin estado (por compatibilidad)
        const silosUnicos = new Set(registrosActivos.map(r => r.silo));
        const ultimoRegistro = registrosSilos.length > 0 ? 
            registrosSilos.sort((a, b) => b.timestamp - a.timestamp)[0] : null;

        if (elements.activeCountSilos) {
            elements.activeCountSilos.textContent = registrosActivos.length;
        }

        if (elements.silosInUse) {
            elements.silosInUse.textContent = `${silosUnicos.size}/8`;
        }

        if (elements.lastRecordSilos) {
            if (ultimoRegistro) {
                elements.lastRecordSilos.textContent = `${ultimoRegistro.lote} - ${ultimoRegistro.silo}`;
            } else {
                elements.lastRecordSilos.textContent = 'N/A';
            }
        }
    }

    function actualizarEstadisticasMaquinas() {
        const registrosActivos = registrosMaquinas.filter(r => r.estado === 'activo' || !r.estado); // Incluye registros sin estado (por compatibilidad)
        const maquinasUnicas = new Set(registrosActivos.map(r => r.maquina));
        const ultimoRegistro = registrosMaquinas.length > 0 ? 
            registrosMaquinas.sort((a, b) => b.timestamp - a.timestamp)[0] : null;

        if (elements.activeCountMaquinas) {
            elements.activeCountMaquinas.textContent = registrosActivos.length;
        }

        if (elements.machinesInUse) {
            elements.machinesInUse.textContent = `${maquinasUnicas.size}/8`;
        }

        if (elements.lastRecordMaquinas) {
            if (ultimoRegistro) {
                elements.lastRecordMaquinas.textContent = `${ultimoRegistro.maquina} - ${ultimoRegistro.operador}`;
            } else {
                elements.lastRecordMaquinas.textContent = 'N/A';
            }
        }
    }

    function exportarCSVSilos() {
        console.log('[EXPORT] Iniciando exportación CSV de silos...');
        console.log('[EXPORT] Registros disponibles:', registrosSilos.length);
        
        if (!registrosSilos || registrosSilos.length === 0) {
            mostrarAlerta('No hay registros para exportar.', 'warning');
            console.log('[EXPORT] No hay registros de silos para exportar');
            return;
        }

        try {
            const headers = ['Estado', 'Máquina', 'Silo', 'Lote', 'Fecha/Hora', 'Código'];
            const csvContent = [headers.join(',')];

            registrosSilos.forEach((registro, index) => {
                console.log(`[EXPORT] Procesando registro ${index + 1}:`, registro);
                
                // Usar el nuevo sistema de estados
                let estado = 'Activo';
                if (registro.estado === 'expirado') {
                    estado = 'Expirado';
                }

                const codigo = registro.lote + '-' + registro.silo;
                const row = [
                    estado,
                    `"${registro.maquina || 'N/A'}"`,
                    `"${registro.silo || 'N/A'}"`,
                    `"${registro.lote || 'N/A'}"`,
                    `"${registro.fecha || 'N/A'}"`,
                    `"${codigo}"`
                ];
                csvContent.push(row.join(','));
            });

            const csvString = csvContent.join('\n');
            console.log('[EXPORT] CSV generado, tamaño:', csvString.length, 'caracteres');
            
            // Añadir BOM para compatibilidad con Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            
            console.log('[EXPORT] Blob creado, tamaño:', blob.size, 'bytes');
            
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const fileName = `registros_silos_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                
                console.log('[EXPORT] Iniciando descarga del archivo:', fileName);
                link.click();
                
                // Limpiar después de un pequeño delay
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    console.log('[EXPORT] Limpieza completada');
                }, 100);
                
                mostrarAlerta(`✅ Archivo CSV exportado: ${fileName}`, 'success');
                console.log('[EXPORT] Exportación de silos completada exitosamente');
            } else {
                console.error('[EXPORT] El navegador no soporta la descarga de archivos');
                mostrarAlerta('Su navegador no soporta la descarga de archivos.', 'error');
            }
        } catch (error) {
            console.error('[EXPORT] Error durante la exportación de silos:', error);
            mostrarAlerta('Error al exportar el archivo CSV.', 'error');
        }
    }

    function exportarCSVMaquinas() {
        console.log('[EXPORT] Iniciando exportación CSV de máquinas...');
        console.log('[EXPORT] Registros disponibles:', registrosMaquinas.length);
        
        if (!registrosMaquinas || registrosMaquinas.length === 0) {
            mostrarAlerta('No hay registros para exportar.', 'warning');
            console.log('[EXPORT] No hay registros de máquinas para exportar');
            return;
        }

        try {
            const headers = ['Estado', 'Máquina', 'Silo', 'Operador', 'Turno', 'Producto', 'Fecha/Hora', 'Código'];
            const csvContent = [headers.join(',')];

            registrosMaquinas.forEach((registro, index) => {
                console.log(`[EXPORT] Procesando registro de máquina ${index + 1}:`, registro);
                
                // Usar el nuevo sistema de estados
                let estado = 'Activo';
                if (registro.estado === 'expirado') {
                    estado = 'Expirado';
                }

                const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
                const row = [
                    estado,
                    `"${registro.maquina || 'N/A'}"`,
                    `"${registro.silo || 'N/A'}"`,
                    `"${registro.operador || 'N/A'}"`,
                    `"${registro.turno || 'N/A'}"`,
                    `"${registro.producto || 'N/A'}"`,
                    `"${registro.fecha || 'N/A'}"`,
                    `"${codigo}"`
                ];
                csvContent.push(row.join(','));
            });

            const csvString = csvContent.join('\n');
            console.log('[EXPORT] CSV de máquinas generado, tamaño:', csvString.length, 'caracteres');
            
            // Añadir BOM para compatibilidad con Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            
            console.log('[EXPORT] Blob de máquinas creado, tamaño:', blob.size, 'bytes');
            
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const fileName = `registros_maquinas_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                
                console.log('[EXPORT] Iniciando descarga del archivo de máquinas:', fileName);
                link.click();
                
                // Limpiar después de un pequeño delay
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    console.log('[EXPORT] Limpieza de máquinas completada');
                }, 100);
                
                mostrarAlerta(`✅ Archivo CSV exportado: ${fileName}`, 'success');
                console.log('[EXPORT] Exportación de máquinas completada exitosamente');
            } else {
                console.error('[EXPORT] El navegador no soporta la descarga de archivos');
                mostrarAlerta('Su navegador no soporta la descarga de archivos.', 'error');
            }
        } catch (error) {
            console.error('[EXPORT] Error durante la exportación de máquinas:', error);
            mostrarAlerta('Error al exportar el archivo CSV.', 'error');
        }
    }

    function exportarCSVExpiredSilos() {
        console.log('[EXPORT] Iniciando exportación CSV de silos expirados...');
        
        const registrosExpirados = registrosSilos.filter(registro => registro.estado === 'expirado');
        console.log('[EXPORT] Registros expirados disponibles:', registrosExpirados.length);
        
        if (registrosExpirados.length === 0) {
            mostrarAlerta('No hay registros expirados para exportar.', 'warning');
            console.log('[EXPORT] No hay registros expirados de silos para exportar');
            return;
        }

        try {
            const headers = ['Estado', 'Máquina', 'Silo', 'Lote', 'Fecha/Hora', 'Código'];
            const csvContent = [headers.join(',')];

            registrosExpirados.forEach((registro, index) => {
                console.log(`[EXPORT] Procesando registro expirado ${index + 1}:`, registro);
                
                const codigo = registro.lote + '-' + registro.silo;
                const row = [
                    'Expirado',
                    `"${registro.maquina || 'N/A'}"`,
                    `"${registro.silo || 'N/A'}"`,
                    `"${registro.lote || 'N/A'}"`,
                    `"${registro.fecha || 'N/A'}"`,
                    `"${codigo}"`
                ];
                csvContent.push(row.join(','));
            });

            const csvString = csvContent.join('\n');
            console.log('[EXPORT] CSV de expirados generado, tamaño:', csvString.length, 'caracteres');
            
            // Añadir BOM para compatibilidad con Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            
            const fechaHora = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const fileName = `silos_expirados_${fechaHora}.csv`;
            
            if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                // Para Internet Explorer
                window.navigator.msSaveOrOpenBlob(blob, fileName);
            } else {
                // Para otros navegadores
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.style.display = 'none';
                link.href = url;
                link.download = fileName;
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                mostrarAlerta(`✅ Archivo CSV exportado: ${fileName}`, 'success');
                console.log('[EXPORT] Exportación de silos expirados completada exitosamente');
            }
        } catch (error) {
            console.error('[EXPORT] Error durante la exportación de silos expirados:', error);
            mostrarAlerta('Error al exportar el archivo CSV.', 'error');
        }
    }

    function exportarCSVExpiredMaquinas() {
        console.log('[EXPORT] Iniciando exportación CSV de máquinas expiradas...');
        
        const registrosExpirados = registrosMaquinas.filter(registro => registro.estado === 'expirado');
        console.log('[EXPORT] Registros expirados disponibles:', registrosExpirados.length);
        
        if (registrosExpirados.length === 0) {
            mostrarAlerta('No hay registros expirados para exportar.', 'warning');
            console.log('[EXPORT] No hay registros expirados de máquinas para exportar');
            return;
        }

        try {
            const headers = ['Estado', 'Máquina', 'Silo', 'Operador', 'Turno', 'Producto', 'Fecha/Hora', 'Código'];
            const csvContent = [headers.join(',')];

            registrosExpirados.forEach((registro, index) => {
                console.log(`[EXPORT] Procesando registro expirado ${index + 1}:`, registro);
                
                const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
                const row = [
                    'Expirado',
                    `"${registro.maquina || 'N/A'}"`,
                    `"${registro.silo || 'N/A'}"`,
                    `"${registro.operador || 'N/A'}"`,
                    `"${registro.turno || 'N/A'}"`,
                    `"${registro.producto || 'N/A'}"`,
                    `"${registro.fecha || 'N/A'}"`,
                    `"${codigo}"`
                ];
                csvContent.push(row.join(','));
            });

            const csvString = csvContent.join('\n');
            console.log('[EXPORT] CSV de expirados generado, tamaño:', csvString.length, 'caracteres');
            
            // Añadir BOM para compatibilidad con Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            
            const fechaHora = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const fileName = `maquinas_expiradas_${fechaHora}.csv`;
            
            if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                // Para Internet Explorer
                window.navigator.msSaveOrOpenBlob(blob, fileName);
            } else {
                // Para otros navegadores
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.style.display = 'none';
                link.href = url;
                link.download = fileName;
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                mostrarAlerta(`✅ Archivo CSV exportado: ${fileName}`, 'success');
                console.log('[EXPORT] Exportación de máquinas expiradas completada exitosamente');
            }
        } catch (error) {
            console.error('[EXPORT] Error durante la exportación de máquinas expiradas:', error);
            mostrarAlerta('Error al exportar el archivo CSV.', 'error');
        }
    }

    function imprimirReporteSilos() {
        if (registrosSilos.length === 0) {
            mostrarAlerta('No hay registros para imprimir.', 'warning');
            return;
        }

        const ahora = new Date().getTime();
        let reporteHTML = `
            <div class="print-area" style="font-family: Arial, sans-serif; padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                    <h1 style="color: #333; margin: 0; font-size: 24px;">Sistema de Gestión de Silos y Lotes</h1>
                    <h2 style="color: #666; margin: 10px 0 0 0; font-size: 18px;">Reporte de Registros Activos</h2>
                    <p style="color: #888; margin: 5px 0 0 0; font-size: 14px;">Generado el ${new Date().toLocaleString('es-ES')}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Resumen Ejecutivo</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 15px 0;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2563eb;">${registrosSilos.length}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Total Registros</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">${new Set(registrosSilos.map(r => r.silo)).size}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Silos en Uso</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${registrosSilos.filter(r => r.estado === 'activo' || !r.estado).length}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Registros Activos</div>
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Estado</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Máquina</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Silo</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Lote</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Fecha/Hora</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Código</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        registrosSilos.sort((a, b) => b.timestamp - a.timestamp).forEach(registro => {
            // Usar el nuevo sistema de estados
            let estado = 'Activo';
            let colorEstado = '#10b981';
            
            if (registro.estado === 'expirado') {
                estado = 'Expirado';
                colorEstado = '#ef4444';
            }

            const codigo = registro.lote + '-' + registro.silo;
            reporteHTML += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <span style="color: ${colorEstado}; font-weight: bold;">${estado}</span>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${registro.maquina}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${registro.silo}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${registro.lote}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${registro.fecha}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;">${codigo}</td>
                </tr>
            `;
        });

        reporteHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 10px; color: #666;">
                    <p><strong>Notas:</strong></p>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>Los registros se marcan como expirados cuando cambia el lote en el mismo silo</li>
                        <li>Solo puede haber un lote activo por silo simultáneamente</li>
                        <li>Este reporte fue generado automáticamente por el Sistema de Gestión Industrial</li>
                    </ul>
                    <p style="text-align: center; margin-top: 15px;">
                        <strong>Sistema de Gestión Industrial Integrado v2.3.0</strong><br>
                        Reporte generado el ${new Date().toLocaleString('es-ES')}
                    </p>
                </div>
            </div>
        `;

        const ventanaImpresion = window.open('', '_blank');
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Reporte de Silos y Lotes</title>
                <style>
                    @media print {
                        body { margin: 0; }
                        .print-area { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${reporteHTML}
            </body>
            </html>
        `);
        ventanaImpresion.document.close();
        ventanaImpresion.print();
    }

    function imprimirReporteMaquinas() {
        if (registrosMaquinas.length === 0) {
            mostrarAlerta('No hay registros para imprimir.', 'warning');
            return;
        }

        const ahora = new Date().getTime();
        let reporteHTML = `
            <div class="print-area" style="font-family: Arial, sans-serif; padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                    <h1 style="color: #333; margin: 0; font-size: 24px;">Sistema de Gestión de Máquinas y Silos</h1>
                    <h2 style="color: #666; margin: 10px 0 0 0; font-size: 18px;">Reporte de Operaciones Activas</h2>
                    <p style="color: #888; margin: 5px 0 0 0; font-size: 14px;">Generado el ${new Date().toLocaleString('es-ES')}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Resumen Ejecutivo</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 15px 0;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">${registrosMaquinas.length}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Total Operaciones</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2563eb;">${new Set(registrosMaquinas.map(r => r.maquina)).size}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Máquinas en Uso</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${registrosMaquinas.filter(r => r.estado === 'activo' || !r.estado).length}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Operaciones Activas</div>
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Estado</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Máquina</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Silo</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Operador</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Turno</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Producto</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Fecha/Hora</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left;">Código</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        registrosMaquinas.sort((a, b) => b.timestamp - a.timestamp).forEach(registro => {
            // Usar el nuevo sistema de estados
            let estado = 'Activo';
            let colorEstado = '#10b981';
            
            if (registro.estado === 'expirado') {
                estado = 'Expirado';
                colorEstado = '#ef4444';
            }

            const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
            reporteHTML += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 6px;">
                        <span style="color: ${colorEstado}; font-weight: bold;">${estado}</span>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold;">${registro.maquina}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${registro.silo}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${registro.operador}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${registro.turno}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${registro.producto}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${registro.fecha}</td>
                    <td style="border: 1px solid #ddd; padding: 6px; font-family: monospace; font-size: 10px;">${codigo}</td>
                </tr>
            `;
        });

        reporteHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 10px; color: #666;">
                    <p><strong>Notas:</strong></p>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>Las operaciones se eliminan automáticamente después de 24 horas</li>
                        <li>Las operaciones próximas a expirar se marcan después de 12 horas</li>
                        <li>Este reporte fue generado automáticamente por el Sistema de Gestión Industrial</li>
                    </ul>
                    <p style="text-align: center; margin-top: 15px;">
                        <strong>Sistema de Gestión Industrial Integrado v2.3.0</strong><br>
                        Reporte generado el ${new Date().toLocaleString('es-ES')}
                    </p>
                </div>
            </div>
        `;

        const ventanaImpresion = window.open('', '_blank');
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Reporte de Máquinas y Silos</title>
                <style>
                    @media print {
                        body { margin: 0; }
                        .print-area { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${reporteHTML}
            </body>
            </html>
        `);
        ventanaImpresion.document.close();
        ventanaImpresion.print();
    }

    function imprimirReporteWorkersSilos() {
        if (registrosSilos.length === 0) {
            mostrarAlerta('No hay operaciones para imprimir.', 'warning');
            return;
        }

        const ahora = new Date().getTime();
        let reporteHTML = `
            <div class="print-area" style="font-family: Arial, sans-serif; padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e293b; padding-bottom: 20px;">
                    <h1 style="color: #1e293b; margin: 0; font-size: 24px;">PANEL DE CONTROL - PERSONAL DE PLANTA</h1>
                    <h2 style="color: #64748b; margin: 10px 0 0 0; font-size: 18px;">Reporte Operativo de Silos y Lotes</h2>
                    <p style="color: #94a3b8; margin: 5px 0 0 0; font-size: 14px;">Generado el ${new Date().toLocaleString('es-ES')} | Turno: ${getCurrentShiftText()}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #cbd5e1;">
                    <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;">
                        <span style="background: #1e293b; color: white; padding: 8px; border-radius: 6px; margin-right: 10px; font-size: 14px;">📊</span>
                        RESUMEN OPERATIVO
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #cbd5e1;">
                            <div style="font-size: 20px; font-weight: bold; color: #1e40af;">${registrosSilos.length}</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px; font-weight: 600;">OPERACIONES TOTALES</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #cbd5e1;">
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;">${registrosSilos.filter(r => r.estado === 'activo' || !r.estado).length}</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px; font-weight: 600;">OPERACIONES ACTIVAS</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #cbd5e1;">
                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${registrosSilos.filter(r => r.estado === 'expirado').length}</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px; font-weight: 600;">FINALIZADAS</div>
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; background: white; border: 2px solid #cbd5e1; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #334155 0%, #1e293b 100%); color: white;">
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px;">ESTADO OPERATIVO</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px;">CÓDIGO DE LOTE</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px;">UBICACIÓN</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px;">EQUIPO ASIGNADO</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px;">HORA DE REGISTRO</th>
                            <th style="padding: 10px 8px; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px;">CÓDIGO QR</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        registrosSilos.sort((a, b) => b.timestamp - a.timestamp).forEach((registro, index) => {
            // Usar el nuevo sistema de estados
            let estado = 'OPERATIVO';
            let colorEstado = '#10b981';
            let bgColor = '#f0fdf4';
            let borderColor = '#10b981';
            
            if (registro.estado === 'expirado') {
                estado = 'FINALIZADO';
                colorEstado = '#ef4444';
                bgColor = '#fef2f2';
                borderColor = '#ef4444';
            }

            const horaRegistro = new Date(registro.timestamp).toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const codigo = registro.lote + '-' + registro.silo;
            const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
            
            reporteHTML += `
                <tr style="background: ${rowBg}; border-left: 4px solid ${borderColor};">
                    <td style="padding: 8px; border-bottom: 1px solid #cbd5e1;">
                        <span style="background: ${bgColor}; color: ${colorEstado}; padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid ${colorEstado};">${estado}</span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #cbd5e1; font-weight: bold; color: #1f2937;">${registro.lote}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #cbd5e1; font-weight: 500;">${registro.silo}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #cbd5e1; font-weight: 500;">${registro.maquina}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #cbd5e1; font-weight: 500;">${horaRegistro}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #cbd5e1; text-align: center;">
                        <span style="background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%); color: white; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">${codigo}</span>
                    </td>
                </tr>
            `;
        });

        reporteHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-radius: 12px; border: 2px solid #cbd5e1;">
                    <h4 style="color: #1e293b; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">INSTRUCCIONES OPERATIVAS:</h4>
                    <ul style="margin: 0; padding-left: 20px; font-size: 10px; color: #475569; line-height: 1.4;">
                        <li><strong>OPERATIVO:</strong> Lote activo en proceso. Continuar con las operaciones normales.</li>
                        <li><strong>FINALIZADO:</strong> Lote completado (se cambió por otro lote). Proceder con limpieza y cierre de registro.</li>
                        <li><strong>Código QR:</strong> Utilizar para identificación rápida y trazabilidad del lote.</li>
                    </ul>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #cbd5e1; text-align: center; font-size: 9px; color: #64748b;">
                        <p style="margin: 0;"><strong>SISTEMA DE GESTIÓN INDUSTRIAL INTEGRADO v2.3.0</strong></p>
                        <p style="margin: 5px 0 0 0;">Reporte operativo generado el ${new Date().toLocaleString('es-ES')} | Turno: ${getCurrentShiftText()}</p>
                        <p style="margin: 5px 0 0 0;">Para soporte técnico contactar al supervisor de turno</p>
                    </div>
                </div>
            </div>
        `;

        const ventanaImpresion = window.open('', '_blank');
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Reporte Operativo - Personal de Planta</title>
                <style>
                    @media print {
                        body { margin: 0; }
                        .print-area { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${reporteHTML}
            </body>
            </html>
        `);
        ventanaImpresion.document.close();
        ventanaImpresion.print();
    }

    function imprimirReporteWorkersMaquinas() {
        if (registrosMaquinas.length === 0) {
            mostrarAlerta('No hay operaciones para imprimir.', 'warning');
            return;
        }

        const ahora = new Date().getTime();
        let reporteHTML = `
            <div class="print-area" style="font-family: Arial, sans-serif; padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #166534; padding-bottom: 20px;">
                    <h1 style="color: #166534; margin: 0; font-size: 24px;">PANEL DE CONTROL - OPERADORES DE MÁQUINAS</h1>
                    <h2 style="color: #16a34a; margin: 10px 0 0 0; font-size: 18px;">Reporte Operativo de Máquinas y Silos</h2>
                    <p style="color: #22c55e; margin: 5px 0 0 0; font-size: 14px;">Generado el ${new Date().toLocaleString('es-ES')} | Turno: ${getCurrentShiftText()}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #bbf7d0;">
                    <h3 style="color: #166534; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;">
                        <span style="background: #166534; color: white; padding: 8px; border-radius: 6px; margin-right: 10px; font-size: 14px;">🏭</span>
                        RESUMEN OPERATIVO
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bbf7d0;">
                            <div style="font-size: 20px; font-weight: bold; color: #059669;">${registrosMaquinas.length}</div>
                            <div style="font-size: 11px; color: #16a34a; margin-top: 3px; font-weight: 600;">OPERACIONES TOTALES</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bbf7d0;">
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;">${registrosMaquinas.filter(r => r.estado === 'activo' || !r.estado).length}</div>
                            <div style="font-size: 11px; color: #16a34a; margin-top: 3px; font-weight: 600;">OPERACIONES ACTIVAS</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bbf7d0;">
                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${registrosMaquinas.filter(r => r.estado === 'expirado').length}</div>
                            <div style="font-size: 11px; color: #16a34a; margin-top: 3px; font-weight: 600;">FINALIZADAS</div>
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px; background: white; border: 2px solid #bbf7d0; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #166534 0%, #14532d 100%); color: white;">
                            <th style="padding: 10px 6px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">ESTADO OPERATIVO</th>
                            <th style="padding: 10px 6px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">MÁQUINA ASIGNADA</th>
                            <th style="padding: 10px 6px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">UBICACIÓN SILO</th>
                            <th style="padding: 10px 6px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">OPERADOR RESPONSABLE</th>
                            <th style="padding: 10px 6px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">TURNO DE TRABAJO</th>
                            <th style="padding: 10px 6px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">MATERIAL/PRODUCTO</th>
                            <th style="padding: 10px 6px; text-align: left; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">HORA DE INICIO</th>
                            <th style="padding: 10px 6px; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 9px;">CÓDIGO QR</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        registrosMaquinas.sort((a, b) => b.timestamp - a.timestamp).forEach((registro, index) => {
            // Usar el nuevo sistema de estados
            let estado = 'OPERATIVO';
            let colorEstado = '#10b981';
            let bgColor = '#f0fdf4';
            let borderColor = '#10b981';
            
            if (registro.estado === 'expirado') {
                estado = 'FINALIZADO';
                colorEstado = '#ef4444';
                bgColor = '#fef2f2';
                borderColor = '#ef4444';
            }

            const horaRegistro = new Date(registro.timestamp).toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
            const rowBg = index % 2 === 0 ? '#ffffff' : '#f0fdf4';
            
            reporteHTML += `
                <tr style="background: ${rowBg}; border-left: 4px solid ${borderColor};">
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0;">
                        <span style="background: ${bgColor}; color: ${colorEstado}; padding: 2px 6px; border-radius: 12px; font-size: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid ${colorEstado};">${estado}</span>
                    </td>
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0; font-weight: bold; color: #1f2937;">${registro.maquina}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0; font-weight: 500;">${registro.silo}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0; font-weight: 500;">${registro.operador}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0; font-weight: 500; font-size: 9px;">${registro.turno}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0; font-weight: 500;">${registro.producto}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0; font-weight: 500;">${horaRegistro}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #bbf7d0; text-align: center;">
                        <span style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 2px 4px; border-radius: 4px; font-size: 7px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">${codigo}</span>
                    </td>
                </tr>
            `;
        });

        reporteHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #bbf7d0;">
                    <h4 style="color: #166534; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">INSTRUCCIONES OPERATIVAS:</h4>
                    <ul style="margin: 0; padding-left: 20px; font-size: 10px; color: #15803d; line-height: 1.4;">
                        <li><strong>OPERATIVO:</strong> Producto activo en máquina. Continuar con la operación asignada.</li>
                        <li><strong>FINALIZADO:</strong> Producto completado (se cambió por otro producto). Proceder con limpieza y preparación para siguiente operación.</li>
                        <li><strong>Código QR:</strong> Utilizar para identificación rápida y trazabilidad de la operación.</li>
                    </ul>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bbf7d0; text-align: center; font-size: 9px; color: #16a34a;">
                        <p style="margin: 0;"><strong>SISTEMA DE GESTIÓN INDUSTRIAL INTEGRADO v2.3.0</strong></p>
                        <p style="margin: 5px 0 0 0;">Reporte operativo generado el ${new Date().toLocaleString('es-ES')} | Turno: ${getCurrentShiftText()}</p>
                        <p style="margin: 5px 0 0 0;">Para soporte técnico contactar al supervisor de turno</p>
                    </div>
                </div>
            </div>
        `;

        const ventanaImpresion = window.open('', '_blank');
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Reporte Operativo - Operadores de Máquinas</title>
                <style>
                    @media print {
                        body { margin: 0; }
                        .print-area { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${reporteHTML}
            </body>
            </html>
        `);
        ventanaImpresion.document.close();
        ventanaImpresion.print();
    }

    function imprimirCodigoBarras() {
        const barcodeText = document.getElementById('barcodeText').textContent;
        if (!barcodeText) {
            mostrarAlerta('No hay código de barras para imprimir.', 'warning');
            return;
        }

        const printHTML = `
            <div style="text-align: center; padding: 40px; font-family: Arial, sans-serif;">
                <h2 style="margin-bottom: 30px; color: #333;">Código de Barras</h2>
                <div style="border: 2px solid #333; padding: 30px; display: inline-block; background: white;">
                    ${elements.modalBarcode.outerHTML}
                    <p style="margin-top: 15px; font-family: 'Courier New', monospace; font-size: 16px; font-weight: bold; color: #333;">${barcodeText}</p>
                </div>
                <p style="margin-top: 20px; font-size: 12px; color: #666;">
                    Generado el ${new Date().toLocaleString('es-ES')}<br>
                    Sistema de Gestión Industrial Integrado v2.3.0
                </p>
            </div>
        `;

        const ventanaImpresion = window.open('', '_blank');
        ventanaImpresion.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Código de Barras</title>
                <style>
                    @media print {
                        body { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${printHTML}
            </body>
            </html>
        `);
        ventanaImpresion.document.close();
        ventanaImpresion.print();
    }

    function descargarCodigoBarras() {
        const barcodeText = document.getElementById('barcodeText').textContent;
        if (!barcodeText || !elements.modalBarcode) {
            mostrarAlerta('No hay código de barras para descargar.', 'warning');
            return;
        }

        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const svgData = new XMLSerializer().serializeToString(elements.modalBarcode);
            const img = new Image();
            
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height + 60;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.drawImage(img, 0, 20);
                
                ctx.fillStyle = 'black';
                ctx.font = '14px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(barcodeText, canvas.width / 2, canvas.height - 20);
                
                const link = document.createElement('a');
                link.download = `codigo_barras_${barcodeText}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                mostrarAlerta('Código de barras descargado correctamente.', 'success');
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
        } catch (error) {
            console.error('Error al descargar código de barras:', error);
            mostrarAlerta('Error al descargar el código de barras.', 'error');
        }
    }

    function imprimirCodigoIndividualSilo(registro) {
        const codigo = registro.lote + '-' + registro.silo;
        
        try {
            const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            JsBarcode(tempSvg, codigo, {
                format: "CODE128",
                width: 2,
                height: 60,
                displayValue: false,
                fontSize: 14,
                margin: 15,
                background: "#ffffff",
                lineColor: "#000000"
            });

            const printHTML = `
                <div style="text-align: center; padding: 40px; font-family: Arial, sans-serif;">
                    <h2 style="margin-bottom: 20px; color: #333;">Código de Barras - Silo</h2>
                    <div style="border: 2px solid #333; padding: 30px; display: inline-block; background: white; margin-bottom: 20px;">
                        ${tempSvg.outerHTML}
                        <p style="margin-top: 15px; font-family: 'Courier New', monospace; font-size: 16px; font-weight: bold; color: #333;">${codigo}</p>
                    </div>
                    <div style="text-align: left; max-width: 400px; margin: 0 auto; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">Detalles del Registro</h3>
                        <p><strong>Lote:</strong> ${registro.lote}</p>
                        <p><strong>Silo:</strong> ${registro.silo}</p>
                        <p><strong>Máquina:</strong> ${registro.maquina}</p>
                        <p><strong>Fecha/Hora:</strong> ${registro.fecha}</p>
                    </div>
                    <p style="margin-top: 20px; font-size: 12px; color: #666;">
                        Generado el ${new Date().toLocaleString('es-ES')}<br>
                        Sistema de Gestión Industrial Integrado v2.3.0
                    </p>
                </div>
            `;

            const ventanaImpresion = window.open('', '_blank');
            ventanaImpresion.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Código de Barras - ${codigo}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printHTML}
                </body>
                </html>
            `);
            ventanaImpresion.document.close();
            ventanaImpresion.print();
        } catch (error) {
            console.error('Error al imprimir código individual:', error);
            mostrarAlerta('Error al generar el código de barras para impresión.', 'error');
        }
    }

    function imprimirCodigoIndividualMaquina(registro) {
        const codigo = registro.maquina + '-' + registro.silo + '-' + registro.operador;
        
        // Limpiar el código para que sea compatible con CODE128
        const codigoLimpio = limpiarCodigoParaQR(codigo);
        
        try {
            const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            JsBarcode(tempSvg, codigoLimpio, {
                format: "CODE128",
                width: 2,
                height: 60,
                displayValue: false,
                fontSize: 14,
                margin: 15,
                background: "#ffffff",
                lineColor: "#000000"
            });

            const printHTML = `
                <div style="text-align: center; padding: 40px; font-family: Arial, sans-serif;">
                    <h2 style="margin-bottom: 20px; color: #333;">Código de Barras - Operación</h2>
                    <div style="border: 2px solid #333; padding: 30px; display: inline-block; background: white; margin-bottom: 20px;">
                        ${tempSvg.outerHTML}
                        <p style="margin-top: 15px; font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold; color: #333;">${codigo}</p>
                    </div>
                    <div style="text-align: left; max-width: 400px; margin: 0 auto; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">Detalles de la Operación</h3>
                        <p><strong>Máquina:</strong> ${registro.maquina}</p>
                        <p><strong>Silo:</strong> ${registro.silo}</p>
                        <p><strong>Operador:</strong> ${registro.operador}</p>
                        <p><strong>Turno:</strong> ${registro.turno}</p>
                        <p><strong>Producto:</strong> ${registro.producto}</p>
                        <p><strong>Fecha/Hora:</strong> ${registro.fecha}</p>
                    </div>
                    <p style="margin-top: 20px; font-size: 12px; color: #666;">
                        Generado el ${new Date().toLocaleString('es-ES')}<br>
                        Sistema de Gestión Industrial Integrado v2.3.0
                    </p>
                </div>
            `;

            const ventanaImpresion = window.open('', '_blank');
            ventanaImpresion.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Código de Barras - ${codigo}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printHTML}
                </body>
                </html>
            `);
            ventanaImpresion.document.close();
            ventanaImpresion.print();
        } catch (error) {
            console.error('Error al imprimir código individual:', error);
            mostrarAlerta('Error al generar el código de barras para impresión.', 'error');
        }
    }

    function mostrarAlerta(mensaje, tipo = 'info') {
        const alertaExistente = document.querySelector('.custom-alert');
        if (alertaExistente) {
            alertaExistente.remove();
        }

        const colores = {
            success: 'bg-green-100 border-green-400 text-green-700',
            error: 'bg-red-100 border-red-400 text-red-700',
            warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
            info: 'bg-blue-100 border-blue-400 text-blue-700'
        };

        const iconos = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-triangle',
            warning: 'fas fa-exclamation-circle',
            info: 'fas fa-info-circle'
        };

        const alerta = document.createElement('div');
        alerta.className = `custom-alert fixed top-4 right-4 z-50 p-4 border-l-4 rounded-lg shadow-lg max-w-md ${colores[tipo]}`;
        alerta.innerHTML = `
            <div class="flex items-center">
                <i class="${iconos[tipo]} mr-3 text-lg"></i>
                <div class="flex-1">
                    <p class="font-medium">${mensaje}</p>
                </div>
                <button class="ml-4 text-lg hover:opacity-70" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(alerta);

        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.classList.add('fade-out');
                setTimeout(() => {
                    if (alerta.parentNode) {
                        alerta.remove();
                    }
                }, 300);
            }
        }, 5000);
    }

    function mostrarConfirmacion(titulo, mensaje, callback) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="bg-red-100 p-3 rounded-full mr-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">${titulo}</h3>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-6">${mensaje}</p>
                    <div class="flex flex-col sm:flex-row gap-3 justify-end">
                        <button id="cancelar" class="btn-secondary text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                            <i class="fas fa-times mr-2"></i> Cancelar
                        </button>
                        <button id="confirmar" class="btn-danger text-white py-3 px-6 rounded-lg font-medium transition-all duration-200 inline-flex items-center justify-center">
                            <i class="fas fa-check mr-2"></i> Confirmarlo
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        modal.querySelector('#cancelar').addEventListener('click', function() {
            modal.remove()
        });

        modal.querySelector('#confirmar').addEventListener('click', function() {
            modal.remove();
            if (callback) callback();
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function updateCurrentTime() {
        if (elements.currentTimeEl) {
            const now = new Date();
            elements.currentTimeEl.textContent = now.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }

    function updateCurrentShift() {
        const shiftText = getCurrentShiftText();
        if (elements.currentShiftEl) {
            elements.currentShiftEl.textContent = shiftText;
        }
        if (elements.currentShiftMaquinasEl) {
            elements.currentShiftMaquinasEl.textContent = shiftText;
        }
    }

    function getCurrentShiftText() {
        const now = new Date();
        const hour = now.getHours();  
        if (hour >= 6 && hour < 14) {
            return 'Mañana';
        } else if (hour >= 14 && hour < 22) {
            return 'Tarde';
        } else {
            return 'Noche';
        }
    }
    // Manejo de errores de promesas no capturadas
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Promesa rechazada no manejada:', e.reason);
        mostrarAlerta('Error de conexión. Verifique su conexión a internet.', 'error');
    
    });

    // Cleanup al cerrar la página
    window.addEventListener('beforeunload', function() {
        if (intervalLimpiezaSilos) {
            clearInterval(intervalLimpiezaSilos);
        }    if (intervalLimpiezaMaquinas) {
            clearInterval(intervalLimpiezaMaquinas);
        }
    });

    console.log('Sistema de Gestión Industrial Integrado v2.3.0 cargado correctamente');
    
    // Variables globales para el login
    let selectedUser = null;
    let currentUser = null;
    let loginInitialized = false; // Prevenir inicialización múltiple
    let mainSystemInitialized = false; // Prevenir inicialización múltiple del sistema principal

    // Función para verificar permisos de usuario
    function isAdmin() {
        return currentUser && currentUser.type === 'administrador' && currentUser.authenticated === true;
    }

    function isWorker() {
        return currentUser && currentUser.type === 'trabajador';
    }

    function hasPermission(action) {
        if (!currentUser) return false;
        
        switch (action) {
            case 'view_expired':
            case 'delete_expired':
            case 'manage_system':
            case 'export_all':
            case 'delete_records':
                return isAdmin();
            case 'register_records':
            case 'view_active':
                return true; // Tanto admin como trabajador
            default:
                return false;
        }
    }

    // Función para aplicar permisos UI
    function applyUserPermissions() {
        if (!currentUser) return;
        
        console.log('[PERMISOS] Aplicando permisos para:', currentUser.type);
        
        // Elementos solo para administradores (botones y controles, NO paneles)
        const adminOnlyElements = [
            elements.showExpiredSilos,
            elements.showExpiredMaquinas,
            elements.deleteAllExpiredSilos,
            elements.deleteAllExpiredMaquinas,
            elements.clearStorageSilos,
            elements.clearStorageMaquinas
        ];
        
        adminOnlyElements.forEach(element => {
            if (element) {
                if (isAdmin()) {
                    element.style.display = '';
                    element.style.visibility = 'visible';
                } else {
                    element.style.display = 'none';
                    element.style.visibility = 'hidden';
                }
            }
        });
        
        // Los paneles de expirados siempre deben estar ocultos por defecto
        // Solo se muestran cuando el admin presiona "Mostrar Expirados"
        if (elements.expiredPanelSilos) {
            elements.expiredPanelSilos.style.display = 'none';
        }
        if (elements.expiredPanelMaquinas) {
            elements.expiredPanelMaquinas.style.display = 'none';
        }
        
        // Restricciones completas para trabajadores (solo registro de silos)
        if (isWorker()) {
            // Ocultar pestaña principal de máquinas para trabajadores
            const tabMaquinasSilos = document.getElementById('tab-maquinas-silos');
            if (tabMaquinasSilos) {
                tabMaquinasSilos.style.display = 'none';
            }
            
            // Ocultar sub-navegación de panel para trabajadores
            const subTabSilosPanel = document.getElementById('sub-tab-silos-panel');
            const subTabMaquinasPanel = document.getElementById('sub-tab-maquinas-panel');
            
            if (subTabSilosPanel) {
                subTabSilosPanel.style.display = 'none';
            }
            if (subTabMaquinasPanel) {
                subTabMaquinasPanel.style.display = 'none';
            }
            
            // Forzar a los trabajadores solo a vista de silos y solo formulario
            currentView = 'silos-lotes';
            currentSubViewSilos = 'form';
            showMainView('silos-lotes');
            showSubViewSilos('form');
            
            // Cambiar el título de la página para trabajadores
            const pageTitle = document.querySelector('title');
            if (pageTitle) {
                pageTitle.textContent = 'Sistema de Registro de Lotes - Trabajador';
            }
            
            // Ocultar navegación principal de vista trabajadores para evitar confusión
            const workerTabs = document.querySelectorAll('#tab-silos-workers, #tab-maquinas-workers');
            workerTabs.forEach(tab => {
                if (tab) tab.style.display = 'none';
            });
        } else if (isAdmin()) {
            // Mostrar todos los elementos para administradores
            const tabMaquinasSilos = document.getElementById('tab-maquinas-silos');
            if (tabMaquinasSilos) {
                tabMaquinasSilos.style.display = '';
            }
            
            const subTabSilosPanel = document.getElementById('sub-tab-silos-panel');
            const subTabMaquinasPanel = document.getElementById('sub-tab-maquinas-panel');
            
            if (subTabSilosPanel) {
                subTabSilosPanel.style.display = '';
            }
            if (subTabMaquinasPanel) {
                subTabMaquinasPanel.style.display = '';
            }
            
            // Mostrar navegación completa para administradores
            const workerTabs = document.querySelectorAll('#tab-silos-workers, #tab-maquinas-workers');
            workerTabs.forEach(tab => {
                if (tab) tab.style.display = '';
            });
            
            // Título completo para administradores
            const pageTitle = document.querySelector('title');
            if (pageTitle) {
                pageTitle.textContent = 'Sistema de Gestión Industrial Integrado - Administrador';
            }
        }
        
        console.log('[PERMISOS] Permisos aplicados correctamente');
    }

    // Función de depuración para mostrar el estado del localStorage
    function debugLocalStorage() {
        console.log('=== DEPURACIÓN LOCALSTORAGE ===');
        console.log('Número total de elementos:', localStorage.length);
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            console.log(`${key}:`, value);
        }
        
        const currentUserData = localStorage.getItem('currentUser');
        if (currentUserData) {
            console.log('🚨 USUARIO ENCONTRADO EN LOCALSTORAGE:');
            try {
                const user = JSON.parse(currentUserData);
                console.log('- Tipo:', user.type);
                console.log('- Nombre:', user.name);
                console.log('- Login Time:', user.loginTime);
                console.log('- Tiempo transcurrido (horas):', user.loginTime ? (new Date() - new Date(user.loginTime)) / (1000 * 60 * 60) : 'No disponible');
            } catch (e) {
                console.log('- ERROR AL PARSEAR:', e);
            }
        } else {
            console.log('✅ No hay usuario guardado en localStorage');
        }
        console.log('================================');
    }

    // Función para limpiar todos los event listeners duplicados
    function cleanupEventListeners() {
        // Clonar elementos para eliminar todos los event listeners
        const elementsToClean = [
            'loginBtn', 'clearDataBtn', 'logoutBtn'
        ];
        
        elementsToClean.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
            }
        });
        
        // Limpiar event listeners de las opciones de usuario
        const userOptions = document.querySelectorAll('.user-option');
        userOptions.forEach(option => {
            const newOption = option.cloneNode(true);
            option.parentNode.replaceChild(newOption, option);
        });
    }

    // Inicializar el sistema de login
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[INIT] Iniciando aplicación...');
        
        // Mostrar información de depuración
        debugLocalStorage();
        
        // Limpiar event listeners duplicados
        cleanupEventListeners();
        
        // Reset de variables de estado
        loginInitialized = false;
        mainSystemInitialized = false;
        
        // Verificar si hay sesión guardada antes de mostrar login
        checkSavedSession();
    });

    function loadMainSystemDirectly() {
        console.log('[LOGIN] Cargando sistema principal directamente...');
        
        // Verificar que los elementos existen
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        const userIconEl = document.getElementById('userIcon');
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        
        if (!userNameEl || !userRoleEl || !userIconEl) {
            console.error('[LOGIN] Elementos de usuario no encontrados, reiniciando...');
            localStorage.removeItem('currentUser');
            location.reload();
            return;
        }
        
        // Actualizar información del usuario en el header
        userNameEl.textContent = currentUser.name;
        userRoleEl.textContent = currentUser.role;
        userIconEl.className = `fas ${currentUser.icon}`;

        // Ocultar login y mostrar sistema principal sin animación
        if (loginScreen) loginScreen.style.display = 'none';
        if (mainSystem) {
            mainSystem.classList.add('active');
            mainSystem.style.display = 'block';
        }

        // Inicializar el sistema principal solo una vez
        if (!mainSystemInitialized) {
            initializeMainSystem();
            mainSystemInitialized = true;
        }

        // Configurar el botón de logout
        setupLogoutButton();

        // Aplicar permisos específicos del usuario
        applyUserPermissions();

        console.log('[LOGIN] Sesión restaurada automáticamente para:', currentUser.name);
    }

    function checkSavedSession() {
        const savedUser = localStorage.getItem('currentUser');
        console.log('[LOGIN] Verificando sesión guardada...', savedUser ? 'Encontrada' : 'No encontrada');
        
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                console.log('[LOGIN] Datos de usuario encontrados:', currentUser);
                
                // Verificar que los datos son válidos
                if (currentUser.type && currentUser.name && currentUser.loginTime) {
                    // Verificar si la sesión no ha expirado (24 horas)
                    const loginTime = new Date(currentUser.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        console.log('[LOGIN] Sesión válida, cargando sistema principal...');
                        // Cargar directamente el sistema principal
                        loadMainSystemDirectly();
                        return;
                    } else {
                        console.log('[LOGIN] Sesión expirada, limpiando datos...');
                        localStorage.removeItem('currentUser');
                    }
                } else {
                    console.log('[LOGIN] Datos de usuario incompletos, limpiando...');
                    localStorage.removeItem('currentUser');
                }
            } catch (error) {
                console.error('[LOGIN] Error al parsear datos guardados:', error);
                // Si hay error al parsear, limpiar localStorage y mostrar login
                localStorage.removeItem('currentUser');
            }
        }
        
        console.log('[LOGIN] Mostrando pantalla de login...');
        // No hay sesión guardada válida, mostrar login
        initializeLogin();
    }

    function initializeLogin() {
        if (loginInitialized) {
            console.log('[LOGIN] Login ya inicializado, saltando...');
            return;
        }
        
        console.log('[LOGIN] Inicializando pantalla de login...');
        
        const userOptions = document.querySelectorAll('.user-option');
        const loginBtn = document.getElementById('loginBtn');
        const loginLoading = document.getElementById('loginLoading');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');

        // Asegurar que la pantalla de login esté visible
        if (loginScreen) loginScreen.style.display = 'flex';
        if (mainSystem) {
            mainSystem.classList.remove('active');
            mainSystem.style.display = 'none';
        }

        // Reset del estado del login
        selectedUser = null;
        if (loginBtn) {
            loginBtn.classList.remove('active');
            loginBtn.style.display = 'block';
        }
        if (loginLoading) loginLoading.style.display = 'none';

        // Manejar selección de usuario
        userOptions.forEach(option => {
            option.addEventListener('click', function() {
                console.log('[LOGIN] Opción de usuario clickeada');
                
                // Remover selección anterior
                userOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Seleccionar nuevo usuario
                this.classList.add('selected');
                selectedUser = this.getAttribute('data-user');
                console.log('[LOGIN] Usuario seleccionado:', selectedUser);
                
                // Activar botón de login
                if (loginBtn) loginBtn.classList.add('active');
            }, { once: false }); // Permitir múltiples clicks
        });

        // Manejar login
        if (loginBtn) {
            loginBtn.addEventListener('click', function() {
                if (!selectedUser) {
                    console.log('[LOGIN] No hay usuario seleccionado');
                    return;
                }
                
                // Si es administrador, pedir contraseña
                if (selectedUser === 'administrador') {
                    const password = prompt('🔐 Acceso de Administrador\n\nPor favor, introduce la contraseña de administrador:');
                    
                    if (password === null) {
                        console.log('[LOGIN] Login cancelado por el usuario');
                        return;
                    }
                    
                    if (password !== 'kira2025') {
                        alert('❌ Contraseña incorrecta. Acceso denegado.');
                        console.warn('[SECURITY] Intento de acceso fallido a cuenta de administrador');
                        console.log('[LOGIN] Contraseña incorrecta para administrador');
                        return;
                    }
                    
                    console.log('[LOGIN] Contraseña de administrador correcta');
                }
                
                console.log('[LOGIN] Iniciando proceso de login para:', selectedUser);

                // Mostrar loading
                loginBtn.style.display = 'none';
                if (loginLoading) loginLoading.style.display = 'flex';

                // Simular proceso de login
                setTimeout(() => {
                    performLogin(selectedUser);
                }, 1500);
            }, { once: true }); // Solo un click
        }

        // Manejar botón de limpiar datos
        if (clearDataBtn) {
            clearDataBtn.addEventListener('click', function() {
                console.log('[LOGIN] Limpiando todos los datos del localStorage...');
                
                // Mostrar confirmación antes de limpiar
                if (confirm('¿Estás seguro de que quieres limpiar todos los datos guardados?\n\nEsto cerrará tu sesión y eliminará todas las preferencias.')) {
                    // Limpiar todo el localStorage relacionado con la aplicación
                    localStorage.clear();
                    
                    // Mostrar mensaje de confirmación
                    alert('✅ Todos los datos han sido limpiados.\n\nLa página se recargará automáticamente.');
                    
                    // Recargar la página para un estado completamente limpio
                    location.reload();
                }
            }, { once: false }); // Permitir múltiples clicks
        }

        loginInitialized = true;
        console.log('[LOGIN] Pantalla de login inicializada correctamente');
    }

    function setupLogoutButton() {
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            // Limpiar event listeners previos clonando el elemento
            const newLogoutBtn = logoutBtn.cloneNode(true);
            logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
            
            // Añadir nuevo event listener
            newLogoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('[LOGIN] Botón logout clickeado');
                
                if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                    performLogout();
                }
            }, { once: false });
            
            console.log('[LOGIN] Botón de logout configurado correctamente');
        } else {
            console.warn('[LOGIN] Botón de logout no encontrado');
        }
    }

    function performLogin(userType) {
        console.log('[LOGIN] Ejecutando login para:', userType);
        
        // Mensaje especial para administrador autenticado
        if (userType === 'administrador') {
            console.log('[SECURITY] Acceso de administrador autorizado con contraseña');
        }
        
        currentUser = {
            type: userType,
            name: userType === 'administrador' ? 'Administrador' : 'Trabajador',
            role: userType === 'administrador' ? 'Administrador del Sistema' : 'Operador de Planta',
            icon: userType === 'administrador' ? 'fa-user-shield' : 'fa-hard-hat',
            loginTime: new Date().toISOString(), // Agregar timestamp del login
            authenticated: userType === 'administrador' ? true : false // Flag de autenticación
        };

        // Guardar sesión en localStorage
        try {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('[LOGIN] Sesión guardada en localStorage');
        } catch (error) {
            console.error('[LOGIN] Error al guardar en localStorage:', error);
        }

        // Verificar que los elementos existen antes de actualizar
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        const userIconEl = document.getElementById('userIcon');
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        
        if (userNameEl && userRoleEl && userIconEl) {
            // Actualizar información del usuario en el header
            userNameEl.textContent = currentUser.name;
            userRoleEl.textContent = currentUser.role;
            userIconEl.className = `fas ${currentUser.icon}`;
        }

        // Ocultar login y mostrar sistema principal
        if (loginScreen) loginScreen.style.display = 'none';
        if (mainSystem) {
            mainSystem.classList.add('active');
            mainSystem.style.display = 'block';
        }

        // Configurar el botón de logout
        setupLogoutButton();

        // Inicializar el sistema principal solo una vez
        if (!mainSystemInitialized) {
            initializeMainSystem();
            mainSystemInitialized = true;
        }

        // Aplicar permisos específicos del usuario
        applyUserPermissions();

        // Mostrar mensaje de bienvenida
        setTimeout(() => {
            if (typeof mostrarAlerta === 'function') {
                if (isAdmin()) {
                    mostrarAlerta(`🔐 ¡Acceso autorizado, ${currentUser.name}! Tienes control completo del sistema.`, 'success');
                } else if (isWorker()) {
                    mostrarAlerta(`¡Bienvenido, ${currentUser.name}! Puedes registrar nuevos lotes desde aquí.`, 'success');
                } else {
                    mostrarAlerta(`¡Bienvenido, ${currentUser.name}!`, 'success');
                }
            }
        }, 500);

        console.log('[LOGIN] Login completado para:', currentUser.name);
    }

    function performLogout() {
        console.log('[LOGIN] Ejecutando logout...');
        
        // Limpiar localStorage al hacer logout
        try {
            localStorage.removeItem('currentUser');
            console.log('[LOGIN] Usuario removido del localStorage');
        } catch (error) {
            console.error('[LOGIN] Error al limpiar localStorage:', error);
        }
        
        // Limpiar datos del usuario
        currentUser = null;
        selectedUser = null;
        
        // Reset de las variables de estado
        loginInitialized = false;
        mainSystemInitialized = false;

        // Obtener elementos
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        const loginBtn = document.getElementById('loginBtn');
        const loginLoading = document.getElementById('loginLoading');
        
        // Resetear interfaz de login
        document.querySelectorAll('.user-option').forEach(opt => opt.classList.remove('selected'));
        
        if (loginBtn) {
            loginBtn.classList.remove('active');
            loginBtn.style.display = 'block';
        }
        
        if (loginLoading) {
            loginLoading.style.display = 'none';
        }

        // Mostrar login y ocultar sistema principal
        if (mainSystem) {
            mainSystem.classList.remove('active');
            mainSystem.style.display = 'none';
        }
        
        if (loginScreen) {
            loginScreen.style.display = 'flex';
        }

        // Reinicializar el sistema de login
        setTimeout(() => {
            initializeLogin();
        }, 100);

        // Mostrar mensaje
        if (typeof mostrarAlerta === 'function') {
            mostrarAlerta('Sesión cerrada correctamente', 'info');
        }
        
        console.log('[LOGIN] Logout completado, localStorage limpiado');
    }

    // Función opcional para limpiar sesiones expiradas (24 horas)
    function checkSessionExpiry() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                const user = JSON.parse(savedUser);
                const loginTime = new Date(user.loginTime);
                const now = new Date();
                const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                
                // Si han pasado más de 24 horas, cerrar sesión automáticamente
                if (hoursDiff > 24) {
                    localStorage.removeItem('currentUser');
                    location.reload(); // Recargar para mostrar login
                }
            } catch (error) {
                localStorage.removeItem('currentUser');
            }
        }
    }

    // Verificar expiración cada hora
    setInterval(checkSessionExpiry, 3600000); // 1 hora en milisegundos

    // Función para manejar errores globales
    window.addEventListener('error', function(e) {
        console.error('[ERROR GLOBAL]', e.error);
        
        // Si hay errores críticos relacionados con el login, limpiar y recargar
        if (e.error && e.error.message && e.error.message.includes('currentUser')) {
            console.log('[ERROR] Error relacionado con usuario, limpiando localStorage...');
            localStorage.removeItem('currentUser');
            location.reload();
        }
    });

    // Prevenir múltiples recargas
    let reloadInProgress = false;
    
    // Función para recargar de forma segura
    function safeReload() {
        if (!reloadInProgress) {
            reloadInProgress = true;
            console.log('[SYSTEM] Recargando aplicación de forma segura...');
            setTimeout(() => {
                location.reload();
            }, 100);
        }
    }

    // Verificar integridad del DOM cada 5 segundos cuando esté logueado
    setInterval(() => {
        if (currentUser && mainSystemInitialized) {
            const criticalElements = [
                'userName', 'userRole', 'userIcon', 'logoutBtn', 
                'loginScreen', 'mainSystem'
            ];
            
            let missingElements = [];
            criticalElements.forEach(id => {
                if (!document.getElementById(id)) {
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length > 0) {
                console.warn('[INTEGRITY] Elementos críticos faltantes:', missingElements);
                // No recargar automáticamente, solo logear para depuración
            }
        }
    }, 5000);

    function initializeMainSystem() {
        if (mainSystemInitialized) {
            console.log('[MAIN] Sistema principal ya inicializado, saltando...');
            return;
        }
        
        console.log('[MAIN] Inicializando sistema principal v2.3.0...');
        
        try {
            // Verificar que las funciones existen antes de llamarlas
            if (typeof initializeElements === 'function') initializeElements();
            if (typeof initializeTheme === 'function') initializeTheme();
            if (typeof setupNavigation === 'function') setupNavigation();
            if (typeof setupSubNavigation === 'function') setupSubNavigation();
            if (typeof cargarRegistrosSilos === 'function') cargarRegistrosSilos();
            if (typeof cargarRegistrosMaquinas === 'function') cargarRegistrosMaquinas();
            if (typeof setupRealtimeSync === 'function') setupRealtimeSync();
            if (typeof actualizarTablaSilos === 'function') actualizarTablaSilos();
            if (typeof actualizarTablaMaquinas === 'function') actualizarTablaMaquinas();
            if (typeof actualizarEstadisticasSilos === 'function') actualizarEstadisticasSilos();
            if (typeof actualizarEstadisticasMaquinas === 'function') actualizarEstadisticasMaquinas();
            if (typeof setupEventListeners === 'function') setupEventListeners();
            if (typeof updateCurrentTime === 'function') {
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
            }
            if (typeof updateCurrentShift === 'function') {
                updateCurrentShift();
                setInterval(updateCurrentShift, 60000);
            }
            
            mainSystemInitialized = true;
            console.log('[MAIN] Sistema principal inicializado correctamente');
            
        } catch (error) {
            console.error('[MAIN] Error al inicializar sistema principal:', error);
        }
    }
</script>

</div> <!-- Cierre del mainSystem -->

</body>
</html>
